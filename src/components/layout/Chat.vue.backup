<template>
  <div class="card layout-chat layout-menu chat-component" :style="{ width: chatWidth + 'px' }">
    <div class="resize-handle" @mousedown="startResize"></div>
    <div class="tabview-container">
      <div class="expand-button-container">
        <Button icon="pi pi-times" @click="closeChat" class="close-button p-button-text p-button-secondary"
                title="–°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç" data-testid="close-chat-button" data-action="close-chat" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç" />
        <Button icon="pi pi-plus-circle" @click="createNewChatSession" class="p-button-text p-button-success"
                title="–ù–æ–≤—ã–π —á–∞—Ç" data-testid="new-chat-button" data-action="new-chat" aria-label="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç" />
        <Button icon="pi pi-history" @click="showHistory = true" class="p-button-text" title="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤"
                data-testid="history-button" data-action="open-history" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤" />
        <Button icon="pi pi-window-maximize" @click="showModal" class="expand-button p-button-text"
                title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç" data-testid="expand-chat-button" data-action="expand-chat" aria-label="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç" />
      </div>

      <TabView v-model:activeIndex="activeTabIndex">
        <TabPanel>
          <template #header>
            <span title="–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç">
              <i class="pi pi-prime" />
            </span>
          </template>

          <div class="chat-container" data-testid="ai-chat-container">
            <div class="messages" ref="aiMessagesContainer" data-testid="messages-container">
              <div v-for="(msg, index) in aiChat.messages" :key="index" class="message"
                :class="{ 'user-message': msg.isUser }" data-testid="message-item" :data-message-id="index">
                <div class="message-content" v-if="!isSystemMessage(msg)">
                  <div v-if="msg.attachments && msg.attachments.length > 0" class="attachment-info">
                    <div v-for="(attachment, attIndex) in msg.attachments" :key="attIndex" class="attachment-item">
                      <img v-if="isImage(attachment)" :src="attachment.url" class="image-preview" 
                           @click="showImagePreview(attachment.url)" />
                      <i v-else :class="getAttachmentIcon(attachment)" class="attachment-icon" />
                      <span class="attachment-name">{{ getAttachmentDisplayName(attachment) }}</span>
                      <span v-if="attachment.source === 'file'" class="file-size">({{ formatFileSize(attachment.size) }})</span>
                      <Button v-if="attachment.source === 'file'" icon="pi pi-download" class="p-button-text p-button-sm download-btn"
                        @click="downloadAttachment(attachment)" />
                    </div>
                  </div>
                  
                  <div class="message-text">
                    <MarkdownRender :content="msg.text" />
                    <span v-if="aiLoading && msg === assistantMessage" class="streaming-cursor"></span>
                  </div>
                  <div class="message-actions">
                    <div class="message-time">{{ msg.time }}</div>
                    <div class="action-buttons">
                      <Button v-if="!msg.isUser && isEditorPage" icon="pi pi-arrow-left" title="–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä"
                        class="transfer-button p-button-text p-button-sm" @click="transferToEditor(msg.text)"
                        data-testid="transfer-to-editor-button" aria-label="–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä" />
                      <Button v-if="!msg.isUser" icon="pi pi-copy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                        class="copy-button p-button-text p-button-sm" @click="copyToClipboard(msg.text)"
                        data-testid="copy-message-button" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" />
                      <Button icon="pi pi-refresh" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞"
                        class="resend-button p-button-text p-button-sm" @click="resendMessage(index)"
                        data-testid="resend-message-button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–Ω–æ–≤–∞" />
                      <Button icon="pi pi-pencil" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                        class="edit-button p-button-text p-button-sm" @click="editMessage(index)"
                        data-testid="edit-message-button" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" />
                      <Button icon="pi pi-trash" title="–£–¥–∞–ª–∏—Ç—å"
                        class="delete-button p-button-text p-button-sm p-button-danger" @click="deleteMessage(index)"
                        data-testid="delete-message-button" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" />
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="aiLoading && !assistantMessage" class="loading-indicator">
                <ProgressSpinner style="width: 30px; height: 30px" />
              </div>

              <div v-if="aiError" class="error-message">
                {{ aiError }}
              </div>
            </div>

            <div class="input-container">
              <InputText v-model="aiMessage" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ò–ò..." @keyup.enter="sendAiMessage"
                class="input-field" :disabled="aiLoading" data-testid="message-input" aria-label="–ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è" />

            </div>
            <div><Button icon="pi pi-microphone" @click="toggleVoiceInput"
                      :class="['p-button-text', 'voice-btn', { 'recording': isRecording }]"
                      title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥" data-testid="voice-input-button" aria-label="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥" />              <input type="file" ref="fileInput" style="display: none" @change="handleFileUpload"
                     accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.json,.csv,image/*" multiple data-testid="file-input" />

              <span style="float: right;">
                              <Button icon="pi pi-paperclip" @click="attachmentMenu.toggle($event)" class="p-button-text attachment-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"
                              data-testid="attach-file-button" aria-label="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" />
              <Popover ref="attachmentMenu">
                <div class="attachment-menu">
                  <Button label="–° —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" icon="pi pi-upload" @click="triggerFileUpload(); attachmentMenu.hide()" class="p-button-text w-full justify-start"
                          data-testid="upload-from-device-button" />
                  <Button label="–¢–∞–±–ª–∏—Ü—ã/–æ—Ç—á—ë—Ç—ã" icon="pi pi-database" @click="showDataSelector = true; attachmentMenu.hide()" class="p-button-text w-full justify-start"
                          data-testid="attach-data-button" />
                </div>
              </Popover><Button icon="pi pi-send" @click="sendAiMessage" severity="help" :disabled="aiLoading" class="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
                                data-testid="send-message-button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"/></span></div>
            <div v-if="uploadProgress > 0" class="upload-progress">
              <ProgressBar :value="uploadProgress" :showValue="false" />
              <span>–ó–∞–≥—Ä—É–∑–∫–∞: {{ uploadProgress }}%</span>
            </div>
            
            <div v-if="currentAttachments.length > 0" class="current-attachments">
              <div v-for="(attachment, index) in currentAttachments" :key="index" class="current-attachment">
                <div class="attachment-info current">
                  <img v-if="isImage(attachment)" :src="attachment.url" class="image-preview-small" />
                  <i v-else :class="getAttachmentIcon(attachment)" class="attachment-icon" />
                  <span class="attachment-name">{{ getAttachmentDisplayName(attachment) }}</span>
                  <span v-if="attachment.source === 'file'" class="file-size">({{ formatFileSize(attachment.size) }})</span>
                  <Button icon="pi pi-times" class="p-button-text p-button-sm p-button-danger remove-btn"
                    @click="removeCurrentAttachment(index)" />
                </div>
              </div>
            </div>
          </div>
        </TabPanel>

        <TabPanel title="–û–±—â–∏–π —á–∞—Ç">
          <template #header>
            <span title="–û–±—â–∏–π —á–∞—Ç">
              <i class="pi pi-users" />
            </span>
          </template>
          <div class="chat-container">
            <div class="messages" ref="messagesContainer">
              <div v-for="(msg, index) in activeChat.messages" :key="index" class="message"
                :class="{ 'user-message': msg.isUser }">
                <Avatar v-if="!msg.isUser" icon="pi pi-user" shape="circle" />
                <div class="message-content">
                  <div v-if="msg.attachment || (msg.attachments && msg.attachments.length > 0)" class="attachment-info">
                    <template v-if="msg.attachment">
                      <img v-if="isImage(msg.attachment)" :src="msg.attachment.url" class="image-preview" 
                           @click="showImagePreview(msg.attachment.url)" />
                      <i v-else :class="getAttachmentIcon(msg.attachment)" class="attachment-icon" />
                      <span class="attachment-name">{{ getAttachmentDisplayName(msg.attachment) }}</span>
                      <span v-if="msg.attachment.source === 'file'" class="file-size">({{ formatFileSize(msg.attachment.size) }})</span>
                      <Button v-if="msg.attachment.source === 'file'" icon="pi pi-download" class="p-button-text p-button-sm download-btn"
                        @click="downloadAttachment(msg.attachment)" />
                    </template>
                    <template v-else-if="msg.attachments && msg.attachments.length > 0">
                      <div v-for="(attachment, attIndex) in msg.attachments" :key="attIndex" class="attachment-item">
                        <img v-if="isImage(attachment)" :src="attachment.url" class="image-preview" 
                             @click="showImagePreview(attachment.url)" />
                        <i v-else :class="getAttachmentIcon(attachment)" class="attachment-icon" />
                        <span class="attachment-name">{{ getAttachmentDisplayName(attachment) }}</span>
                        <span v-if="attachment.source === 'file'" class="file-size">({{ formatFileSize(attachment.size) }})</span>
                        <Button v-if="attachment.source === 'file'" icon="pi pi-download" class="p-button-text p-button-sm download-btn"
                          @click="downloadAttachment(attachment)" />
                      </div>
                    </template>
                  </div>
                  
                  <div class="message-text">{{ msg.text }}</div>
                  <div class="message-time">{{ msg.time }}</div>
                </div>
                <Avatar v-if="msg.isUser" icon="pi pi-user" shape="circle" />
              </div>
            </div>
            <div class="input-container">
              <InputText v-model="newMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." @keyup.enter="sendMessage"
                class="input-field" />
              <input type="file" ref="fileInputGeneral" style="display: none" @change="handleFileUploadGeneral" 
                     accept="*" multiple />
              <Button icon="pi pi-paperclip" @click="attachmentMenuGeneral.toggle($event)" class="p-button-text attachment-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" />
              <Popover ref="attachmentMenuGeneral">
                <div class="attachment-menu">
                  <Button label="–° —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" icon="pi pi-upload" @click="triggerFileUploadGeneral(); attachmentMenuGeneral.hide()" class="p-button-text w-full justify-start" />
                  <Button label="–¢–∞–±–ª–∏—Ü—ã/–æ—Ç—á—ë—Ç—ã" icon="pi pi-database" @click="showDataSelector = true; attachmentMenuGeneral.hide()" class="p-button-text w-full justify-start" />
                </div>
              </Popover>
              <Button icon="pi pi-send" @click="sendMessage" severity="info" class="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"/>
            </div>
          </div>
        </TabPanel>

        <TabPanel>
          <template #header>
            <span title="Polza.ai –ê–≥–µ–Ω—Ç—ã">
              <i class="pi pi-robot" />
            </span>
          </template>
          <div class="chat-container">
            <div class="polza-agents-info">
              <h3>ü§ñ Polza.ai –ê–≥–µ–Ω—Ç—ã</h3>
              <p>–î–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –∞–≥–µ–Ω—Ç–æ–≤:</p>
              <ul>
                <li><strong>–ê–Ω–∞–ª–∏—Ç–∏–∫</strong> - –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</li>
                <li><strong>–†–µ–ø–æ—Ä—Ç–µ—Ä</strong> - —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏</li>
                <li><strong>–í–∞–ª–∏–¥–∞—Ç–æ—Ä</strong> - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</li>
                <li><strong>–ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä</strong> - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏</li>
                <li><strong>–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π</strong> - –æ–±—â–∏–µ –∑–∞–¥–∞—á–∏ –∏ –ø–æ–º–æ—â—å</li>
              </ul>
              <p><em>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–≥–µ–Ω—Ç–∞–º–∏.</em></p>
            </div>
          </div>
        </TabPanel>
      </TabView>
    </div>

    <Dialog v-model:visible="isModalVisible" modal :closable="true"
      :style="{ width: '100vw', height: '100vh', maxWidth: '100vw', maxHeight: '100vh' }" :contentStyle="{
        padding: '0',
        display: 'flex',
        flexDirection: 'column',
        height: '100%',
      }" :modal="true" @hide="hideModal" :dismissableMask="false">
      <template #header>
        <div class="flex align-items-center gap-2"><span class="font-bold white-space-nowrap">
          <i :class="activeTabIndex === 0 ? 'pi pi-prime' : 'pi pi-users'" />
            {{ activeTabIndex === 0 ? '–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç' : '–û–±—â–∏–π —á–∞—Ç' }}
          <Button icon="pi pi-trash" @click="clearCurrentChat" class="p-button-text p-button-danger ml-auto"
                  title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç" />
          <Button icon="pi pi-times" @click="hideModal" class="p-button-text p-button-sm"
                  title="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —á–∞—Ç–∞" style="margin-left: 0.5rem;" /></span>
        </div>
      </template>

      <div class="modal-chat-container">
        <div class="modal-messages" ref="modalMessagesContainer">
          <div v-for="(msg, index) in activeTabIndex === 0
            ? aiChat.messages
            : activeChat.messages" :key="index" class="modal-message" :class="{ 'modal-user-message': msg.isUser }">
            <Avatar v-if="!msg.isUser" :icon="activeTabIndex === 0 ? 'pi pi-prime' : 'pi pi-user'" shape="circle"
              size="normal" class="mr-2" />
            <div class="modal-message-content" v-if="!isSystemMessage(msg)">
              <div v-if="msg.attachment || (msg.attachments && msg.attachments.length > 0)" class="modal-attachment-info">
                <template v-if="msg.attachment">
                  <img v-if="isImage(msg.attachment)" :src="msg.attachment.url" class="image-preview" 
                       @click="showImagePreview(msg.attachment.url)" />
                  <i v-else :class="getAttachmentIcon(msg.attachment)" class="attachment-icon" />
                  <span class="attachment-name">{{ getAttachmentDisplayName(msg.attachment) }}</span>
                  <span v-if="msg.attachment.source === 'file'" class="file-size">({{ formatFileSize(msg.attachment.size) }})</span>
                  <Button v-if="msg.attachment.source === 'file'" icon="pi pi-download" class="p-button-text p-button-sm download-btn"
                    @click="downloadAttachment(msg.attachment)" />
                </template>
                <template v-else-if="msg.attachments && msg.attachments.length > 0">
                  <div v-for="(attachment, attIndex) in msg.attachments" :key="attIndex" class="attachment-item">
                    <img v-if="isImage(attachment)" :src="attachment.url" class="image-preview" 
                         @click="showImagePreview(attachment.url)" />
                    <i v-else :class="getAttachmentIcon(attachment)" class="attachment-icon" />
                    <span class="attachment-name">{{ getAttachmentDisplayName(attachment) }}</span>
                    <span v-if="attachment.source === 'file'" class="file-size">({{ formatFileSize(attachment.size) }})</span>
                    <Button v-if="attachment.source === 'file'" icon="pi pi-download" class="p-button-text p-button-sm download-btn"
                      @click="downloadAttachment(attachment)" />
                  </div>
                </template>
              </div>
              
              <div class="modal-message-text">
                <MarkdownRender v-if="activeTabIndex === 0" :content="msg.text" />
                <template v-else>{{ msg.text }}</template>
                <span v-if="
                  aiLoading &&
                  msg === assistantMessage &&
                  activeTabIndex === 0
                " class="streaming-cursor"></span>
              </div>
              <div class="modal-message-actions">
                <div class="modal-message-time">{{ msg.time }}</div>
                <div class="modal-action-buttons">
                  <Button v-if="activeTabIndex === 0 && !msg.isUser" icon="pi pi-copy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
                    class="copy-button p-button-text p-button-sm" @click="copyToClipboard(msg.text)" />
                  <Button v-if="activeTabIndex === 0" icon="pi pi-refresh" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞"
                    class="resend-button p-button-text p-button-sm" @click="resendMessage(index)"
                    data-testid="resend-message-button-modal" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–Ω–æ–≤–∞" />
                  <Button v-if="activeTabIndex === 0" icon="pi pi-pencil" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                    class="edit-button p-button-text p-button-sm" @click="editMessage(index)"
                    data-testid="edit-message-button-modal" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" />
                  <Button v-if="activeTabIndex === 0" icon="pi pi-trash" title="–£–¥–∞–ª–∏—Ç—å"
                    class="delete-button p-button-text p-button-sm p-button-danger" @click="deleteMessage(index)"
                    data-testid="delete-message-button-modal" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" />
                </div>
              </div>
            </div>
            <Avatar v-if="msg.isUser && !isSystemMessage(msg)" icon="pi pi-user" shape="circle" size="normal" class="ml-2" />
          </div>

          <div v-if="aiLoading && !assistantMessage && activeTabIndex === 0" class="modal-loading-indicator">
            <ProgressSpinner style="width: 30px; height: 30px" />
          </div>

          <div v-if="aiError && activeTabIndex === 0" class="modal-error-message">
            {{ aiError }}
          </div>
        </div>
        <div class="modal-controls">
          <div class="model-selector-row" v-if="activeTabIndex === 0">
            <ModelSelector
              application="Chat"
              :access-token="userAccessToken"
              :show-header="true"
              :show-token-info="false"
              :show-settings="false"
              @model-change="handleModelChange"
            />
            <Button icon="pi pi-cog" @click="showSettings = true" class="p-button-text settings-btn"
                    title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏" />
            <Button icon="pi pi-wrench" @click="showTools = true" class="p-button-text tools-btn"
                    title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" />
          </div>

          <div class="workspace-selector-row" v-if="activeTabIndex === 0 && agentMode">
            <label>Workspace:</label>
            <Dropdown v-model="selectedWorkspace" :options="workspaces" optionLabel="name" optionValue="id"
              placeholder="–í—ã–±–µ—Ä–∏—Ç–µ workspace" class="workspace-dropdown" :filter="true" :loading="loadingWorkspaces">
              <template #value="slotProps">
                <div v-if="slotProps.value" class="workspace-option">
                  <i class="pi pi-folder"></i>
                  <span>{{ getWorkspaceName(slotProps.value) }}</span>
                </div>
                <span v-else>{{ slotProps.placeholder }}</span>
              </template>
              <template #option="slotProps">
                <div class="workspace-option">
                  <i class="pi pi-folder"></i>
                  <span>{{ slotProps.option.name }}</span>
                </div>
              </template>
            </Dropdown>
            <Button icon="pi pi-plus" @click="showCreateWorkspaceDialog = true" class="p-button-text"
                    title="–°–æ–∑–¥–∞—Ç—å workspace" />
            <Button icon="pi pi-refresh" @click="loadWorkspaces" :loading="loadingWorkspaces" class="p-button-text"
                    title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" />
          </div>

          <div class="modal-input-container">
            <Button icon="pi pi-microphone" @click="toggleVoiceInput"
                    :class="['p-button-text', 'voice-btn', { 'recording': isRecording }]"
                    title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥" />
            <InputText v-if="activeTabIndex === 0" v-model="aiMessage" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ò–ò..."
              @keyup.enter="sendAiMessage" class="modal-input-field" :disabled="aiLoading" />
            <InputText v-else v-model="newMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." @keyup.enter="sendMessage"
              class="modal-input-field" />
            <input type="file" ref="modalFileInput" style="display: none" @change="handleModalFileUpload"
                   accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.json,.csv,image/*" multiple />
            <Button icon="pi pi-paperclip" @click="modalAttachmentMenu.toggle($event)" class="p-button-text attachment-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" />
            <Popover ref="modalAttachmentMenu">
              <div class="attachment-menu">
                <Button label="–° —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" icon="pi pi-upload" @click="triggerModalFileUpload(); modalAttachmentMenu.hide()" class="p-button-text w-full justify-start" />
                <Button label="–¢–∞–±–ª–∏—Ü—ã/–æ—Ç—á—ë—Ç—ã" icon="pi pi-database" @click="showDataSelector = true; modalAttachmentMenu.hide()" class="p-button-text w-full justify-start" />
              </div>
            </Popover>
            <Button icon="pi pi-send" @click="activeTabIndex === 0 ? sendAiMessage() : sendMessage()"
              :severity="activeTabIndex === 0 ? 'help' : 'info'" :disabled="aiLoading && activeTabIndex === 0" class="send-btn" />
          </div>
        </div>
        
        <div v-if="currentAttachments.length > 0 && activeTabIndex === 0" class="current-attachments">
          <div v-for="(attachment, index) in currentAttachments" :key="index" class="current-attachment">
            <div class="modal-attachment-info current">
              <img v-if="isImage(attachment)" :src="attachment.url" class="image-preview-small" />
              <i v-else :class="getAttachmentIcon(attachment)" class="attachment-icon" />
              <span class="attachment-name">{{ getAttachmentDisplayName(attachment) }}</span>
              <span v-if="attachment.source === 'file'" class="file-size">({{ formatFileSize(attachment.size) }})</span>
              <Button icon="pi pi-times" class="p-button-text p-button-sm p-button-danger remove-btn"
                @click="removeCurrentAttachment(index)" />
            </div>
          </div>
        </div>
      </div>
    </Dialog>

    <Dialog v-model:visible="showHistory" modal header="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤" :style="{ width: '600px' }" data-testid="history-dialog">
      <div class="history-dialog">
        <div v-if="loadingHistory" class="text-center py-3" data-testid="history-loading">
          <ProgressSpinner style="width: 40px; height: 40px" />
          <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
        </div>

        <div v-else-if="sessionHistory.length === 0" class="text-center py-3" data-testid="history-empty">
          <i class="pi pi-inbox" style="font-size: 3rem; color: var(--surface-400)"></i>
          <p class="mt-2">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>
        </div>

        <div v-else class="chat-list" data-testid="session-list">
          <div v-for="session in sessionHistory" :key="session.id" class="chat-item" data-testid="session-item" :data-session-id="session.id">
            <div class="chat-info">
              <strong>{{ formatSessionName(session) }}</strong>
              <small class="text-muted">{{ formatDateTime(session.lastActivity || session.created) }}</small>
            </div>
            <div class="chat-actions">
              <Button icon="pi pi-folder-open" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å" @click="loadSession(session)" class="p-button-text p-button-sm"
                      data-testid="load-session-button" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é" />
              <Button icon="pi pi-trash" title="–£–¥–∞–ª–∏—Ç—å" @click="deleteSession(session.id)" class="p-button-text p-button-sm p-button-danger"
                      data-testid="delete-session-button" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é" />
            </div>
          </div>
        </div>
      </div>
    </Dialog>

    <Dialog v-model:visible="showEditMessageDialog" modal header="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" :style="{ width: '500px' }" data-testid="edit-message-dialog">
      <div class="edit-message-dialog">
        <Textarea v-model="editingMessageText" rows="10" class="w-full" autoResize data-testid="edit-message-textarea" aria-label="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" />
      </div>
      <template #footer>
        <Button label="–û—Ç–º–µ–Ω–∞" icon="pi pi-times" @click="cancelEditMessage" class="p-button-text"
                data-testid="cancel-edit-button" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" />
        <Button label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" icon="pi pi-check" @click="saveEditedMessage" severity="success"
                data-testid="save-edit-button" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" />
      </template>
    </Dialog>

    <Dialog v-model:visible="showDataSelector" modal header="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" :style="{ width: '500px' }">
      <div class="data-selector-dialog">
        <div class="field">
          <label>–¢–∏–ø –≤–ª–æ–∂–µ–Ω–∏—è</label>
          <Dropdown v-model="selectedDataType" :options="dataTypes" optionLabel="label"
            placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–ª–æ–∂–µ–Ω–∏—è" class="w-full" />
        </div>

        <div class="field" v-if="selectedDataType">
          <label>{{ selectedDataType.label }}</label>
          <Dropdown v-model="selectedDataItem" :options="dataItems"
            :optionLabel="item => item.name || item.value || item.id" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç" class="w-full"
            :loading="loadingDataItems" />
        </div>

        <div class="field" v-if="selectedDataItem">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –¥–∞–Ω–Ω—ã–º</label>
          <InputText v-model="dataComment" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="w-full" />
        </div>
      </div>

      <template #footer>
        <Button label="–û—Ç–º–µ–Ω–∞" icon="pi pi-times" @click="showDataSelector = false" class="p-button-text" />
        <Button label="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å" icon="pi pi-paperclip" @click="attachData" :disabled="!selectedDataItem"
          severity="success" />
      </template>
    </Dialog>

    <Dialog v-model:visible="showImageDialog" modal header="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" :style="{ width: 'auto' }">
      <img :src="currentImage" class="preview-image" />
    </Dialog>

    <!-- Settings Dialog -->
    <Dialog v-model:visible="showSettings" modal header="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏" :style="{ width: '600px', maxHeight: '80vh' }">
      <div class="settings-dialog">
        <div class="field">
          <label>Context Size (–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)</label>
          <InputNumber v-model="llmSettings.contextSize" :min="0" :max="32768" :step="512" class="w-full" />
          <small>–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–∞ (0 = –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–µ–ª–∏). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 8192</small>
        </div>

        <div class="field">
          <label>GPU Layers (–°–ª–æ–∏ GPU)</label>
          <InputNumber v-model="llmSettings.gpuLayers" :min="-1" :max="200" class="w-full" />
          <small>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–µ–≤ –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –Ω–∞ GPU (-1 –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ–µ–≤, 0 –¥–ª—è CPU). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100</small>
        </div>

        <div class="field">
          <label>Temperature (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞): {{ llmSettings.temperature }}</label>
          <Slider v-model="llmSettings.temperature" :min="0" :max="2" :step="0.1" class="w-full" />
          <small>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—ã—à–µ = –±–æ–ª–µ–µ —Å–ª—É—á–∞–π–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.6</small>
        </div>

        <div class="field">
          <label>Top K: {{ llmSettings.topK }}</label>
          <Slider v-model="llmSettings.topK" :min="0" :max="100" :step="1" class="w-full" />
          <small>Top-K —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 40</small>
        </div>

        <div class="field">
          <label>Top P: {{ llmSettings.topP }}</label>
          <Slider v-model="llmSettings.topP" :min="0" :max="1" :step="0.05" class="w-full" />
          <small>Top-P —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (1.0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.9</small>
        </div>

        <div class="field">
          <label>Min P: {{ llmSettings.minP }}</label>
          <Slider v-model="llmSettings.minP" :min="0" :max="1" :step="0.05" class="w-full" />
          <small>Min-P —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (0.0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.1</small>
        </div>

        <div class="field">
          <label>Repeat Last N (–ü–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N)</label>
          <InputNumber v-model="llmSettings.repeatLastN" :min="-1" :max="256" class="w-full" />
          <small>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —à—Ç—Ä–∞—Ñ–∞ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ, -1 = ctx_size). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 64</small>
        </div>

        <div class="field">
          <label>Repeat Penalty (–®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä): {{ llmSettings.repeatPenalty }}</label>
          <Slider v-model="llmSettings.repeatPenalty" :min="1" :max="2" :step="0.05" class="w-full" />
          <small>–®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤ (1.0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1.0</small>
        </div>

        <div class="field">
          <label>Presence Penalty (–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ): {{ llmSettings.presencePenalty }}</label>
          <Slider v-model="llmSettings.presencePenalty" :min="0" :max="2" :step="0.1" class="w-full" />
          <small>–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ (0.0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.0</small>
        </div>

        <div class="field">
          <label>Frequency Penalty (–®—Ç—Ä–∞—Ñ –∑–∞ —á–∞—Å—Ç–æ—Ç—É): {{ llmSettings.frequencyPenalty }}</label>
          <Slider v-model="llmSettings.frequencyPenalty" :min="0" :max="2" :step="0.1" class="w-full" />
          <small>–®—Ç—Ä–∞—Ñ –∑–∞ —á–∞—Å—Ç–æ—Ç—É (0.0 = –æ—Ç–∫–ª—é—á–µ–Ω–æ). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.0</small>
        </div>

        <div class="field">
          <label>Batch Size (–†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞)</label>
          <InputNumber v-model="llmSettings.batchSize" :min="1" :max="2048" :step="128" class="w-full" />
          <small>–õ–æ–≥–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 512</small>
        </div>

        <div class="field">
          <label>Custom Jinja Chat template (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —à–∞–±–ª–æ–Ω)</label>
          <Textarea v-model="llmSettings.customTemplate" rows="3" class="w-full"
                    placeholder="{% for message in messages %}...{% endfor %}" />
          <small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π Jinja —à–∞–±–ª–æ–Ω —á–∞—Ç–∞ –¥–ª—è –º–æ–¥–µ–ª–∏</small>
        </div>

        <div class="field">
          <label>Override Tensor Buffer Type (–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –±—É—Ñ–µ—Ä–∞ —Ç–µ–Ω–∑–æ—Ä–∞)</label>
          <InputText v-model="llmSettings.tensorBufferType" class="w-full"
                     placeholder="layers\.\d+\.ffn_.*=CPU" />
          <small>–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –±—É—Ñ–µ—Ä–∞ —Ç–µ–Ω–∑–æ—Ä–∞ –¥–ª—è –º–æ–¥–µ–ª–∏</small>
        </div>

        <div class="field">
          <label>Custom System Prompt (–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç)</label>
          <Textarea v-model="llmSettings.customSystemPrompt" rows="5" class="w-full"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É..." />
          <small>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—É</small>
        </div>

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="llmSettings.disableKVOffload" inputId="kvOffload" :binary="true" />
          <label for="kvOffload">Disable KV Offload (–û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–≥—Ä—É–∑–∫—É KV –∫—ç—à–∞ –Ω–∞ GPU)</label>
        </div>
      </div>

      <template #footer>
        <Button label="–ó–∞–∫—Ä—ã—Ç—å" icon="pi pi-times" @click="showSettings = false" class="p-button-text" />
        <Button label="–°–±—Ä–æ—Å–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" icon="pi pi-refresh" @click="resetSettings" severity="secondary" />
      </template>
    </Dialog>

    <!-- Tools Dialog -->
    <Dialog v-model:visible="showTools" modal header="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" :style="{ width: '500px' }">
      <div class="tools-dialog">
        <div class="field flex align-items-center gap-2 agent-mode-toggle">
          <Checkbox v-model="agentMode" inputId="agentMode" :binary="true" />
          <label for="agentMode" class="font-bold">
            ü§ñ –†–µ–∂–∏–º –∞–≥–µ–Ω—Ç–∞ (–∫–∞–∫ Claude Code)
          </label>
        </div>

        <Divider />

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.mcpEnabled" inputId="mcp" :binary="true" />
          <label for="mcp">MCP (Model Context Protocol)</label>
        </div>

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.agentsEnabled" inputId="agents" :binary="true" />
          <label for="agents">–ê–≥–µ–Ω—Ç—ã (AI Agents)</label>
        </div>

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.searchEnabled" inputId="search" :binary="true" />
          <label for="search">–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (Search)</label>
        </div>

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.webBrowsingEnabled" inputId="webBrowsing" :binary="true" />
          <label for="webBrowsing">–í–µ–±-–±—Ä–∞—É–∑–∏–Ω–≥ (Web Browsing)</label>
        </div>

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.codeInterpreterEnabled" inputId="codeInterpreter" :binary="true" />
          <label for="codeInterpreter">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ (Code Execution)</label>
        </div>

        <Divider />

        <div class="field flex align-items-center gap-2">
          <Checkbox v-model="toolsConfig.integramDatabaseEnabled" inputId="integramDatabase" :binary="true" />
          <label for="integramDatabase">üóÑÔ∏è Integram Database Access</label>
        </div>

        <div v-if="toolsConfig.integr‡∏≤‡∏°DatabaseEnabled" class="integram-mcp-status" style="margin-left: 30px; margin-top: 10px;">
          <div v-if="integraMCPState.isAuthenticated" class="flex align-items-center gap-2">
            <i class="pi pi-check-circle success-icon" />
            <span class="status-text">
              –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: {{ integraMCPState.username }}@{{ integr‡§æ‡§ÆMCPState.database }}
            </span>
            <Button label="–û—Ç–∫–ª—é—á–∏—Ç—å" icon="pi pi-sign-out"
                    @click="handleIntegrÿßŸÖMCPLogout"
                    class="p-button-text p-button-sm p-button-danger" />
          </div>
          <div v-else class="flex align-items-center gap-2">
            <i class="pi pi-times-circle warning-icon" />
            <span class="status-text">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            <Button label="–í–æ–π—Ç–∏" icon="pi pi-sign-in"
                    @click="showIntegrÿßŸÖMCPAuth = true; showTools = false"
                    class="p-button-text p-button-sm" />
          </div>
        </div>

        <div v-if="agentMode" class="agent-info">
          <small>
            <i class="pi pi-info-circle" />
            –í —Ä–µ–∂–∏–º–µ –∞–≥–µ–Ω—Ç–∞ —á–∞—Ç –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–¥,
            —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.
          </small>
        </div>
      </div>

      <template #footer>
        <Button label="–ó–∞–∫—Ä—ã—Ç—å" icon="pi pi-check" @click="showTools = false" severity="success" />
      </template>
    </Dialog>

    <!-- Create Workspace Dialog -->
    <Dialog v-model:visible="showCreateWorkspaceDialog" modal header="–°–æ–∑–¥–∞—Ç—å Workspace" :style="{ width: '600px' }">
      <div class="create-workspace-dialog">
        <div class="field">
          <label for="workspace-name">–ù–∞–∑–≤–∞–Ω–∏–µ workspace</label>
          <InputText id="workspace-name" v-model="newWorkspace.name"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..." class="w-full" />
        </div>

        <div class="field">
          <label for="workspace-repo">Git Repository URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <InputText id="workspace-repo" v-model="newWorkspace.repositoryUrl"
                     placeholder="https://github.com/user/repo.git" class="w-full" />
          <small>URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ workspace</small>
        </div>

        <div class="field" v-if="newWorkspace.repositoryUrl">
          <label for="workspace-branch">–í–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <InputText id="workspace-branch" v-model="newWorkspace.branch"
                     placeholder="main" class="w-full" />
          <small>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: main</small>
        </div>

        <div v-if="createWorkspaceError" class="error-message mt-3">
          {{ createWorkspaceError }}
        </div>
      </div>

      <template #footer>
        <Button label="–û—Ç–º–µ–Ω–∞" icon="pi pi-times" @click="showCreateWorkspaceDialog = false" class="p-button-text" />
        <Button label="–°–æ–∑–¥–∞—Ç—å" icon="pi pi-plus" @click="createNewWorkspace"
                :loading="creatingWorkspace" severity="success" />
      </template>
    </Dialog>

    <!-- Integram MCP Authentication Dialog (Phase 1) -->
    <Dialog v-model:visible="showIntegrÿßŸÖMCPAuth" modal header="üóÑÔ∏è Integram Database - –í—Ö–æ–¥" :style="{ width: '500px' }">
      <div class="integram-auth-dialog">
        <div class="field">
          <label for="integram-server">–°–µ—Ä–≤–µ—Ä</label>
          <InputText id="integram-server" v-model="integramAuthForm.serverURL"
                     placeholder="https://dronedoc.ru" class="w-full" />
          <small>URL —Å–µ—Ä–≤–µ—Ä–∞ Integram</small>
        </div>

        <div class="field">
          <label for="integram-database">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</label>
          <InputText id="integram-database" v-model="integramAuthForm.database"
                     placeholder="my" class="w-full" />
          <small>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: my, a2025)</small>
        </div>

        <div class="field">
          <label for="integram-login">–õ–æ–≥–∏–Ω</label>
          <InputText id="integram-login" v-model="integr‡§æ‡§ÆAuthForm.login"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" class="w-full"
                     @keyup.enter="handleIntegrÿßŸÖMCPAuth" />
        </div>

        <div class="field">
          <label for="integram-password">–ü–∞—Ä–æ–ª—å</label>
          <Password id="integram-password" v-model="integramAuthForm.password"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full"
                    :feedback="false" toggleMask
                    @keyup.enter="handleIntegrÿßŸÖMCPAuth" />
        </div>

        <div v-if="integramAuthError" class="error-message mt-3">
          <i class="pi pi-exclamation-triangle" />
          {{ integramAuthError }}
        </div>

        <div class="info-message mt-3">
          <small>
            <i class="pi pi-info-circle" />
            –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ Integram –Ω–∞–ø—Ä—è–º—É—é,
            –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç—å. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å –±–æ–ª—å—à–∏–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.
          </small>
        </div>
      </div>

      <template #footer>
        <Button label="–û—Ç–º–µ–Ω–∞" icon="pi pi-times" @click="showIntegrÿßŸÖMCPAuth = false" class="p-button-text" />
        <Button label="–í–æ–π—Ç–∏" icon="pi pi-sign-in" @click="handleIntegr–∞–ºMCPAuth"
                :loading="integramAuthLoading" severity="success"
                :disabled="!integramAuthForm.login || !integramAuthForm.password" />
      </template>
    </Dialog>

    <!-- Code Execution Window -->
    <CodeExecutionWindow
      v-model="showCodeExecutionWindow"
      :executions="codeExecutions"
      @execution-complete="onExecutionComplete"
      @execution-error="onExecutionError"
    />
  </div>
</template>

<script setup>
import { logger } from '@/utils/logger'
import { getApiUrl } from '@/utils/apiConfig'
import { ref, reactive, watch, nextTick, computed, onMounted, onUnmounted } from 'vue'
import { useRoute } from 'vue-router'

import MarkdownRender from '@/components/MarkdownRender.vue'
import CodeExecutionWindow from '@/components/chat/CodeExecutionWindow.vue'
import ModelSelector from '@/components/ai/ModelSelector.vue'
import apiClient from '@/axios2.js'
import polzaService from '@/services/polzaService.js'
import { integramChatSessionService } from '@/services/integramChatSessionService.js'
import integramApiClient from '@/services/integramApiClient.js'
import {
  searchWeb,
  executeCode as executeCodeAPI,
  extractCodeBlocks,
  hasExecutableCode,
  formatSearchResults,
  getAgentSystemPrompt
} from '@/services/chatAgentService'
import {
  createWorkspace,
  getUserWorkspaces,
  deleteWorkspace,
  chatWithWorkspace
} from '@/services/workspaceService'
import integraMCPService from '@/services/integraMCPService'
import { useAuthStore } from '@/stores/authStore'

const route = useRoute()

// Safely access authStore - handle case where Pinia might not be ready yet (Issue #5216)
// This can happen during HMR (Hot Module Replacement) or if Chat component loads before Pinia initialization
let authStore
try {
  authStore = useAuthStore()
} catch (error) {
  console.warn('[Chat] Pinia not ready, deferring authStore access:', error.message)
  authStore = null
}

// Get real userId for token consumption tracking
const currentUserId = computed(() => {
  if (authStore?.unifiedSession?.userId) {
    return authStore.unifiedSession.userId
  }
  if (authStore?.primaryUserId) {
    return authStore.primaryUserId
  }
  const storedId = localStorage.getItem('id')
  if (storedId) {
    return storedId
  }
  return 'd' // fallback
})
const isEditorPage = computed(() => route.path.startsWith('/editor'))
const isModalVisible = ref(false)
const showDataSelector = ref(false)
const showHistory = ref(false)
const showImageDialog = ref(false)
const showSettings = ref(false)
const showTools = ref(false)
const showCreateWorkspaceDialog = ref(false)
const showIntegrÿßŸÖMCPAuth = ref(false)
const showEditMessageDialog = ref(false)
const fileInput = ref(null)
const fileInputGeneral = ref(null)
const modalFileInput = ref(null)
const attachmentMenu = ref()
const attachmentMenuGeneral = ref()
const modalAttachmentMenu = ref()
const currentImage = ref('')

// Session history management
const sessionHistory = ref([])
const loadingHistory = ref(false)

// Message editing
const editingMessageIndex = ref(null)
const editingMessageText = ref('')

const isRecording = ref(false)
const recognition = ref(null)
const uploadProgress = ref(0)

// Model selection - now using ModelSelector component
// Initialize from localStorage to preserve model choice across page reloads
const selectedModel = ref(localStorage.getItem('selectedModel') || null)
const userAccessToken = ref(localStorage.getItem('userAccessToken') || null)

// LLM Settings
const llmSettings = reactive({
  contextSize: parseInt(localStorage.getItem('llm_contextSize')) || 8192,
  gpuLayers: parseInt(localStorage.getItem('llm_gpuLayers')) || 100,
  temperature: parseFloat(localStorage.getItem('llm_temperature')) || 0.6,
  topK: parseInt(localStorage.getItem('llm_topK')) || 40,
  topP: parseFloat(localStorage.getItem('llm_topP')) || 0.9,
  minP: parseFloat(localStorage.getItem('llm_minP')) || 0.1,
  repeatLastN: parseInt(localStorage.getItem('llm_repeatLastN')) || 64,
  repeatPenalty: parseFloat(localStorage.getItem('llm_repeatPenalty')) || 1.0,
  presencePenalty: parseFloat(localStorage.getItem('llm_presencePenalty')) || 0.0,
  frequencyPenalty: parseFloat(localStorage.getItem('llm_frequencyPenalty')) || 0.0,
  customTemplate: localStorage.getItem('llm_customTemplate') || '',
  tensorBufferType: localStorage.getItem('llm_tensorBufferType') || '',
  disableKVOffload: localStorage.getItem('llm_disableKVOffload') === 'true',
  batchSize: parseInt(localStorage.getItem('llm_batchSize')) || 512,
  customSystemPrompt: localStorage.getItem('llm_customSystemPrompt') || '',
})

// Tools configuration
const toolsConfig = reactive({
  mcpEnabled: localStorage.getItem('tools_mcpEnabled') !== 'false',
  agentsEnabled: localStorage.getItem('tools_agentsEnabled') !== 'false',
  searchEnabled: localStorage.getItem('tools_searchEnabled') !== 'false',
  webBrowsingEnabled: localStorage.getItem('tools_webBrowsingEnabled') === 'true',
  codeInterpreterEnabled: localStorage.getItem('tools_codeInterpreterEnabled') === 'true',
  integramDatabaseEnabled: localStorage.getItem('tools_integramDatabaseEnabled') === 'true',
})

// Integram MCP state
const integraMCPState = reactive({
  isAuthenticated: false,
  serverURL: '',
  database: '',
  username: '',
  userId: null
})

const integramAuthForm = reactive({
  serverURL: 'https://dronedoc.ru',
  database: 'my',
  login: '',
  password: ''
})

const integramAuthLoading = ref(false)
const integramAuthError = ref(null)

// Chat Agent capabilities
const showCodeExecutionWindow = ref(false)
const codeExecutions = ref([])
const agentMode = ref(localStorage.getItem('chat_agentMode') === 'true')

// Workspace management
const workspaces = ref([])
const selectedWorkspace = ref(null)
const loadingWorkspaces = ref(false)
const creatingWorkspace = ref(false)
const createWorkspaceError = ref(null)
const newWorkspace = reactive({
  name: '',
  repositoryUrl: '',
  branch: 'main'
})

watch(selectedModel, (newVal) => {
  localStorage.setItem('selectedModel', newVal)
})

watch(llmSettings, (newVal) => {
  Object.keys(newVal).forEach(key => {
    localStorage.setItem(`llm_${key}`, String(newVal[key]))
  })
}, { deep: true })

watch(toolsConfig, (newVal) => {
  Object.keys(newVal).forEach(key => {
    localStorage.setItem(`tools_${key}`, String(newVal[key]))
  })
}, { deep: true })

watch(agentMode, (newVal) => {
  localStorage.setItem('chat_agentMode', String(newVal))
})

// Agent helper functions
const handleWebSearch = async (query) => {
  try {
    const results = await searchWeb(query)
    const formatted = formatSearchResults(results.data)

    aiChat.messages.push({
      text: formatted,
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: false,
      isSearchResult: true
    })

    scrollToBottom(aiMessagesContainer)
    if (isModalVisible.value) {
      scrollToBottom(modalMessagesContainer)
    }
  } catch (error) {
    console.error('Search error:', error)
    aiError.value = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message
  }
}

const handleCodeExecution = (messageText) => {
  const blocks = extractCodeBlocks(messageText)

  blocks.forEach((block, index) => {
    codeExecutions.value.push({
      id: `exec_${Date.now()}_${index}`,
      title: `${block.language} (${index + 1})`,
      code: block.code,
      language: block.language,
      executed: false,
      executing: false,
      output: null,
      error: null,
      exitCode: null,
      execId: null,
      filename: null,
      dependencies: [],
      dependenciesInstalled: false,
      installingDeps: false
    })
  })

  if (blocks.length > 0) {
    showCodeExecutionWindow.value = true
  }
}

// Polza.ai Chat API configuration
// Using Polza.ai through orchestrator backend (via Vite proxy)
const POLZA_CHAT_API_URL = '/api/polza'

// Session management for Polza.ai - we'll create session dynamically
const polzaSessionId = ref(null)

// –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
const isApiAvailable = ref(false)

const isImage = (attachment) => {
  if (!attachment.type) return false
  return attachment.type.startsWith('image/') || 
         ['.jpg', '.jpeg', '.png', '.gif', '.webp'].some(ext => attachment.name.toLowerCase().endsWith(ext))
}

const showImagePreview = (url) => {
  currentImage.value = url
  showImageDialog.value = true
}

const toggleVoiceInput = () => {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º')
    return
  }

  if (isRecording.value) {
    recognition.value.stop()
    isRecording.value = false
    return
  }

  recognition.value = new (window.SpeechRecognition || window.webkitSpeechRecognition)()
  recognition.value.lang = 'ru-RU'
  recognition.value.continuous = false
  recognition.value.interimResults = true

  recognition.value.onstart = () => isRecording.value = true

  recognition.value.onresult = (event) => {
    const transcript = Array.from(event.results)
      .map(result => result[0].transcript)
      .join('')
    
    if (activeTabIndex.value === 0) {
      aiMessage.value = transcript
    } else {
      newMessage.value = transcript
    }
  }

  recognition.value.onend = () => isRecording.value = false
  recognition.value.onerror = () => isRecording.value = false

  recognition.value.start()
}

const copyToClipboard = async (text) => {
  try {
    await navigator.clipboard.writeText(text)
  } catch (err) {
    const textArea = document.createElement('textarea')
    textArea.value = text
    document.body.appendChild(textArea)
    textArea.select()
    document.execCommand('copy')
    document.body.removeChild(textArea)
  }
}

const savedChats = ref(JSON.parse(localStorage.getItem('aiChatHistory')) || [])
const newChatName = ref('')

const saveChat = () => {
  if (!newChatName.value.trim()) return

  const chat = {
    id: Date.now().toString(),
    name: newChatName.value,
    messages: [...aiChat.messages],
    timestamp: new Date().toISOString()
  }

  savedChats.value.push(chat)
  localStorage.setItem('aiChatHistory', JSON.stringify(savedChats.value))
  newChatName.value = ''
  showHistory.value = false
}

const loadChat = (chat) => {
  aiChat.messages = [...chat.messages]
  showHistory.value = false
}

const deleteChat = (id) => {
  savedChats.value = savedChats.value.filter(chat => chat.id !== id)
  localStorage.setItem('aiChatHistory', JSON.stringify(savedChats.value))
}

// New session management functions
const createNewChatSession = async () => {
  try {
    // Clear current chat
    aiChat.messages = [
      {
        text: '–¢—ã —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å JSON –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:–†–∞–±–æ—Ç–∞–µ–º —Å —Ç–∞–±–ª–∏—Ü–µ–π: headers (id,value,type,isMain) –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫–æ–ª–æ–Ω–∫–∏, rows (id,values) —Å–æ–¥–µ—Ä–∂–∞—Ç —è—á–µ–π–∫–∏ —Å headerId –¥–ª—è —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã—Ö.',
        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
        isUser: true,
      },
      {
        text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DronDoc.\n–Ø –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ –æ—Ç—á—ë—Ç—ã, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ç.–¥.\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
        isUser: false,
      },
    ]

    // Clear session ID to create new one
    localStorage.removeItem('polza_session_id')
    polzaSessionId.value = null

    // Initialize session service and create new session
    await integramChatSessionService.initialize()

    console.log('[Chat] New chat session created')
  } catch (error) {
    console.error('[Chat] Failed to create new session:', error)
  }
}

const loadSessionHistory = async () => {
  loadingHistory.value = true
  try {
    // Use Integram report endpoint for session history
    const reportUrl = 'https://dronedoc.ru/my/report/session_chat'
    const response = await fetch(reportUrl, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Accept': 'application/json'
      }
    })

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const data = await response.json()

    // Parse the report data into session format
    if (data && data.object) {
      const sessions = data.object.map(sessionId => {
        const sessionData = data.reqs[sessionId] || {}
        return {
          id: sessionId,
          val: sessionData.name || `Session ${sessionId}`,
          created: sessionData.created,
          lastActivity: sessionData.lastActivity,
          ...sessionData
        }
      })
      sessionHistory.value = sessions
      console.log('[Chat] Loaded session history from report:', sessions.length)
    } else {
      sessionHistory.value = []
    }
  } catch (error) {
    console.error('[Chat] Failed to load session history from report:', error)
    // Fallback to service method
    try {
      await integramChatSessionService.initialize()
      const sessions = await integramChatSessionService.loadSessionHistory(50)
      sessionHistory.value = sessions || []
      console.log('[Chat] Loaded session history (fallback):', sessions?.length)
    } catch (fallbackError) {
      console.error('[Chat] Fallback also failed:', fallbackError)
      sessionHistory.value = []
    }
  } finally {
    loadingHistory.value = false
  }
}

const loadSession = async (session) => {
  try {
    // Get session data from Integram
    const sessionId = session.val || session.id
    const sessionData = await integramChatSessionService.getSession(sessionId)

    if (sessionData.success && sessionData.messages) {
      // Load messages into chat
      aiChat.messages = sessionData.messages

      // Set current session ID
      polzaSessionId.value = sessionId
      localStorage.setItem('polza_session_id', sessionId)

      // Load transactions to get full conversation
      const transactions = await integramChatSessionService.getSessionTransactions(sessionId)

      if (transactions && transactions.length > 0) {
        // Convert transactions to messages
        const messages = []

        for (const transaction of transactions) {
          const question = transaction.reqs?.['205916']?.value || ''
          const answer = transaction.reqs?.['205931']?.value || ''

          if (question) {
            messages.push({
              text: question,
              time: new Date(transaction.val).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
              isUser: true
            })
          }

          if (answer) {
            messages.push({
              text: answer,
              time: new Date(transaction.val).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
              isUser: false
            })
          }
        }

        if (messages.length > 0) {
          aiChat.messages = messages
        }
      }

      showHistory.value = false
      console.log('[Chat] Session loaded:', sessionId)
    }
  } catch (error) {
    console.error('[Chat] Failed to load session:', error)
  }
}

const deleteSession = async (sessionId) => {
  try {
    // Delete session from Integram
    const integramId = integramChatSessionService.sessionsCache.get(sessionId)

    if (integramId) {
      await integramApiClient.deleteObject(integramId)

      // Remove from cache
      integramChatSessionService.sessionsCache.delete(sessionId)
      integramChatSessionService.saveCacheToStorage()

      // Reload history
      await loadSessionHistory()

      console.log('[Chat] Session deleted:', sessionId)
    }
  } catch (error) {
    console.error('[Chat] Failed to delete session:', error)
  }
}

const formatSessionName = (session) => {
  // Try to get session name from value, or generate from timestamp
  if (session.val) {
    return session.val
  }
  return `–°–µ—Å—Å–∏—è ${new Date(session.created || Date.now()).toLocaleString('ru-RU')}`
}

const formatDateTime = (dateStr) => {
  if (!dateStr) return ''
  try {
    const date = new Date(dateStr)
    return date.toLocaleString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  } catch (e) {
    return dateStr
  }
}

// Message edit/delete functions
const editMessage = (index) => {
  editingMessageIndex.value = index
  editingMessageText.value = aiChat.messages[index].text
  showEditMessageDialog.value = true
}

const cancelEditMessage = () => {
  showEditMessageDialog.value = false
  editingMessageIndex.value = null
  editingMessageText.value = ''
}

const saveEditedMessage = async () => {
  if (editingMessageIndex.value === null) return

  try {
    // Update message in local array
    aiChat.messages[editingMessageIndex.value].text = editingMessageText.value

    // TODO: Save to database
    // For now, we'll save to localStorage
    const messagesToSave = aiChat.messages.filter(msg => msg !== assistantMessage.value)
    localStorage.setItem('aiChat', JSON.stringify(messagesToSave))

    // Close dialog
    showEditMessageDialog.value = false
    editingMessageIndex.value = null
    editingMessageText.value = ''

    console.log('[Chat] Message edited')
  } catch (error) {
    console.error('[Chat] Failed to edit message:', error)
  }
}

const deleteMessage = async (index) => {
  try {
    // Remove message from array
    aiChat.messages.splice(index, 1)

    // TODO: Delete from database
    // For now, we'll save to localStorage
    const messagesToSave = aiChat.messages.filter(msg => msg !== assistantMessage.value)
    localStorage.setItem('aiChat', JSON.stringify(messagesToSave))

    console.log('[Chat] Message deleted')
  } catch (error) {
    console.error('[Chat] Failed to delete message:', error)
  }
}

const resendMessage = async (index) => {
  try {
    const message = aiChat.messages[index]
    if (!message) return

    // Set the message text to input field
    aiMessage.value = message.text

    // If message has attachments, restore them
    if (message.attachments && message.attachments.length > 0) {
      currentAttachments.value = [...message.attachments]
    }

    // Send the message
    await sendAiMessage()

    console.log('[Chat] Message resent')
  } catch (error) {
    console.error('[Chat] Failed to resend message:', error)
  }
}

// Watch for history dialog open to load sessions
watch(showHistory, (newVal) => {
  if (newVal) {
    loadSessionHistory()
  }
})

const dataTypes = ref([
  { value: 'table', label: '–¢–∞–±–ª–∏—Ü–∞' },
  { value: 'report', label: '–û—Ç—á—ë—Ç' },
])
const selectedDataType = ref(null)
const selectedDataItem = ref(null)
const dataComment = ref('')
const loadingDataItems = ref(false)
const dataItems = ref([])

const getAttachmentIcon = (attachment) => {
  // Phase 3: Handle MCP table references
  if (attachment.source === 'integram_mcp' && attachment.type === 'integram/table-reference') {
    return 'pi pi-database' // Database icon for MCP references
  }

  if (attachment.source === 'api') {
    return attachment.itemType === 'table' ? 'pi pi-table' : 'pi pi-chart-bar'
  }

  const extension = attachment.name.split('.').pop().toLowerCase()
  const iconMap = {
    pdf: 'pi pi-file-pdf',
    doc: 'pi pi-file-word',
    docx: 'pi pi-file-word',
    xls: 'pi pi-file-excel',
    xlsx: 'pi pi-file-excel',
    ppt: 'pi pi-file-powerpoint',
    pptx: 'pi pi-file-powerpoint',
    jpg: 'pi pi-image',
    jpeg: 'pi pi-image',
    png: 'pi pi-image',
    gif: 'pi pi-image',
    txt: 'pi pi-file',
    json: 'pi pi-code',
    csv: 'pi pi-table',
    xml: 'pi pi-code',
    html: 'pi pi-code',
    md: 'pi pi-file'
  }

  return iconMap[extension] || 'pi pi-file'
}

const getAttachmentDisplayName = (attachment) => {
  // Phase 3: Show MCP reference info
  if (attachment.source === 'integram_mcp' && attachment.mcpReference) {
    const ref = attachment.mcpReference
    return `${ref.tableName} (${ref.rowCount.toLocaleString('ru-RU')} rows, ${ref.columnCount} columns)`
  }

  if (attachment.source === 'api') {
    return attachment.itemName || attachment.name.replace('.json', '')
  }
  return attachment.name
}

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

const isSystemMessage = (msg) => {
  return msg.text.includes('–¢—ã —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫') && msg.isUser
}

// Handle model change from ModelSelector
const handleModelChange = ({ modelId, model }) => {
  logger.debug('Model changed:', { modelId, model })
  // Use model.id if model object is provided, otherwise use modelId
  // This ensures we always get the model identifier (e.g., "anthropic/claude-sonnet-4.5")
  const modelIdentifier = model?.id || model?.model_id || modelId
  selectedModel.value = modelIdentifier
  localStorage.setItem('selectedModel', modelIdentifier)
  logger.debug('Selected model updated to:', modelIdentifier)
}

const closeChat = () => {
  localStorage.setItem('chat', 'false')
  window.dispatchEvent(new StorageEvent('storage', {
    key: 'chat',
    newValue: 'false',
    storageArea: localStorage
  }))
}

const clearCurrentChat = async () => {
  if (activeTabIndex.value === 0) {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å Polza.ai?')) {
      // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é Polza.ai –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      const sessionId = localStorage.getItem('polza_session_id')
      if (sessionId) {
        try {
          await fetch(`${POLZA_CHAT_API_URL}/terminate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sessionId }),
          })
        } catch (error) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å Polza —Å–µ—Å—Å–∏—é:', error)
        }
        localStorage.removeItem('polza_session_id')
        polzaSessionId.value = null
      }

      aiChat.messages = [
        {
          text: getCombinedSystemPrompt(),
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          isUser: true,
        },
        {
          text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DronDoc –Ω–∞ –±–∞–∑–µ Polza.ai.\n–Ø –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ –æ—Ç—á—ë—Ç—ã, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ç.–¥.\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          isUser: false,
        },
      ]
      localStorage.removeItem('aiChat')
    }
  } else {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–≥–æ —á–∞—Ç–∞?')) {
      activeChat.messages = [
        {
          text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–∏–π —á–∞—Ç! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –∫–æ–ª–ª–µ–≥–∞–º–∏.',
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          isUser: false,
        },
      ]
    }
  }
}

const loadAllPages = async (baseUrl, id) => {
  let allData = null
  let page = 1
  let allRows = []

  while (true) {
    try {
      const url = page === 1 ? `${baseUrl}/${id}` : `${baseUrl}/${id}/page/${page}`
      const response = await apiClient.get(url)
      const data = response.data.response || response.data

      if (page === 1) {
        allData = { ...data }
      }

      if (data.rows && data.rows.length > 0) {
        allRows = [...allRows, ...data.rows]
        page++
      } else {
        break
      }
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${page}:`, error)
      break
    }
  }

  if (allData) {
    allData.rows = allRows
  }

  return allData
}

watch(selectedDataType, async newType => {
  if (!newType) {
    dataItems.value = []
    return
  }

  loadingDataItems.value = true
  try {
    const endpoint = newType.value === 'table' ? '/tables' : '/report'
    const response = await apiClient.get(endpoint)
    const data = response.data

    if (data.status === 200 && data.response) {
      if (newType.value === 'report' && data.response.rows) {
        dataItems.value = data.response.rows.map(row => ({
          id: row.id,
          name: row.values.find(v => v.headerId === 22)?.value || `–û—Ç—á–µ—Ç ${row.id}`,
          fullData: row
        }))
      } else {
        dataItems.value = Array.isArray(data.response) ? data.response : [data.response]
      }
    } else {
      dataItems.value = data.response || data
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error)
    dataItems.value = []
  } finally {
    loadingDataItems.value = false
  }
})

const attachData = async () => {
  if (!selectedDataItem.value) return

  // Show loading state
  loadingDataItems.value = true

  try {
    const itemName = selectedDataItem.value.name || selectedDataItem.value.value || selectedDataItem.value.id
    const itemType = selectedDataType.value.value

    // Phase 3: Check if MCP is enabled and authenticated for performance optimization
    const useMCPReference = toolsConfig.integramDatabaseEnabled &&
                            integraMCPState.isAuthenticated &&
                            itemType === 'table' // Only tables support MCP references for now

    let attachment

    if (useMCPReference) {
      // Phase 3: Use MCP reference instead of loading all data
      // This approach is 43x faster and uses 48x less memory
      console.log(`[Phase 3] Using MCP table reference for table ${selectedDataItem.value.id}`)

      // Get table metadata via MCP (lightweight operation - typically <200ms)
      const metadata = await integraMCPService.getTypeMetadata(selectedDataItem.value.id)

      attachment = {
        name: `[MCP] ${itemName}`,
        type: 'integram/table-reference', // New attachment type for Phase 3
        source: 'integram_mcp',
        itemId: selectedDataItem.value.id,
        itemName: itemName,
        itemType: 'table',
        // Store reference info instead of full data
        mcpReference: {
          typeId: selectedDataItem.value.id,
          tableName: itemName,
          rowCount: metadata.object_count || 0,
          columnCount: metadata.requisites?.length || 0,
          server: integraMCPState.serverURL,
          database: integraMCPState.database
        },
        // Lightweight metadata for display
        metadata: {
          id: metadata.id,
          name: metadata.name,
          requisites: metadata.requisites?.map(r => ({
            id: r.id,
            alias: r.alias || r.name,
            type: r.requisite_type_id
          })) || []
        },
        size: JSON.stringify(metadata).length // Size of metadata only, not full data
      }

      console.log(`[Phase 3] MCP reference created: ${attachment.mcpReference.rowCount} rows, ${attachment.mcpReference.columnCount} columns`)
    } else {
      // Fallback: Use traditional full data loading (Phases 1-2 behavior)
      console.log(`[Fallback] Loading full data for ${itemType} ${selectedDataItem.value.id}`)

      const baseUrl = itemType === 'table' ? '/tables' : '/report'
      const fullData = await loadAllPages(baseUrl, selectedDataItem.value.id)

      if (!fullData) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')
      }

      const jsonData = JSON.stringify(fullData, null, 2)
      const blob = new Blob([jsonData], { type: 'application/json' })
      const fileName = `${itemType}_${itemName}.json`

      attachment = {
        name: fileName,
        type: 'application/json',
        size: blob.size,
        data: jsonData,
        url: URL.createObjectURL(blob),
        source: 'api',
        itemId: selectedDataItem.value.id,
        itemName: itemName,
        itemType: itemType
      }

      console.log(`[Fallback] Full data loaded: ${blob.size} bytes`)
    }

    const messageText = dataComment.value || `–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: ${itemName}`

    if (activeTabIndex.value === 0) {
      currentAttachments.value.push(attachment)
    } else {
      activeChat.messages.push({
        text: messageText,
        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
        isUser: true,
        attachment,
      })
      scrollToBottom(messagesContainer)
    }

    showDataSelector.value = false
    selectedDataType.value = null
    selectedDataItem.value = null
    dataComment.value = ''
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error)
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message)
  } finally {
    // Hide loading state
    loadingDataItems.value = false
  }
}

const triggerFileUpload = () => fileInput.value?.click()
const triggerFileUploadGeneral = () => fileInputGeneral.value?.click()
const triggerModalFileUpload = () => modalFileInput.value?.click()

const handleFileUpload = (event) => handleFileUploadGeneric(event, true)
const handleFileUploadGeneral = (event) => handleFileUploadGeneric(event, false)
const handleModalFileUpload = (event) => handleFileUploadGeneric(event, activeTabIndex.value === 0)

const handleFileUploadGeneric = (event, isAiChat) => {
  const files = Array.from(event.target.files)
  if (!files.length) return

  uploadProgress.value = 0
  const totalFiles = files.length
  let processedFiles = 0

  files.forEach(file => {
    if (isAiChat && file.size > 5 * 1024 * 1024) {
      alert(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB`)
      return
    }

    const reader = new FileReader()
    
    reader.onloadstart = () => {
      uploadProgress.value = (processedFiles / totalFiles) * 100
    }
    
    reader.onload = (e) => {
      processedFiles++
      uploadProgress.value = (processedFiles / totalFiles) * 100
      
      const fileContent = e.target.result
      
      const attachment = {
        name: file.name,
        type: file.type,
        size: file.size,
        data: fileContent,
        url: URL.createObjectURL(file),
        source: 'file'
      }
      
      if (isAiChat) {
        currentAttachments.value.push(attachment)
      } else {
        activeChat.messages.push({
          text: `–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω —Ñ–∞–π–ª: ${file.name}`,
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          isUser: true,
          attachment,
        })
        scrollToBottom(messagesContainer)
      }

      if (processedFiles === totalFiles) {
        setTimeout(() => uploadProgress.value = 0, 1000)
      }
    }
    
    reader.onerror = () => {
      processedFiles++
      alert(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${file.name}`)
      if (processedFiles === totalFiles) uploadProgress.value = 0
    }
    
    if (isAiChat) {
      const allowedTypes = ['text/plain', 'application/json', 'text/csv', 'application/pdf', 'image/']
      if (!allowedTypes.some(type => file.type.includes(type.replace('application/', '').replace('text/', '')))) {
        alert('–î–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')
        return
      }
    }
    
    if (file.type.startsWith('image/')) {
      reader.readAsDataURL(file)
    } else {
      reader.readAsText(file, 'UTF-8')
    }
  })
  
  event.target.value = ''
}

const removeCurrentAttachment = (index) => {
  URL.revokeObjectURL(currentAttachments.value[index].url)
  currentAttachments.value.splice(index, 1)
}

const downloadAttachment = attachment => {
  if (attachment.source === 'api') {
    alert('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ')
    return
  }
  
  const link = document.createElement('a')
  link.href = attachment.url
  link.download = attachment.name
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
}

const showModal = () => {
  isModalVisible.value = true
  nextTick(() => {
    scrollToBottom(modalMessagesContainer)
  })
}

const hideModal = () => isModalVisible.value = false

const resetSettings = () => {
  llmSettings.contextSize = 8192
  llmSettings.gpuLayers = 100
  llmSettings.temperature = 0.6
  llmSettings.topK = 40
  llmSettings.topP = 0.9
  llmSettings.minP = 0.1
  llmSettings.repeatLastN = 64
  llmSettings.repeatPenalty = 1.0
  llmSettings.presencePenalty = 0.0
  llmSettings.frequencyPenalty = 0.0
  llmSettings.customTemplate = ''
  llmSettings.tensorBufferType = ''
  llmSettings.disableKVOffload = false
  llmSettings.batchSize = 512
  llmSettings.customSystemPrompt = ''
}

const SYSTEM_PROMPT = '–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç DronDoc –Ω–∞ –±–∞–∑–µ Polza.ai. –û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å JSON –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –†–∞–±–æ—Ç–∞–µ–º —Å —Ç–∞–±–ª–∏—Ü–µ–π: headers (id,value,type,isMain) –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫–æ–ª–æ–Ω–∫–∏, rows (id,values) —Å–æ–¥–µ—Ä–∂–∞—Ç —è—á–µ–π–∫–∏ —Å headerId –¥–ª—è —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã—Ö.'

// Helper function to combine default and custom system prompts
const getCombinedSystemPrompt = () => {
  let combined = SYSTEM_PROMPT
  if (llmSettings.customSystemPrompt && llmSettings.customSystemPrompt.trim()) {
    combined += '\n\n' + llmSettings.customSystemPrompt.trim()
  }
  return combined
}

// Demo response generator –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
const generateDemoResponse = (userMessage, model) => {
  const message = userMessage.toLowerCase();
  
  // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Ç–≤–µ—Ç
  if (message.includes('–ø—Ä–∏–≤–µ—Ç') || message.includes('hello') || message.includes('–¥–æ–±—Ä')) {
    return `–ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–±–æ—Ç–∞—é –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –Ω–∞ –±–∞–∑–µ ${model}. –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —è —Å–º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –∞–Ω–∞–ª–∏–∑–æ–º –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–±–ª–∏—Ü –∏ –æ—Ç—á—ë—Ç–æ–≤. –ü–æ–∫–∞ —á—Ç–æ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞!`;
  }
  
  if (message.includes('–ø–æ–º–æ—â—å') || message.includes('help') || message.includes('—á—Ç–æ —É–º–µ–µ—à—å')) {
    return `–Ø - –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ DronDoc –Ω–∞ –±–∞–∑–µ ${model}. –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —è —É–º–µ—é:
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ JSON –¥–∞–Ω–Ω—ã–µ
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞–º
‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å–∏—Å—Ç–µ–º
‚Ä¢ –†–∞–±–æ—Ç–∞—Ç—å —Å –¥—Ä–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

–ü–æ–∫–∞ —ç—Ç–æ –¥–µ–º–æ-—Ä–µ–∂–∏–º, –Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤!`;
  }
  
  if (message.includes('—Ç–∞–±–ª–∏—Ü') || message.includes('json') || message.includes('–¥–∞–Ω–Ω—ã–µ')) {
    return `–û—Ç–ª–∏—á–Ω–æ! –Ø –≤–∏–∂—É, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏. –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ –±–∞–∑–µ ${model} —è —Å–º–æ–≥—É:
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü (headers: id,value,type,isMain)
‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (rows: id,values —Å headerId)
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–¥–∫–∏ –∏ –æ—Ç—á—ë—Ç—ã
‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö

–°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞!`;
  }
  
  if (message.includes('–æ—Ç—á—ë—Ç') || message.includes('report') || message.includes('–∞–Ω–∞–ª–∏–∑')) {
    return `–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –æ—Ç—á—ë—Ç–∞–º–∏! –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ${model} —è —Å–æ–∑–¥–∞–º –¥–ª—è –≤–∞—Å:
‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã –ø–æ –¥–∞–Ω–Ω—ã–º –¥—Ä–æ–Ω–æ–≤
‚Ä¢ –°–≤–æ–¥–∫–∏ –ø–æ –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∞–º
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –ø—Ä–æ—Ü–µ—Å—Å–∞–º
‚Ä¢ –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ–∫–∞ —ç—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞!`;
  }
  
  if (message.includes('—Å–ø–∞—Å–∏–±') || message.includes('thanks')) {
    return `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥, —á—Ç–æ –¥–µ–º–æ-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç. –ö–æ–≥–¥–∞ Polza.ai API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, ${model} —Å–º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!`;
  }
  
  // –û–±—â–∏–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
  const responses = [
    `–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ –±–∞–∑–µ ${model} —è –¥–∞–º –≤–∞–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–∫–∞ —ç—Ç–æ –¥–µ–º–æ-—Ä–µ–∂–∏–º - API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞, –Ω–æ —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`,
    `–ü–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ö–æ–≥–¥–∞ ${model} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, —è —Å–º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.`,
    `–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –í —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ —è –ø–æ–º–æ–≥—É —Å –∞–Ω–∞–ª–∏–∑–æ–º. –°–µ–π—á–∞—Å –ø–æ–∫–∞–∑—ã–≤–∞—é, –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.`,
    `–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! ${model} –≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Å–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å —Ç–∞–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏. –ü–æ–∫–∞ —ç—Ç–æ –¥–µ–º–æ –≥–æ—Ç–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.`
  ];
  
  return responses[Math.floor(Math.random() * responses.length)];
};

const activeTabIndex = ref(0)
const messagesContainer = ref(null)
const modalMessagesContainer = ref(null)
const newMessage = ref('')
const activeChat = reactive({
  name: 'General Chat',
  messages: [
    {
      text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–∏–π —á–∞—Ç! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –∫–æ–ª–ª–µ–≥–∞–º–∏.',
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: false,
    },
    {
      text: '–ü—Ä–∏–≤–µ—Ç! –ö—Ç–æ-–Ω–∏–±—É–¥—å —Ä–∞–±–æ—Ç–∞–ª —Å PrimeVue?',
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: true,
    },
  ],
})

const aiMessagesContainer = ref(null)
const aiMessage = ref('')
const aiLoading = ref(false)
const aiError = ref(null)
const assistantMessage = ref(null)
const currentAttachments = ref([])
const aiChat = reactive({
  messages: JSON.parse(localStorage.getItem('aiChat')) || [
            {
          text: '–¢—ã —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å JSON –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:–†–∞–±–æ—Ç–∞–µ–º —Å —Ç–∞–±–ª–∏—Ü–µ–π: headers (id,value,type,isMain) –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∫–æ–ª–æ–Ω–∫–∏, rows (id,values) —Å–æ–¥–µ—Ä–∂–∞—Ç —è—á–µ–π–∫–∏ —Å headerId –¥–ª—è —Å–≤—è–∑–∏ –¥–∞–Ω–Ω—ã—Ö.',
          time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          isUser: true,
        },
    {
      text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DronDoc.\n–Ø –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ –æ—Ç—á—ë—Ç—ã, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ç.–¥.\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: false,
    },
  ],
})

// Polza.ai health check
const checkPolzaHealth = async () => {
  try {
    const response = await fetch(`${POLZA_CHAT_API_URL}/health`);
    
    if (!response.ok) {
      console.warn(`Polza.ai API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: HTTP ${response.status}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º.`);
      isApiAvailable.value = false;
      return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      console.warn('Polza.ai API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º.');
      isApiAvailable.value = false;
      return false;
    }
    
    const data = await response.json();
    logger.debug('Polza.ai Health:', data);
    isApiAvailable.value = true;
    return data.success === true;
  } catch (error) {
    console.warn('Polza.ai API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message, '- –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º');
    isApiAvailable.value = false;
    return false;
  }
};

// Get available Polza.ai models
const getAvailablePolzaModels = async () => {
  try {
    const response = await fetch(`${POLZA_CHAT_API_URL}/models`);
    
    if (!response.ok) {
      console.error(`Failed to fetch Polza models: HTTP ${response.status} ${response.statusText}`);
      return [];
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      console.error('Failed to fetch Polza models: Invalid content type:', contentType);
      return [];
    }
    
    const data = await response.json();
    if (data.success) {
      logger.debug('Available Polza models:', data.models);
      return data.models;
    }
    return [];
  } catch (error) {
    console.error('Failed to fetch Polza models:', error);
    return [];
  }
};

// Get available models from external API
const getExternalModels = async () => {
  try {
    const response = await fetch(getApiUrl('/api/ai-tokens/external-models'));
    
    if (!response.ok) {
      console.error(`Failed to fetch external models: HTTP ${response.status} ${response.statusText}`);
      return [];
    }
    
    const data = await response.json();
    if (data.success) {
      logger.debug('Available external models:', data.data);
      return data.data;
    }
    return [];
  } catch (error) {
    console.error('Failed to fetch external models:', error);
    return [];
  }
};

onMounted(async () => {
  scrollToBottom(aiMessagesContainer);
  scrollToBottom(messagesContainer);

  // Check Polza.ai connection
  const isHealthy = await checkPolzaHealth();
  
  // Combine models from both Polza.ai and external API
  let allModels = [];
  
  // Get Koda models first (independent of Polza.ai)
  const kodaModels = await getExternalModels();
  if (kodaModels.length > 0) {
    const kodaFormatted = kodaModels.map(model => ({
      name: `${model.name} (Koda)`,
      value: model.value,
      provider: model.provider
    }));
    allModels = [...allModels, ...kodaFormatted];
    logger.debug(`Koda API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª ${kodaModels.length} –º–æ–¥–µ–ª–µ–π`);
  }
  
  if (isHealthy) {
    const polzaModels = await getAvailablePolzaModels();
    if (polzaModels.length > 0) {
      const polzaFormatted = polzaModels.map(model => ({
        name: model.name || model.id,
        value: model.id || model.value,
        provider: model.provider || 'polza'
      }));
      allModels = [...allModels, ...polzaFormatted];
      logger.debug(`Polza.ai –ø–æ–¥–∫–ª—é—á–µ–Ω —Å ${polzaModels.length} –º–æ–¥–µ–ª—è–º–∏`);
    }
  }

  // If no models from any source, use fallback
  if (allModels.length === 0) {
    aiError.value = '–í—Å–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –†–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏.';
    const fallbackModels = [
      { name: 'Claude Sonnet 4.5', value: 'anthropic/claude-sonnet-4.5', provider: 'anthropic' },
      { name: 'GPT-5.1', value: 'openai/gpt-5.1', provider: 'openai' },
      { name: 'GPT-5.1 Chat', value: 'openai/gpt-5.1-chat', provider: 'openai' },
      { name: 'GPT-5.1 Codex', value: 'openai/gpt-5.1-codex', provider: 'openai' },
      { name: 'GPT-5.1 Codex Mini', value: 'openai/gpt-5.1-codex-mini', provider: 'openai' },
      { name: 'Nova Premier V1', value: 'amazon/nova-premier-v1', provider: 'amazon' },
      { name: 'Gemini 3 Pro Preview', value: 'google/gemini-3-pro-preview', provider: 'google' },
      { name: 'Kimi K2 Thinking', value: 'moonshotai/kimi-k2-thinking', provider: 'moonshotai' },
      { name: 'Sherlock Dash Alpha', value: 'openrouter/sherlock-dash-alpha', provider: 'openrouter' },
      { name: 'Sherlock Think Alpha', value: 'openrouter/sherlock-think-alpha', provider: 'openrouter' }
    ];
    allModels = fallbackModels;
    logger.debug('Using demo mode with fallback models');
  }

  // Note: availableModels is now managed by the ModelSelector component
  // No need to set it here as ModelSelector fetches models independently

  // Load workspaces if agent mode is enabled
  if (agentMode.value) {
    loadWorkspaces()
  }

  // Check Integram MCP connection (Phase 1)
  checkIntegrÿßŸÖMCPConnection()
});

const onExecutionComplete = (exec) => {
  logger.debug('Code execution completed:', exec)
}

const onExecutionError = (exec) => {
  logger.error('Code execution error:', exec)
}

// Workspace functions
const loadWorkspaces = async () => {
  if (!agentMode.value) return

  loadingWorkspaces.value = true
  try {
    // Use consistent user ID (same as WorkspaceAIAgent)
    // TODO: Get actual user ID from auth system
    const userId = currentUserId.value
    const loadedWorkspaces = await getUserWorkspaces(userId)
    workspaces.value = loadedWorkspaces
  } catch (error) {
    logger.error('Failed to load workspaces:', error)
  } finally {
    loadingWorkspaces.value = false
  }
}

const getWorkspaceName = (workspaceId) => {
  const workspace = workspaces.value.find(w => w.id === workspaceId)
  return workspace ? workspace.name : 'Unknown'
}

const createNewWorkspace = async () => {
  if (!newWorkspace.name.trim()) {
    createWorkspaceError.value = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ workspace'
    return
  }

  creatingWorkspace.value = true
  createWorkspaceError.value = null

  try {
    // Use consistent user ID (same as WorkspaceAIAgent)
    // TODO: Get actual user ID from auth system
    const userId = currentUserId.value
    const workspace = await createWorkspace(userId, {
      name: newWorkspace.name,
      repositoryUrl: newWorkspace.repositoryUrl || undefined,
      branch: newWorkspace.branch || undefined
    })

    workspaces.value.push(workspace)
    selectedWorkspace.value = workspace.id

    // Reset form
    newWorkspace.name = ''
    newWorkspace.repositoryUrl = ''
    newWorkspace.branch = 'main'
    showCreateWorkspaceDialog.value = false
  } catch (error) {
    logger.error('Failed to create workspace:', error)
    createWorkspaceError.value = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å workspace'
  } finally {
    creatingWorkspace.value = false
  }
}

// Watch agentMode to load workspaces when enabled
watch(agentMode, (newVal) => {
  if (newVal) {
    loadWorkspaces()
  }
})

onUnmounted(() => {
  currentAttachments.value.forEach(att => URL.revokeObjectURL(att.url));
  if (recognition.value) recognition.value.stop();
});

watch(
  () => [...aiChat.messages],
  newVal => {
    const messagesToSave = newVal.filter(msg => msg !== assistantMessage.value);
    localStorage.setItem('aiChat', JSON.stringify(messagesToSave));
  },
  { deep: true },
);

watch(activeTabIndex, () => {
  nextTick(() => {
    if (isModalVisible.value) {
      scrollToBottom(modalMessagesContainer);
    } else {
      if (activeTabIndex.value === 0) {
        scrollToBottom(aiMessagesContainer);
      } else {
        scrollToBottom(messagesContainer);
      }
    }
  });
});

const sendMessage = () => {
  if (newMessage.value.trim()) {
    activeChat.messages.push({
      text: newMessage.value,
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: true,
    });
    newMessage.value = '';
    scrollToBottom(messagesContainer);
    if (isModalVisible.value) {
      scrollToBottom(modalMessagesContainer);
    }
  }
};

/**
 * Phase 2: Chat with Integram MCP tool calling
 *
 * Calls the AI model with Integram MCP tools available.
 * The AI can then use tools like integram_get_dictionary, integram_get_object_list, etc.
 *
 * @param {string} userMessage - User's message
 * @param {Array} conversationHistory - Previous messages
 * @param {Object} options - Chat options (model, temperature, maxTokens)
 * @param {Function} onChunk - Callback for streaming chunks
 */
const chatWithIntegrÿßŸÖMCP = async (userMessage, conversationHistory, options, onChunk) => {
  const orchestratorURL = import.meta.env.VITE_ORCHESTRATOR_URL || 'https://dev.drondoc.ru'

  // Build system prompt with MCP usage guidelines (Phase 3: Table references support)
  const mcpSystemPrompt = `${getCombinedSystemPrompt()}

## Integram MCP Tools Available

You have access to Integram database tools via MCP (Model Context Protocol). Use these tools to query and manipulate data in the Integram database.

**Current Database Context:**
- Server: ${integraMCPState.serverURL}
- Database: ${integraMCPState.database}
- User: ${integraMCPState.username}

**Available Tools:**

1. **integram_get_dictionary()** - Get list of all tables (types)
   - Returns: Array of tables with { id, name, ... }

2. **integram_get_type_metadata(typeId)** - Get table schema
   - Parameters: typeId (number)
   - Returns: Table metadata with columns (requisites)

3. **integram_get_object_list(typeId, params)** - Get records from table
   - Parameters:
     - typeId (number)
     - params (object): { offset, limit, filter }
   - Returns: List of objects (records) with pagination

4. **integram_get_object_edit_data(objectId)** - Get single record details
   - Parameters: objectId (number)
   - Returns: Object with all field values

5. **integram_create_object(typeId, value, requisites)** - Create new record
   - Parameters:
     - typeId (number)
     - value (string) - object name
     - requisites (object) - field values { "fieldId": "value", ... }
   - Returns: Created object details

6. **integram_set_object_requisites(objectId, requisites)** - Update record
   - Parameters:
     - objectId (number)
     - requisites (object) - updated field values
   - Returns: Update result

7. **integram_delete_object(objectId)** - Delete record
   - Parameters: objectId (number)
   - Returns: Delete result

**üöÄ Phase 3: MCP Table References**

When the user attaches a table using the "üìé –¢–∞–±–ª–∏—Ü—ã/–æ—Ç—á—ë—Ç—ã" button with MCP enabled, you will receive a **table reference** instead of full data. This reference looks like:

\`\`\`json
{
  "type": "integram/table-reference",
  "mcpReference": {
    "typeId": 123,
    "tableName": "–ö–ª–∏–µ–Ω—Ç—ã",
    "rowCount": 10500,
    "columnCount": 8,
    "server": "https://dronedoc.ru",
    "database": "my"
  },
  "metadata": {
    "id": 123,
    "name": "–ö–ª–∏–µ–Ω—Ç—ã",
    "requisites": [
      { "id": 456, "alias": "–ù–∞–∑–≤–∞–Ω–∏–µ", "type": 3 },
      { "id": 457, "alias": "Email", "type": 3 },
      ...
    ]
  }
}
\`\`\`

**How to Work with Table References:**

1. **Recognize the reference**: Check if attachment.type === 'integram/table-reference'
2. **Extract typeId**: Use \`mcpReference.typeId\` for MCP tool calls
3. **Fetch data on-demand**: Use \`integram_get_object_list(typeId, { offset: 0, limit: 50 })\` to get first 50 rows
4. **Paginate if needed**: Adjust offset/limit to get more data
5. **Show schema**: Use \`metadata.requisites\` to display table structure

**Benefits of Table References:**
- ‚ö° **43x faster**: No need to load 10K+ rows into memory
- üíæ **48x less memory**: Only metadata is stored (~1KB vs 48MB for large tables)
- ü™ô **290x fewer tokens**: Reference uses ~500 tokens vs 145K for full data
- üöÄ **5.8x faster AI**: Less context = faster AI responses

**Example Workflow:**

User: "Analyze the –ö–ª–∏–µ–Ω—Ç—ã table"
1. Recognize table reference in attachments
2. Call \`integram_get_object_list(123, { offset: 0, limit: 100 })\` to get first 100 records
3. Analyze the data
4. If more data needed, fetch with different offset

User: "Find clients with email ending in @gmail.com"
1. Use \`integram_get_object_list(123, { filter: "email LIKE '%@gmail.com'" })\`
2. Or fetch in batches and filter programmatically

**Usage Guidelines:**
- Start with integram_get_dictionary() to explore available tables
- Use integram_get_type_metadata() to understand table structure before queries
- **NEW (Phase 3)**: When user attaches table via MCP, use reference instead of loading all data
- Use integram_get_object_list() with pagination to retrieve data on-demand
- Use create/update/delete tools when user requests data modifications
- Always show tool execution results to the user
- Format results in readable tables or lists

**Performance Best Practices:**
- Fetch data in batches (e.g., 50-100 rows at a time)
- Use filters and pagination to minimize data transfer
- Only fetch the data you need to answer the user's question
- Show row counts and schema info before fetching full data
`

  try {
    const response = await fetch(`${orchestratorURL}/api/mcp/integram/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: userMessage,
        conversationHistory: conversationHistory.map(msg => ({
          role: msg.role,
          content: msg.content
        })),
        systemPrompt: mcpSystemPrompt,
        model: options.model || 'deepseek-v3.2',
        temperature: options.temperature || 0.7,
        maxTokens: options.maxTokens || 4096,
        stream: true, // Request streaming response
        // MCP session context
        mcpContext: {
          serverURL: integraMCPState.serverURL,
          database: integraMCPState.database,
          username: integraMCPState.username
        }
      })
    })

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ error: 'Unknown error' }))
      throw new Error(errorData.error || `HTTP ${response.status}`)
    }

    // Handle non-streaming response (for Phase 2)
    // TODO: Add streaming support in Phase 3
    const data = await response.json()

    if (!data.success) {
      throw new Error(data.error || 'Integram MCP chat failed')
    }

    // Send the response as text chunks
    const responseText = data.response || ''
    if (responseText) {
      onChunk({ type: 'text', text: responseText })
    }

    // If there were tool calls, show summary
    if (data.toolCallsCount > 0) {
      const toolSummary = `\n\n‚úÖ **Executed ${data.toolCallsCount} MCP tool call(s)**\n`
      onChunk({ type: 'text', text: toolSummary })
    }
  } catch (error) {
    logger.error('Integram MCP chat error:', error)
    throw error
  }
}

const sendAiMessage = async () => {
  const message = aiMessage.value.trim()
  if ((!message && currentAttachments.value.length === 0) || aiLoading.value) return

  aiError.value = null
  aiLoading.value = true
  let lastUsage = null  // Track token usage for Integram transactions

  try {
    let finalMessage = message
  
    if (currentAttachments.value.length > 0) {
      finalMessage += `\n\n–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (${currentAttachments.value.length}):`
      currentAttachments.value.forEach(attachment => {
        if (attachment.type.startsWith('image/')) {
          finalMessage += `\n- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${attachment.name}`
        } else {
          finalMessage += `\n- ${attachment.name}:\n\`\`\`\n${attachment.data}\n\`\`\``
        }
      })
    }

    const userMessage = {
      text: message || `–ó–∞–ø—Ä–æ—Å —Å ${currentAttachments.value.length} —Ñ–∞–π–ª–æ–º(–∞–º–∏)`,
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: true,
      attachments: currentAttachments.value.length > 0 ? [...currentAttachments.value] : null,
    }
    aiChat.messages.push(userMessage)
    aiMessage.value = ''
    
    scrollToBottom(aiMessagesContainer)
    if (isModalVisible.value) {
      scrollToBottom(modalMessagesContainer)
    }

    assistantMessage.value = {
      text: '',
      time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
      isUser: false,
    }
    aiChat.messages.push(assistantMessage.value)

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ —É—Å—Ç–∞—Ä–µ–ª–∞
    let sessionId = localStorage.getItem('polza_session_id')
    if (!sessionId || polzaSessionId.value === null) {
      console.log('–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é Polza.ai...')

      const sessionResponse = await fetch(`${POLZA_CHAT_API_URL}/session`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          systemPrompt: getCombinedSystemPrompt(),
          model: selectedModel.value,
          userId: currentUserId.value // Use real user ID for token tracking
        }),
      })

      if (!sessionResponse.ok) {
        const errorText = await sessionResponse.text()
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏:', sessionResponse.status, errorText)
        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é: ${sessionResponse.status}`)
      }

      const sessionData = await sessionResponse.json()
      if (!sessionData.success || !sessionData.sessionId) {
        console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Å—Å–∏–∏:', sessionData)
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏')
      }

      sessionId = sessionData.sessionId
      polzaSessionId.value = sessionId
      localStorage.setItem('polza_session_id', sessionId)
      console.log('–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞:', sessionId)

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –≤ Integram (Issue: Session Tracking)
      try {
        const tokenId = localStorage.getItem('current_ai_token_id') || '206099'
        integramChatSessionService.setCurrentToken(tokenId)
        await integramChatSessionService.createSession({
          sessionId: sessionId,
          model: selectedModel.value,
          systemPrompt: getCombinedSystemPrompt() || ''
        })
        console.log('[Chat] Session saved to Integram:', sessionId)
      } catch (integramError) {
        console.warn('[Chat] Failed to save session to Integram:', integramError)
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É –µ—Å–ª–∏ Integram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      }
    } else {
      // –°–µ—Å—Å–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –æ–Ω–∞ –µ—Å—Ç—å –≤ –∫—ç—à–µ Integram
      polzaSessionId.value = sessionId
      console.log('[Chat] Using existing session:', sessionId)

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –≤ Integram –∫—ç—à–µ
      try {
        const tokenId = localStorage.getItem('current_ai_token_id') || '206099'
        integramChatSessionService.setCurrentToken(tokenId)

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–µ—Å—Å–∏—è –≤ –∫—ç—à–µ, –µ—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë–º
        if (!integramChatSessionService.sessionsCache.has(sessionId)) {
          console.log('[Chat] Session not in Integram cache, creating...')
          await integramChatSessionService.createSession({
            sessionId: sessionId,
            model: selectedModel.value,
            systemPrompt: getCombinedSystemPrompt() || ''
          })
          console.log('[Chat] Session restored in Integram:', sessionId)
        }
      } catch (integramError) {
        console.warn('[Chat] Failed to restore session in Integram:', integramError)
      }
    }

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const messages = aiChat.messages
      .filter(msg => {
        if (msg === assistantMessage.value) return false
        if (msg === userMessage) return false
        if (isSystemMessage(msg)) return false
        if (!msg.text || msg.text.trim() === '') return false
        return true
      })
      .map(msg => ({
        role: msg.isUser ? 'user' : 'assistant',
        content: String(msg.text).trim()
      }))

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    messages.push({
      role: 'user',
      content: finalMessage
    })

    // Check if we should use workspace tool calling (agent mode + workspace selected)
    // IMPORTANT: Only use workspace chat if BOTH agent mode is enabled AND workspace is selected
    // AND the model is an Anthropic Claude model that supports tool calling
    const modelName = String(selectedModel.value || '').toLowerCase()
    const isClaudeModel = modelName.includes('claude') || modelName.includes('anthropic')
    const useWorkspace = agentMode.value && selectedWorkspace.value && isClaudeModel

    // Phase 2: Check if we should use Integram MCP tool calling
    // Use MCP mode when: Integram DB is enabled AND authenticated AND agent mode is on
    const useMCP = toolsConfig.integramDatabaseEnabled &&
                   integraMCPState.isAuthenticated &&
                   agentMode.value

    // Log the decision for debugging
    logger.debug('Chat routing decision', {
      agentMode: agentMode.value,
      selectedWorkspace: selectedWorkspace.value,
      isClaudeModel,
      useWorkspace,
      useMCP,
      integramAuthenticated: integraMCPState.isAuthenticated,
      model: selectedModel.value,
      hasAttachments: currentAttachments.value.length > 0
    })

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    const isKodaModel = modelName.includes('(koda)')
    const isPolzaModel = !isKodaModel && !isClaudeModel // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ - Polza –º–æ–¥–µ–ª–∏

    let response

    if (useWorkspace) {
      // Use workspace tool calling for agent mode with Claude
      logger.info('Using workspace tool calling with Claude', {
        workspaceId: selectedWorkspace.value,
        model: selectedModel.value,
        fileAttachments: currentAttachments.value.length
      })

      try {
        // Stream workspace chat response
        await chatWithWorkspace(
          selectedWorkspace.value,
          finalMessage,
          messages,
          {
            model: selectedModel.value,
            temperature: llmSettings.temperature,
            maxTokens: 4096,
            enableTools: toolsConfig.codeInterpreterEnabled || toolsConfig.searchEnabled,
            systemPrompt: getCombinedSystemPrompt() // Ensure system prompt is passed
          },
          (chunk) => {
            // Handle streaming chunks
            if (chunk.type === 'text') {
              assistantMessage.value.text += chunk.text
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'tool_use') {
              // Show tool execution in message
              const toolInfo = `\n\nüîß **Executing tool:** ${chunk.toolName}\n\`\`\`json\n${JSON.stringify(chunk.toolInput, null, 2)}\n\`\`\`\n`
              assistantMessage.value.text += toolInfo
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'tool_execution') {
              // Show tool result
              const resultInfo = `\n**Tool result:**\n\`\`\`\n${chunk.result}\n\`\`\`\n`
              assistantMessage.value.text += resultInfo
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'warning') {
              logger.warn('Workspace chat warning:', chunk.message)
            } else if (chunk.type === 'error') {
              logger.error('Workspace chat error:', chunk.error)
              throw new Error(chunk.error)
            }
          }
        )
      } catch (error) {
        logger.error('Workspace chat error:', error)
        // Fall back to regular Polza/Koda chat if workspace chat fails
        aiError.value = `–û—à–∏–±–∫–∞ workspace chat: ${error.message}. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.`
        throw new Error(`Workspace chat failed: ${error.message}`)
      }
    } else if (useMCP) {
      // Phase 2: Use Integram MCP tool calling mode
      logger.info('Using Integram MCP mode', {
        database: integraMCPState.database,
        model: selectedModel.value,
        isAuthenticated: integraMCPState.isAuthenticated
      })

      try {
        // Call AI with MCP tool support via orchestrator
        await chatWithIntegrÿßŸÖMCP(
          finalMessage,
          messages,
          {
            model: selectedModel.value,
            temperature: llmSettings.temperature,
            maxTokens: 4096
          },
          (chunk) => {
            // Handle streaming chunks
            if (chunk.type === 'text') {
              assistantMessage.value.text += chunk.text
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'tool_use') {
              // Show Integram MCP tool execution
              const toolInfo = `\n\nüóÑÔ∏è **Integram MCP Tool:** ${chunk.toolName}\n\`\`\`json\n${JSON.stringify(chunk.toolInput, null, 2)}\n\`\`\`\n`
              assistantMessage.value.text += toolInfo
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'tool_result') {
              // Show Integram MCP tool result
              const resultPreview = typeof chunk.result === 'string'
                ? chunk.result.substring(0, 500)
                : JSON.stringify(chunk.result, null, 2).substring(0, 500)
              const resultInfo = `\n**–†–µ–∑—É–ª—å—Ç–∞—Ç:**\n\`\`\`json\n${resultPreview}${chunk.result.length > 500 ? '...' : ''}\n\`\`\`\n`
              assistantMessage.value.text += resultInfo
              scrollToBottom(aiMessagesContainer)
              if (isModalVisible.value) {
                scrollToBottom(modalMessagesContainer)
              }
            } else if (chunk.type === 'error') {
              logger.error('Integram MCP error:', chunk.error)
              throw new Error(chunk.error)
            }
          }
        )
      } catch (error) {
        logger.error('Integram MCP chat error:', error)
        aiError.value = `–û—à–∏–±–∫–∞ Integram MCP: ${error.message}`
        throw new Error(`Integram MCP chat failed: ${error.message}`)
      }
    } else if (isKodaModel) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Koda API –¥–ª—è Koda –º–æ–¥–µ–ª–µ–π
      console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º Koda API –¥–ª—è –º–æ–¥–µ–ª–∏:', selectedModel.value)
      
      const externalMessages = messages.map(msg => ({
        role: msg.role,
        content: msg.content
      }))

      response = await fetch('/api/ai-tokens/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: selectedModel.value.replace(' (Koda)', ''), // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä Koda –º–æ–¥–µ–ª–∏
          messages: externalMessages,
          temperature: 0.7,
          max_tokens: 2048,
          provider: 'external'
        }),
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}))
        throw new Error(errorData.error || `Koda API –≤–µ—Ä–Ω—É–ª ${response.status}: ${response.statusText}`)
      }

      const data = await response.json()
      if (!data.success) {
        throw new Error(data.error || '–û—à–∏–±–∫–∞ Koda API')
      }

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç –∏–∑ Koda API —Ñ–æ—Ä–º–∞—Ç–∞
      const responseText = data.data.choices?.[0]?.message?.content || 
                          data.data.choices?.[0]?.text || 
                          '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Koda API.'
      
      assistantMessage.value.text = responseText

    } else {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Polza.ai
      if (!isApiAvailable.value) {
        // –î–µ–º–æ-—Ä–µ–∂–∏–º: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        console.log('–†–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ');
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000)); // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏

        const demoResponse = generateDemoResponse(finalMessage, selectedModel.value);
        assistantMessage.value.text = demoResponse;
      } else {
        // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Polza.ai API —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π streaming
        response = await fetch(`${POLZA_CHAT_API_URL}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionId: sessionId,
            message: finalMessage,
            model: selectedModel.value,
            temperature: 0.7,
            maxTokens: 2048,
            attachments: currentAttachments.value.length > 0 ? currentAttachments.value : [],
            stream: true  // Enable streaming
          }),
        })

        if (!response.ok) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            console.warn('Polza.ai API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–æ—Ç–≤–µ—Ç');
            const demoResponse = generateDemoResponse(finalMessage, selectedModel.value);
            assistantMessage.value.text = demoResponse;
          } else {
            const errorData = await response.json()
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`)
          }
        } else {
          // Check if response is streaming (SSE)
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('text/event-stream')) {
            // Handle SSE streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;

              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || ''; // Keep incomplete line in buffer

              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.substring(6);

                  try {
                    const chunk = JSON.parse(data);

                    if (chunk.type === 'content') {
                      // Append content character by character
                      assistantMessage.value.text += chunk.content;

                      // Scroll to bottom after each chunk
                      scrollToBottom(aiMessagesContainer);
                      if (isModalVisible.value) {
                        scrollToBottom(modalMessagesContainer);
                      }
                    } else if (chunk.type === 'done') {
                      console.log('Streaming completed. Usage:', chunk.usage);
                      lastUsage = chunk.usage  // Save usage for Integram transaction
                    } else if (chunk.error) {
                      throw new Error(chunk.error);
                    }
                  } catch (parseError) {
                    console.warn('Failed to parse SSE chunk:', data);
                  }
                }
              }
            }
          } else if (contentType && contentType.includes('application/json')) {
            // Fallback to non-streaming response
            const data = await response.json()
            if (!data.success) {
              throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ Polza.ai')
            }
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç API
            assistantMessage.value.text = data.response;
          } else {
            // Fallback –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
            console.warn('Polza.ai API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–æ—Ç–≤–µ—Ç');
            const demoResponse = generateDemoResponse(finalMessage, selectedModel.value);
            assistantMessage.value.text = demoResponse;
          }
        }
      }
    }
    
    const finalMessageObj = { ...assistantMessage.value }
    aiChat.messages.splice(aiChat.messages.indexOf(assistantMessage.value), 1, finalMessageObj)
    assistantMessage.value = null

    // Agent mode: Detect and handle code execution
    if (agentMode.value && toolsConfig.codeInterpreterEnabled && finalMessageObj.text) {
      handleCodeExecution(finalMessageObj.text)
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Integram –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ (Issue: Session Tracking)
    if (polzaSessionId.value) {
      try {
        const messagesToSave = aiChat.messages
          .filter(msg => !isSystemMessage(msg) && msg.text)
          .map(msg => ({
            role: msg.isUser ? 'user' : 'assistant',
            content: msg.text,
            timestamp: new Date().toISOString()
          }))
        await integramChatSessionService.updateMessages(polzaSessionId.value, messagesToSave)
        console.log('[Chat] Messages saved to Integram')

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
        // Issue: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ usage –Ω–µ –ø—Ä–∏—à—ë–ª - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç
        if (finalMessageObj.text) {
          // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ –µ—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª usage
          // ~4 —Å–∏–º–≤–æ–ª–∞ = 1 —Ç–æ–∫–µ–Ω –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ/–∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
          const estimatedInputTokens = lastUsage?.prompt_tokens || Math.ceil(message.length / 4)
          const estimatedOutputTokens = lastUsage?.completion_tokens || Math.ceil(finalMessageObj.text.length / 4)

          await integramChatSessionService.saveMessageExchange({
            sessionId: polzaSessionId.value,
            userMessage: message,
            assistantMessage: finalMessageObj.text,
            model: selectedModel.value,
            inputTokens: estimatedInputTokens,
            outputTokens: estimatedOutputTokens,
            cost: lastUsage?.cost || 0,
            systemPrompt: getCombinedSystemPrompt() || ''
          })
          console.log('[Chat] Transaction saved to Integram. Usage from API:', !!lastUsage,
            'Input tokens:', estimatedInputTokens, 'Output tokens:', estimatedOutputTokens)
        }
      } catch (integramError) {
        console.warn('[Chat] Failed to save to Integram:', integramError)
      }
    }

    currentAttachments.value.forEach(att => URL.revokeObjectURL(att.url))
    currentAttachments.value = []

  } catch (error) {
    aiError.value = error.message
    console.error('–û—à–∏–±–∫–∞ Polza.ai:', error)
    if (assistantMessage.value) {
      aiChat.messages = aiChat.messages.filter(msg => msg !== assistantMessage.value)
      assistantMessage.value = null
    }
  } finally {
    aiLoading.value = false
    uploadProgress.value = 0
    scrollToBottom(aiMessagesContainer)
    if (isModalVisible.value) {
      scrollToBottom(modalMessagesContainer)
    }
  }
}

const transferToEditor = content => {
  window.dispatchEvent(
    new CustomEvent('insert-ai-content', {
      detail: { content },
    }),
  );
};

const scrollToBottom = container => {
  nextTick(() => {
    if (container.value) {
      container.value.scrollTop = container.value.scrollHeight;
    }
  });
};

const chatWidth = ref(parseInt(localStorage.getItem('chatWidth')) || 320);
const isResizing = ref(false);

const startResize = (e) => {
  isResizing.value = true;
  document.addEventListener('mousemove', handleResize);
  document.addEventListener('mouseup', stopResize);
  e.preventDefault();
};

const handleResize = (e) => {
  if (!isResizing.value) return;
  const newWidth = window.innerWidth - e.clientX;
  if (newWidth >= 280 && newWidth <= 800) {
    chatWidth.value = newWidth;
  }
};

const stopResize = () => {
  if (isResizing.value) {
    isResizing.value = false;
    localStorage.setItem('chatWidth', chatWidth.value.toString());
    document.removeEventListener('mousemove', handleResize);
    document.removeEventListener('mouseup', stopResize);
  }
};

// ========== Integram MCP Functions (Phase 1) ==========

const checkIntegrÿßŸÖMCPConnection = () => {
  const status = integraMCPService.getConnectionStatus()
  Object.assign(integraMCPState, status)
  return status
}

const handleIntegr‡§æ‡§ÆMCPAuth = async () => {
  integramAuthLoading.value = true
  integramAuthError.value = null

  try {
    const result = await integraMCPService.authenticate({
      serverURL: integramAuthForm.serverURL,
      database: integramAuthForm.database,
      login: integr‡¶æ‡¶ÆAuthForm.login,
      password: integramAuthForm.password
    })

    if (result.success) {
      // Update state
      checkIntegrÿßŸÖMCPConnection()

      // Close dialog
      showIntegrÿßŸÖMCPAuth.value = false

      // Clear password
      integramAuthForm.password = ''

      // Show success notification
      console.log('‚úÖ Integram MCP authenticated:', result)
    }
  } catch (error) {
    integramAuthError.value = error.message
    console.error('‚ùå Integram MCP authentication failed:', error)
  } finally {
    integramAuthLoading.value = false
  }
}

const handleIntegr–∞–ºMCPLogout = () => {
  integraMCPService.logout()
  checkIntegrÿßŸÖMCPConnection()
  integr’°’¥AuthForm.password = ''
}

const testIntegrÿßŸÖMCP = async () => {
  try {
    console.log('üß™ Testing Integram MCP with getDictionary...')
    const result = await integraMCPService.getDictionary()
    console.log('‚úÖ Integram MCP test successful:', result)
    return result
  } catch (error) {
    console.error('‚ùå Integram MCP test failed:', error)
    throw error
  }
}

onUnmounted(() => {
  document.removeEventListener('mousemove', handleResize);
  document.removeEventListener('mouseup', stopResize);
});
</script>

<style scoped lang="scss">
.resize-handle {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  cursor: ew-resize;
  background: transparent;
  z-index: 1000;
  transition: background 0.2s;

  &:hover {
    background: var(--primary-color);
  }

  &:active {
    background: var(--primary-color);
  }
}

.quick-prompts {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--surface-border);
  
  :deep(.p-button) {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}

.message-actions, .modal-message-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.5rem;
  
  .action-buttons {
    display: flex;
    gap: 0.25rem;
  }
}

.voice-btn {
  &.recording {
    animation: pulse 1s infinite;
    color: var(--red-500) !important;
  }
}

.upload-progress {
  padding: 0.5rem;
  background: var(--surface-ground);
  border-top: 1px solid var(--surface-border);
  
  span {
    font-size: 0.75rem;
    display: block;
    text-align: center;
    margin-top: 0.25rem;
  }
}

.image-preview {
  max-width: 200px;
  max-height: 150px;
  cursor: pointer;
  border-radius: 4px;
}

.image-preview-small {
  max-width: 40px;
  max-height: 40px;
  border-radius: 4px;
}

.preview-image {
  max-width: 100%;
  max-height: 70vh;
}

.history-dialog {
  .chat-list {
    max-height: 300px;
    overflow-y: auto;
    
    .chat-item {
      display: flex;
      justify-content: between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--surface-border);
      
      .chat-actions {
        display: flex;
        gap: 0.25rem;
        margin-left: auto;
      }
    }
  }
}

.card {
  display: flex;
  flex-direction: column;
}

.tabview-container {
  position: relative;
  height: 100%;
}

.expand-button-container {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  z-index: 10;
  display: flex;
  gap: 0.25rem;
  
  .expand-button {
    width: 2rem;
    height: 2rem;
    padding: 0;
  }
}

.chat-container {
  display: flex;
  flex-direction: column;
  background-color: var(--surface-card);
  border-radius: 12px;
  height: 100%;
  position: relative;
}

.messages {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding-bottom: 80px;
  
  .message {
    gap: 0.5rem;
    align-items: flex-start;
    margin: 0.25rem 0.5rem;
    display: flex;
    
    &.user-message {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message-content {
      background: var(--surface-ground);
      padding: 0.5rem;
      border-radius: 12px;
      box-shadow: var(--shadow-1);
      position: relative;
      
      .attachment-info {
        .attachment-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem;
          background: var(--surface-100);
          border-radius: 4px;
          margin-bottom: 0.5rem;
          font-size: 0.875rem;
          
          &:last-child {
            margin-bottom: 0;
          }
          
          .pi-file, .pi-database { 
            color: var(--primary-color); 
          }
          
          .file-size, .api-id {
            font-size: 0.75rem;
            opacity: 0.7;
          }
        }
      }
      
      .message-text {
        margin-bottom: 0.5rem;
        white-space: pre-wrap;
      }
      
      .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
      }
      
      .transfer-button {
        width: 24px;
        height: 24px;
      }
    }
    
    &.user-message .message-content {
      background: var(--primary-color);
      color: var(--primary-color-text);
    }
  }
}

.input-container {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--surface-ground);
  border-radius: 12px;
  margin-top: auto;
  box-shadow: var(--shadow-2);
  align-items: center;
  position: sticky;
  bottom: 0;
  z-index: 10;
  
  .input-field {
    flex: 1;
    min-width: 0;
    width: 100%;
    height: 35px;
  }
}

.current-attachments {
  padding: 0 0.5rem 0.5rem;
  
  .current-attachment {
    margin-bottom: 0.25rem;
    
    .attachment-info.current {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: var(--surface-100);
      border-radius: 4px;
      font-size: 0.875rem;
    }
  }
}

.loading-indicator {
  display: flex;
  justify-content: center;
  padding: 1rem;
}

.error-message {
  color: var(--red-500);
  padding: 0.5rem;
  background: var(--red-50);
  border-radius: 4px;
  margin: 0.5rem;
  text-align: left;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 0.85rem;
  line-height: 1.5;
  max-width: 100%;
  overflow-x: auto;
}

.streaming-cursor::after {
  content: '|';
  animation: blink 1s infinite;
  color: var(--primary-color);
}

.attachment-menu {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  min-width: 150px;
  
  :deep(.p-button) {
    justify-content: flex-start;
  }
}

.modal-chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
}

.modal-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-height: 0;
  
  .modal-message {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    max-width: 85%;
    
    &.modal-user-message {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .modal-message-content {
      background: var(--surface-ground);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      box-shadow: var(--shadow-1);
      position: relative;
      word-break: break-word;
      max-width: 100%;
      
      .modal-attachment-info {
        .attachment-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem;
          background: var(--surface-100);
          border-radius: 4px;
          margin-bottom: 0.5rem;
          font-size: 0.875rem;
          
          &:last-child {
            margin-bottom: 0;
          }
          
          .pi-file, .pi-database { 
            color: var(--primary-color); 
          }
          
          .file-size, .api-id {
            font-size: 0.75rem;
            opacity: 0.7;
          }
        }
      }
      
      .modal-message-text {
        :deep(p) { margin: 0; }
        :deep(pre) {
          white-space: pre-wrap;
          background: var(--surface-100);
          padding: 0.5rem;
          border-radius: 4px;
          overflow-x: auto;
        }
      }
      
      .modal-message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        text-align: right;
      }
    }
    
    &.modal-user-message .modal-message-content {
      background: var(--primary-color);
      color: var(--primary-color-text);
    }
  }
}

.modal-controls {
  flex-shrink: 0;
  background: var(--surface-ground);
  border-top: 1px solid var(--surface-border);
}

.model-selector-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem 0.5rem;
  border-bottom: 1px solid var(--surface-border);

  label {
    font-weight: 500;
    white-space: nowrap;
  }

  .model-dropdown {
    flex: 1;
    min-width: 0;
  }

  .settings-btn, .tools-btn {
    width: 2.5rem;
    height: 2.5rem;
    padding: 0;
  }
}

.modal-input-container {
  flex-shrink: 0;
  display: flex;
  gap: 0.75rem;
  padding: 0.75rem 1rem 1rem;

  .modal-input-field {
    flex: 1;
    min-width: 0;
  }
}

.modal-loading-indicator {
  display: flex;
  justify-content: center;
  padding: 1rem;
}

.modal-error-message {
  color: var(--red-500);
  padding: 0.75rem;
  background: var(--red-50);
  border-radius: 6px;
  margin: 0.5rem;
  text-align: left;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 0.85rem;
  line-height: 1.5;
  max-width: 100%;
  overflow-x: auto;
}

.data-selector-dialog {
  .field {
    margin-bottom: 1rem;

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
  }
}

.settings-dialog {
  max-height: 60vh;
  overflow-y: auto;

  .field {
    margin-bottom: 1.5rem;

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    small {
      display: block;
      margin-top: 0.25rem;
      opacity: 0.7;
      font-size: 0.75rem;
    }
  }
}

.tools-dialog {
  .field {
    margin-bottom: 1rem;

    label {
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }
  }

  .agent-mode-toggle {
    background: rgba(var(--primary-500), 0.1);
    padding: 1rem;
    border-radius: 8px;

    label {
      font-size: 1.1rem;
    }
  }

  .agent-info {
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--surface-ground);
    border-radius: 4px;
    border-left: 3px solid var(--primary-color);

    i {
      margin-right: 0.5rem;
      color: var(--primary-color);
    }
  }
}

:deep(.p-tabview) {
  height: 100%;
  display: flex;
  flex-direction: column;
  
  .p-tabview-panels {
    flex: 1;
    min-height: 0;
    position: relative;
    padding: 0 0 0;
    
    .p-tabview-panel {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  }
  
  .p-button {
    width: 2rem;
    height: 2rem;
    padding: 0;
    
    .pi { font-size: 1rem; }
  }
  
  .p-inputtext {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .p-avatar { aspect-ratio: 1/1; flex-shrink: 0; }
  
  .p-tabview-nav { position: relative; }
  .p-tabview-nav-link { padding: 0.75rem 1rem; }
  .p-tabview-ink-bar {
    background-color: var(--primary-color);
    height: 2px;
    display: block !important;
  }
}

.modal-messages::-webkit-scrollbar,
.messages::-webkit-scrollbar {
  width: 8px;
  
  &-track { background: var(--surface-ground); }
  &-thumb {
    background: var(--surface-border);
    border-radius: 4px;
    
    &:hover { background: var(--text-color-secondary); }
  }
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

@media screen and (max-width: 960px) {
  :deep(.p-dialog) { width: 75vw !important; }
  .modal-message { max-width: 90%; }
}

@media screen and (max-width: 640px) {
  :deep(.p-dialog) {
    width: 90vw !important;
    height: 90vh !important;
  }
  
  .modal-message { max-width: 95%; }
  .modal-message-content { padding: 0.5rem 0.75rem; }
  .modal-input-container { padding: 0.75rem; }
  
  .message {
    flex-direction: column;
    align-items: flex-start;
    
    &.user-message { align-items: flex-end; }
    
    .message-content { max-width: 90%; }
  }
  
}

.polza-agents-info {
  padding: 2rem;
  text-align: left;
  
  h3 {
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.5rem;
  }
  
  p {
    margin-bottom: 1rem;
    line-height: 1.6;
  }
  
  ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
    
    li {
      margin-bottom: 0.5rem;
      line-height: 1.5;
      
      strong {
        color: var(--primary-color);
      }
    }
  }
  
  em {
    color: var(--text-color-secondary);
    font-style: italic;
  }
}

/* Utility classes for theme-aware colors */
.status-text {
  font-size: 0.75rem;
  color: var(--text-color);
}

.success-icon {
  color: var(--green-500);
}

.warning-icon {
  color: var(--orange-500);
}

.error-icon {
  color: var(--red-500);
}

/* Session history styles */
.history-dialog {
  .chat-list {
    max-height: 400px;
    overflow-y: auto;
  }

  .chat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    background: var(--surface-50);
    border: 1px solid var(--surface-200);
    transition: all 0.2s;

    &:hover {
      background: var(--surface-100);
      border-color: var(--primary-color);
    }

    .chat-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;

      strong {
        color: var(--text-color);
      }

      small {
        color: var(--text-color-secondary);
        font-size: 0.85rem;
      }
    }

    .chat-actions {
      display: flex;
      gap: 0.25rem;
    }
  }

  .text-muted {
    color: var(--text-color-secondary);
  }
}

/* Edit message dialog */
.edit-message-dialog {
  :deep(.p-inputtextarea) {
    font-family: inherit;
    font-size: 0.95rem;
  }
}

/* Message action buttons */
.message-actions {
  .action-buttons {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .message:hover & .action-buttons {
    opacity: 1;
  }

  .edit-button,
  .delete-button {
    &:hover {
      background: var(--surface-100);
    }
  }

  .delete-button:hover {
    color: var(--red-500);
  }
}
</style>
