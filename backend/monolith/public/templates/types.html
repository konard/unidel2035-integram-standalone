<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Type Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 1rem; background: #f8f9fa; }
    .req-row { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .accordion-button { font-weight: 600; }
  </style>
</head>
<body>

<div class="d-flex align-items-center mb-3 gap-2">
  <h5 class="mb-0">Type Editor</h5>
  <button class="btn btn-sm btn-primary ms-auto" id="btnNewType">+ New Type</button>
</div>

<div id="alertBox" class="alert d-none" role="alert"></div>

<div class="accordion" id="typeAccordion"></div>

<!-- Modal: add requisite -->
<div class="modal fade" id="reqModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">Add Column</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="reqTypeId">
        <div class="mb-3">
          <label class="form-label">Column name</label>
          <input type="text" class="form-control" id="reqName">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnAddReq">Add</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ── API helpers ───────────────────────────────────────────────────────────────
const params = new URLSearchParams(location.search);
const db     = params.get('db') || '';

function getSession() {
  return {
    token: localStorage.getItem(`${db}_token`) || '',
    xsrf:  localStorage.getItem(`${db}_xsrf`)  || '',
  };
}
function redirectLogin() {
  top.location.href = `login.html?db=${encodeURIComponent(db)}`;
}
async function api(method, path, body) {
  const opts = { method, credentials: 'include', headers: {} };
  if (body) {
    opts.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    opts.body = new URLSearchParams(body).toString();
  }
  const res = await fetch(path, opts);
  if (res.status === 401) { redirectLogin(); return null; }
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { error: text }; }
}
function showAlert(msg, type = 'danger') {
  const box = document.getElementById('alertBox');
  box.className = `alert alert-${type}`;
  box.textContent = msg;
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Load types ────────────────────────────────────────────────────────────────
async function loadTypes() {
  const data = await api('GET', `/${db}/terms?JSON`);
  if (!data) return;
  const types = Array.isArray(data) ? data : (data.types || data.data || []);

  const accordion = document.getElementById('typeAccordion');
  accordion.innerHTML = '';

  for (const t of types) {
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.id = `type-${t.id}`;
    item.innerHTML = `
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapse-${t.id}">
          <span class="me-2">${escHtml(t.name || t.val || t.id)}</span>
          <span class="badge bg-secondary">id:${t.id}</span>
        </button>
      </h2>
      <div id="collapse-${t.id}" class="accordion-collapse collapse" data-type-id="${t.id}">
        <div class="accordion-body p-2">
          <div class="mb-2">
            <button class="btn btn-sm btn-outline-primary btn-add-req" data-type-id="${t.id}">+ Add column</button>
          </div>
          <div class="req-list" id="reqs-${t.id}"><span class="text-muted small">Loading…</span></div>
        </div>
      </div>`;
    accordion.appendChild(item);

    // Load requisites when accordion opens
    item.querySelector(`#collapse-${t.id}`).addEventListener('show.bs.collapse', () => {
      loadReqs(t.id);
    });
    item.querySelector('.btn-add-req').addEventListener('click', () => {
      document.getElementById('reqTypeId').value = t.id;
      document.getElementById('reqName').value = '';
      new bootstrap.Modal(document.getElementById('reqModal')).show();
    });
  }
}

// ── Load requisites ───────────────────────────────────────────────────────────
async function loadReqs(typeId) {
  const container = document.getElementById(`reqs-${typeId}`);
  container.innerHTML = '<span class="text-muted small">Loading…</span>';
  const data = await api('GET', `/${db}/metadata/${typeId}?JSON`);
  if (!data) return;
  const reqs = Array.isArray(data) ? data : (data.reqs || data.fields || data.data || []);
  if (reqs.length === 0) {
    container.innerHTML = '<span class="text-muted small">No columns.</span>';
    return;
  }
  container.innerHTML = '';
  reqs.forEach(r => {
    const div = document.createElement('div');
    div.className = 'req-row border rounded p-2 mb-1 bg-light';
    const name = escHtml(r.name || r.val || r.alias || r.id);
    const isNull  = r.nullable || r.null_flag || r.nullable_flag || false;
    const isMulti = r.multi || r.multi_flag || false;
    div.innerHTML = `
      <span class="fw-semibold">${name}</span>
      <span class="badge bg-secondary">${escHtml(r.type_name || r.type || 'str')}</span>
      <button class="btn btn-xs btn-sm ${isNull ? 'btn-success' : 'btn-outline-secondary'} btn-null"
              data-id="${r.id}" data-type-id="${typeId}" title="Toggle NULL">
        NULL${isNull ? '✓' : ''}
      </button>
      <button class="btn btn-xs btn-sm ${isMulti ? 'btn-success' : 'btn-outline-secondary'} btn-multi"
              data-id="${r.id}" data-type-id="${typeId}" title="Toggle MULTI">
        MULTI${isMulti ? '✓' : ''}
      </button>`;
    div.querySelector('.btn-null').addEventListener('click', async () => {
      const sess = getSession();
      const res = await api('POST', `/${db}/_d_null/${r.id}?JSON`, { _xsrf: sess.xsrf });
      if (res && !res.error) loadReqs(typeId);
      else showAlert(res?.error || 'Failed');
    });
    div.querySelector('.btn-multi').addEventListener('click', async () => {
      const sess = getSession();
      const res = await api('POST', `/${db}/_d_multi/${r.id}?JSON`, { _xsrf: sess.xsrf });
      if (res && !res.error) loadReqs(typeId);
      else showAlert(res?.error || 'Failed');
    });
    container.appendChild(div);
  });
}

// ── New type ──────────────────────────────────────────────────────────────────
document.getElementById('btnNewType').addEventListener('click', async () => {
  const name = prompt('New type name:');
  if (!name) return;
  const sess = getSession();
  const data = await api('POST', `/${db}/_d_new?JSON`, { name, _xsrf: sess.xsrf });
  if (!data) return;
  if (data.error) return showAlert(data.error);
  showAlert(`Type "${name}" created (id: ${data.id || '?'})`, 'success');
  loadTypes();
});

// ── Add requisite ─────────────────────────────────────────────────────────────
document.getElementById('btnAddReq').addEventListener('click', async () => {
  const typeId = document.getElementById('reqTypeId').value;
  const name   = document.getElementById('reqName').value.trim();
  if (!name) return;
  const sess = getSession();
  const data = await api('POST', `/${db}/_d_req/${typeId}?JSON`, { name, _xsrf: sess.xsrf });
  bootstrap.Modal.getInstance(document.getElementById('reqModal')).hide();
  if (!data) return;
  if (data.error) return showAlert(data.error);
  showAlert(`Column "${name}" added`, 'success');
  loadReqs(typeId);
});

// ── Init ─────────────────────────────────────────────────────────────────────
if (!getSession().token) redirectLogin();
loadTypes();
</script>
</body>
</html>
