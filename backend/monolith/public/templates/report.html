<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 1rem; background: #f8f9fa; }
    #resultTable { font-size: .875rem; }
  </style>
</head>
<body>

<div class="d-flex align-items-center mb-3 gap-2">
  <h5 class="mb-0" id="pageTitle">Report</h5>
  <button class="btn btn-sm btn-outline-secondary ms-auto" id="btnExport">Export CSV</button>
</div>

<div id="alertBox" class="alert d-none" role="alert"></div>

<!-- Filters -->
<form id="filterForm" class="bg-white border rounded p-3 mb-3">
  <div id="filterFields" class="row g-2"></div>
  <div class="mt-2">
    <button type="submit" class="btn btn-primary btn-sm">Run</button>
    <button type="reset" class="btn btn-outline-secondary btn-sm">Clear</button>
  </div>
</form>

<!-- Results -->
<div class="table-responsive">
  <table class="table table-bordered table-sm table-hover bg-white" id="resultTable">
    <thead class="table-dark"><tr id="resultHead"></tr></thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>
<div id="empty" class="text-muted d-none">No results.</div>

<script>
// ── API helpers ───────────────────────────────────────────────────────────────
const params   = new URLSearchParams(location.search);
const db       = params.get('db') || '';
const reportId = params.get('report') || '';

function getSession() {
  return {
    token: localStorage.getItem(`${db}_token`) || '',
    xsrf:  localStorage.getItem(`${db}_xsrf`)  || '',
  };
}
function redirectLogin() {
  top.location.href = `login.html?db=${encodeURIComponent(db)}`;
}
async function api(method, path, body) {
  const opts = { method, credentials: 'include', headers: {} };
  if (body) {
    opts.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    opts.body = new URLSearchParams(body).toString();
  }
  const res = await fetch(path, opts);
  if (res.status === 401) { redirectLogin(); return null; }
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { error: text }; }
}
function showAlert(msg, type = 'danger') {
  const box = document.getElementById('alertBox');
  box.className = `alert alert-${type}`;
  box.textContent = msg;
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Load metadata ─────────────────────────────────────────────────────────────
let columns = [];

async function loadMeta() {
  if (!reportId) return;
  const data = await api('GET', `/${db}/metadata/${reportId}?JSON`);
  if (!data) return;
  columns = Array.isArray(data) ? data : (data.cols || data.columns || data.reqs || data.data || []);
  document.getElementById('pageTitle').textContent = `Report #${reportId}`;
  renderFilters();
  renderHead();
}

function renderFilters() {
  const container = document.getElementById('filterFields');
  container.innerHTML = '';
  columns.forEach(c => {
    const alias = c.alias || c.id;
    const label = c.name || c.val || alias;
    const col = document.createElement('div');
    col.className = 'col-md-3';
    col.innerHTML = `
      <label class="form-label small mb-1">${escHtml(label)}</label>
      <input type="text" class="form-control form-control-sm" name="EQ_${escHtml(alias)}" placeholder="= value">`;
    container.appendChild(col);

    // Date range filter
    if ((c.type_name || c.type || '').toLowerCase() === 'date') {
      const from = document.createElement('div');
      from.className = 'col-md-3';
      from.innerHTML = `
        <label class="form-label small mb-1">${escHtml(label)} from</label>
        <input type="date" class="form-control form-control-sm" name="FR_${escHtml(alias)}">`;
      const to = document.createElement('div');
      to.className = 'col-md-3';
      to.innerHTML = `
        <label class="form-label small mb-1">${escHtml(label)} to</label>
        <input type="date" class="form-control form-control-sm" name="TO_${escHtml(alias)}">`;
      container.appendChild(from);
      container.appendChild(to);
    }
  });
}

function renderHead() {
  const tr = document.getElementById('resultHead');
  tr.innerHTML = '';
  columns.forEach(c => {
    const th = document.createElement('th');
    th.textContent = c.name || c.val || c.alias || c.id;
    tr.appendChild(th);
  });
}

// ── Run report ────────────────────────────────────────────────────────────────
let lastData = [];

document.getElementById('filterForm').addEventListener('submit', async e => {
  e.preventDefault();
  const sess = getSession();
  const formData = new FormData(e.target);
  const body = { action: 'report', id: reportId, _xsrf: sess.xsrf };
  formData.forEach((v, k) => { if (v) body[k] = v; });

  const data = await api('POST', `/${db}?JSON`, body);
  if (!data) return;
  if (data.error) return showAlert(data.error);

  const rows = Array.isArray(data) ? data : (data.rows || data.data || data.result || []);
  lastData = rows;
  renderRows(rows);
});

function renderRows(rows) {
  const tbody = document.getElementById('resultBody');
  tbody.innerHTML = '';
  document.getElementById('empty').classList.toggle('d-none', rows.length > 0);
  rows.forEach(row => {
    const tr = document.createElement('tr');
    if (columns.length > 0) {
      columns.forEach(c => {
        const alias = c.alias || c.id;
        const v = row[alias] ?? row[c.id] ?? '';
        tr.innerHTML += `<td>${escHtml(String(v))}</td>`;
      });
    } else {
      tr.innerHTML = `<td colspan="20">${escHtml(JSON.stringify(row))}</td>`;
    }
    tbody.appendChild(tr);
  });
}

// ── CSV export ────────────────────────────────────────────────────────────────
document.getElementById('btnExport').addEventListener('click', () => {
  if (!lastData.length) return;
  const headers = columns.map(c => c.name || c.val || c.alias || c.id);
  const csvRows = [headers.join(',')];
  lastData.forEach(row => {
    const vals = columns.map(c => {
      const v = String(row[c.alias || c.id] ?? '').replace(/"/g,'""');
      return `"${v}"`;
    });
    csvRows.push(vals.join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `report-${reportId}.csv`;
  a.click();
});

// ── Init ─────────────────────────────────────────────────────────────────────
if (!getSession().token) redirectLogin();
if (!reportId) showAlert('No report ID specified (?report=...)');
else loadMeta();
</script>
</body>
</html>
