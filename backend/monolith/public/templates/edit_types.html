<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/css.css">
  <title>Integram</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script>
    // ── Session init ──────────────────────────────────────────────────────────
    var p = new URLSearchParams(location.search);
    var db    = p.get('db')  || localStorage.getItem('_db') || '';
    var xsrf  = localStorage.getItem(db + '_xsrf')   || '';
    var token = localStorage.getItem(db + '_token')  || '';
    var uid   = localStorage.getItem(db + '_userId') || '';
    var id    = parseInt(p.get('id')) || 0;
    var action = '';
    var menu = [];
    if (!token) location.href = '/app/templates/login.html?db=' + encodeURIComponent(db);
  </script>
  <script src="/js/js.js"></script>
  <style>
    .topm-20 { padding-top: 20px; }
    .table td { border-top: none; vertical-align: middle; padding: 0; border-bottom: 1px solid #dee2e6; }
    .panel { font-size: 14px; }
    .space { display: inline-block; width: 7px; height: 8px; }
    .dubspace { display: inline-block; width: 14px; }
    .hi8 { height: 8px; }
    #table137 { display: none; }
    .msgs { position: fixed; width: 100%; z-index: 100; }
    .controls-left a:hover { background-color: #f7f7f7; border-radius: 5px; text-decoration: none; }
    .close-btn { position: absolute; right: 0; display: none; }
  </style>
</head>
<body>
<!-- ── Navbar ──────────────────────────────────────────────────────────────── -->
<nav id="nav" class="navbar shadow-sm navbar-expand-562 fixed-top dark navbar-fixed-top">
  <a id="brand" class="navbar-brand" href="/app/templates/main.html?db=">
    <img src="/i/lamp.png" width="30" loading="lazy"/>
  </a>
  <div class="right-block" id="right_block">
    <div class="nav-item dropdown">
      <a class="user-link dropdown-toggle user-margin" href="#" role="button" data-toggle="dropdown">
        <svg height="30" viewBox="0 0 18 20" fill="white" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 19V17C17 15.9391 16.5786 14.9217 15.8284 14.1716C15.0783 13.4214 14.0609 13 13 13H5C3.93913 13 2.92172 13.4214 2.17157 14.1716C1.42143 14.9217 1 15.9391 1 17V19M13 5C13 7.20914 11.2091 9 9 9C6.79086 9 5 7.20914 5 5C5 2.79086 6.79086 1 9 1C11.2091 1 13 2.79086 13 5Z"
                stroke="#fafafa" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
      <div class="dropdown-menu dropdown-menu-right shadow">
        <a class="dropdown-item" href="/app/templates/main.html?db=__DB__">
          <t9n>[RU]Главная[EN]Home</t9n></a>
        <a class="dropdown-item" onclick="doExit()"><t9n>[RU]Выход[EN]Exit</t9n></a>
      </div>
    </div>
  </div>
</nav>

<!-- ── Page content ───────────────────────────────────────────────────────── -->
<div class="content" style="padding-top:50px;">

<div id="messages" class="msgs" onclick="this.innerHTML=''"></div>

<!-- Add / search form (fixed) -->
<form id="addForm" style="position:fixed;background-color:white;z-index:1;margin:5px;width:100%;max-width:1050px;" onsubmit="doCreateType(event)">
  <div class="row t9n p-0 m-0">
    <div class="col-6 col-sm-4 col-md-3 pl-0 pr-1">
      <input type="text" id="val" name="val" placeholder="<t9n>[RU]Поиск / Новая таблица[EN]Search / New table</t9n>"
             maxlength="127" onkeyup="filterTypes()" class="form-control">
    </div>
    <div class="col-6 col-sm-4 col-md-3 p-0">
      <div class="input-group mb-2">
        <select name="t" id="baseTypes" onchange="filterTypes()" class="form-control">
          <option value="0">SHORT</option>
        </select>
        <div class="input-group-append">
          <a href="#basehelp" onclick="hideUnHide('basehelp')" title="<t9n>[RU]Описание базовых типов[EN]Description of base types</t9n>">
            <img class="icon8 p-2" src="/i/help.png"/>
          </a>
        </div>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-2 pt-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="unique" value="1" id="flexCheckDefault"
               title="<t9n>[RU]Невозможно добавить одинаковые независимые записи[EN]It is impossible to add identical independent objects</t9n>">
        <label class="form-check-label" for="flexCheckDefault"><t9n>[RU]Уникальный[EN]Unique</t9n></label>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-2 p-0">
      <button type="submit" class="btn btn-primary mb-2 pl-5 pr-5" name="addbtn" id="addbtn">
        <t9n>[RU]Создать[EN]Create</t9n></button>
    </div>
  </div>
</form>

<script type="text/javascript">
document.title = t9n('[RU]Редактор структуры таблиц[EN]Table structure editor');
var editable = ext = false, curid = 0, isRef = false, prefix = 0
  , ajax = '<img style="margin:1px" width="25px" src="/i/ajax.gif">'
  , nullmask = /:!NULL:/i
  , multimask = /:MULTI:/i
  , aliasmask = /:ALIAS=(.+):/i;
var HTML = '', o = [], s = [], a = [], v = [];

// ── Base types ────────────────────────────────────────────────────────────────
var bt = {};
var str = '';

// Static base type names (populated from server, but using defaults if needed)
var _defaultBT = [
  [1,'SHORT'],[2,'MEMO'],[3,'DATE'],[4,'BOOLEAN'],[5,'NUMBER'],
  [6,'SIGNED'],[7,'FILE'],[8,'HTML'],[9,'CHARS'],[10,'DATETIME'],
  [11,'BOOLEAN'],[12,'REFERENCE'],[13,'NUMBER'],[14,'SIGNED'],
  [15,'ARRAY'],[16,'CALCULATABLE'],[17,'REPORT_COLUMN'],[18,'GRANT'],
  [19,'PATH'],[20,'PWD'],[21,'BUTTON']
];

// Load base types from server
fetch('/' + db + '/metadata/base?JSON', { credentials: 'include' })
  .then(function(r){ return r.json(); })
  .catch(function(){ return null; })
  .then(function(resp) {
    if (resp && Array.isArray(resp)) {
      resp.forEach(function(b) {
        if (b.id !== undefined && b.val !== undefined) {
          bt[b.id] = b.val;
          if (b.id !== 8) // Skip tab delimiter (type 8)
            str += '<option value="' + b.id + '">' + b.val + '</option>';
        }
      });
    } else {
      // Use static fallback
      _defaultBT.forEach(function(pair) {
        if (pair[0] !== 8) {
          bt[pair[0]] = pair[1];
          str += '<option value="' + pair[0] + '">' + pair[1] + '</option>';
        }
      });
      bt[8] = 'Tab delimiter';
    }
    str += '<option value="0">------------</option></select>';
    bt[0] = 'Tab delimiter';
    document.getElementById('baseTypes').innerHTML = str;
    $('#baseTypes option[value=8]').remove();
    loadTypes();
  });

// ── Load and render types ─────────────────────────────────────────────────────
var t = {}, r = {};

function loadTypes() {
  fetch('/' + db + '/metadata?JSON', { credentials: 'include' })
    .then(function(resp){ return resp.json(); })
    .then(function(items) {
      t = {}; r = {};
      // Build t{} and r{} from metadata response
      if (Array.isArray(items)) {
        items.forEach(function(item) {
          if (t[item.id] === undefined)
            t[item.id] = { t: item.type || 0, r: item.orig || '', u: item.unique ? 1 : 0, v: item.val || '' };
          if (item.reqs && item.reqs.length) {
            item.reqs.forEach(function(req) {
              var ord = req.num || req.ord || req.id;
              if (ord !== undefined && ord !== '') {
                if (r[item.id] === undefined) r[item.id] = {};
                r[item.id][ord] = {
                  i: req.id,
                  t: req.type || req.t || 0,
                  a: req.attrs || req.a || '',
                  r: req.ref || req.r || ''
                };
                // Ensure the requisite type is also in t{}
                var rqType = req.type || req.t || 0;
                if (t[rqType] === undefined && rqType) {
                  t[rqType] = { t: 0, r: '', u: 0, v: String(rqType) };
                }
              }
            });
          }
        });
      } else if (items && items.edit_types) {
        // Handle edit_types format response
        var arr = items.edit_types;
        for (var i2 in arr.id) {
          if (t[arr.id[i2]] === undefined)
            t[arr.id[i2]] = { t: arr.t[i2], r: arr.ref_val[i2], u: arr.uniq[i2], v: arr.val[i2] };
          if (arr.ord[i2] !== '') {
            if (r[arr.id[i2]] === undefined) r[arr.id[i2]] = {};
            r[arr.id[i2]][arr.ord[i2]] = { i: arr.req_id[i2], t: arr.req_t[i2], a: arr.attrs[i2], r: arr.reft[i2] };
          }
        }
      }
      editable = true;
      drawChart();
    })
    .catch(function(e) {
      showMsg('Ошибка загрузки структуры: ' + e.message);
    });
}

// ── Create type ───────────────────────────────────────────────────────────────
function doCreateType(event) {
  event.preventDefault();
  var valEl = document.getElementById('val');
  var baseType = document.getElementById('baseTypes').value;
  var unique = document.querySelector('input[name=unique]').checked ? 1 : 0;
  if (!valEl.value.trim()) {
    alert(t9n('[RU]Введите название таблицы[EN]Input the term name!'));
    return;
  }
  var addbtn = document.getElementById('addbtn');
  addbtn.disabled = true;
  fetch('/' + db + '/_d_new?JSON', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: '_xsrf=' + encodeURIComponent(xsrf) + '&val=' + encodeURIComponent(valEl.value.trim()) +
          '&t=' + baseType + '&unique=' + unique,
    credentials: 'include'
  }).then(function(resp){ return resp.json(); })
    .then(function(json) {
      addbtn.disabled = false;
      if (json.obj > 0) {
        loadTypes();
        valEl.value = '';
      } else {
        showMsg(json.error || json.msg || t9n('[RU]Ошибка[EN]Error'));
      }
    })
    .catch(function(e){ addbtn.disabled = false; showMsg('Ошибка: ' + e.message); });
}

function filterTypes() {
  if ($('#val').val() === '')
    $('table[id^=table]').each(function() {
      if (!simpleHidden || !$(this).hasClass('simple-term'))
        $(this).show();
      else
        $(this).hide();
    });
  else
    $('table[id^=table]').each(function() {
      if ((new RegExp('>[^<]*' + $('#val').val() + '[^>]*<', 'gmui')).test(this.innerHTML))
        $(this).show();
      else
        $(this).hide();
    });
  $('#addbtn').prop('disabled', false);
  $('.card-header').css('background-color', '');
  for (var i in t)
    if (t[i].v.toLowerCase() === $('#val').val().toLowerCase().trim() && t[i].t == $('#baseTypes').val()) {
      $('#addbtn').prop('disabled', true);
      $('#id' + i).closest('.card-header').css('background-color', 'lightblue');
      break;
    }
}

function hideUnHide(i) {
  if (byId(i).classList.contains('hidden'))
    byId(i).classList.remove('hidden');
  else
    byId(i).className += ' hidden';
}
function hide(i) { if (!byId(i).classList.contains('hidden')) byId(i).classList.add('hidden'); }
function unHide(i) { if (byId(i).classList.contains('hidden')) byId(i).classList.remove('hidden'); }

addEventListener('keyup', function(event) {
  if (event.keyCode == 36) {
    var daE = document.activeElement;
    if (daE.type)
      if ((daE.type.toLowerCase() == 'textarea') || (daE.type.toLowerCase() == 'text'))
        return;
    byId('val').select();
  }
});
</script>

<!-- Base type help table -->
<div class="col-12" style="padding-left:33px;">
<table id="basehelp" class="table table-striped hidden t9n">
<tr><th><t9n>[RU]Базовый тип[EN]Basic type</t9n></th><th><t9n>[RU]Описание[EN]Description</t9n></th></tr>
<tr><td>SHORT</td><td><t9n>[RU]Строка без ограничения длины[EN]String without length restriction</t9n></td></tr>
<tr><td>DATE</td><td><t9n>[RU]Дата[EN]Date</t9n></td></tr>
<tr><td>NUMBER</td><td><t9n>[RU]Целое число[EN]Integer</t9n></td></tr>
<tr><td>SIGNED</td><td><t9n>[RU]Число с десятичной частью[EN]A number with a decimal part</t9n></td></tr>
<tr><td>BOOLEAN</td><td><t9n>[RU]Логическое значение (Да / Нет)[EN]Boolean value (Yes / No)</t9n></td></tr>
<tr><td>MEMO</td><td><t9n>[RU]Текст многострочное[EN]Text, multi-line</t9n></td></tr>
<tr><td>DATETIME</td><td><t9n>[RU]Дата и время[EN]Date and time</t9n></td></tr>
<tr><td>FILE</td><td><t9n>[RU]Файл[EN]File</t9n></td></tr>
<tr><td>HTML</td><td><t9n>[RU]HTML-текст[EN]HTML-text</t9n></td></tr>
<tr><td>PWD</td><td><t9n>[RU]Пароль[EN]Password</t9n></td></tr>
<tr><td>CALCULATABLE</td><td><t9n>[RU]Вычисляемое поле[EN]A calculatable field</t9n></td></tr>
</table>

<div style="padding:10px 0 0 0" class="controls-left">
  <a onclick="document.location.reload()" title="Обновить страницу и свернуть все объекты">
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M25 5.99763V11.9976M25 11.9976H19M25 11.9976L20.36 7.63763C19.2853 6.56235 17.9556 5.77684 16.4952 5.35441C15.0348 4.93198 13.4911 4.88639 12.0083 5.22189C10.5255 5.5574 9.1518 6.26307 8.01547 7.27305C6.87913 8.28304 6.01717 9.56442 5.51 10.9976M3 21.9976V15.9976M3 15.9976H9M3 15.9976L7.64 20.3576C8.71475 21.4329 10.0444 22.2184 11.5048 22.6409C12.9652 23.0633 14.5089 23.1089 15.9917 22.7734C17.4745 22.4379 18.8482 21.7322 19.9845 20.7222C21.1209 19.7122 21.9828 18.4308 22.49 16.9976" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg> Обновить
  </a>
  &nbsp;&nbsp;
  <a title="Показать/скрыть служебные объекты" onclick="$('#table137,.show-service').toggle(showHideDelay)">
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="show-service" style="display:none">
      <path d="M3 14C3 14 7 6 14 6C21 6 25 14 25 14C25 14 21 22 14 22C7 22 3 14 3 14Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 17C15.6569 17 17 15.6569 17 14C17 12.3431 15.6569 11 14 11C12.3431 11 11 12.3431 11 14C11 15.6569 12.3431 17 14 17Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="show-service">
      <path d="M16.12 16.12C15.8454 16.4147 15.5141 16.6512 15.1462 16.8151C14.7782 16.9791 14.3809 17.0673 13.9781 17.0744C13.5753 17.0815 13.1752 17.0074 12.8016 16.8565C12.4281 16.7056 12.0887 16.481 11.8038 16.1962C11.519 15.9113 11.2944 15.5719 11.1435 15.1984C10.9926 14.8248 10.9185 14.4247 10.9256 14.0219C10.9327 13.6191 11.0209 13.2218 11.1849 12.8538C11.3488 12.4859 11.5853 12.1546 11.88 11.88M3 3L25 25M19.94 19.94C18.2306 21.243 16.1491 21.9649 14 22C7 22 3 14 3 14C4.24389 11.6819 5.96914 9.65661 8.06 8.06L19.94 19.94ZM11.9 6.24C12.5883 6.07888 13.2931 5.99834 14 6C21 6 25 14 25 14C24.393 15.1356 23.6691 16.2047 22.84 17.19L11.9 6.24Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg> Служебные
  </a>
  &nbsp;&nbsp;
  <a title="Показать/скрыть простые термины" onclick="showHideSimple()">
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="show-simple" style="display:none">
      <path d="M3 14C3 14 7 6 14 6C21 6 25 14 25 14C25 14 21 22 14 22C7 22 3 14 3 14Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 17C15.6569 17 17 15.6569 17 14C17 12.3431 15.6569 11 14 11C12.3431 11 11 12.3431 11 14C11 15.6569 12.3431 17 14 17Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="show-simple">
      <path d="M16.12 16.12C15.8454 16.4147 15.5141 16.6512 15.1462 16.8151C14.7782 16.9791 14.3809 17.0673 13.9781 17.0744C13.5753 17.0815 13.1752 17.0074 12.8016 16.8565C12.4281 16.7056 12.0887 16.481 11.8038 16.1962C11.519 15.9113 11.2944 15.5719 11.1435 15.1984C10.9926 14.8248 10.9185 14.4247 10.9256 14.0219C10.9327 13.6191 11.0209 13.2218 11.1849 12.8538C11.3488 12.4859 11.5853 12.1546 11.88 11.88M3 3L25 25M19.94 19.94C18.2306 21.243 16.1491 21.9649 14 22C7 22 3 14 3 14C4.24389 11.6819 5.96914 9.65661 8.06 8.06L19.94 19.94ZM11.9 6.24C12.5883 6.07888 13.2931 5.99834 14 6C21 6 25 14 25 14C24.393 15.1356 23.6691 16.2047 22.84 17.19L11.9 6.24Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg> Простые
  </a>
</div>
</div>

<div id="obj" style="overflow:auto;"></div>

<script src="/js/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
// ── All the PHP-template JS functions with {_global_.z} replaced by `db` ─────
var simpleHidden = true, serviceHidden = true, showHideDelay = 200;

function showHideSimple() {
  if (simpleHidden) $('.simple-term').show(showHideDelay);
  else $('.simple-term').hide(showHideDelay);
  simpleHidden = !simpleHidden;
  $('.show-simple').toggle(showHideDelay);
}

function hideMenu(i) {
  if (i) $('#' + i).find('.close-btn').hide();
  drawReqs(i, false, true);
  if (r[i] == undefined) $('#req' + i).hide();
  $('#m' + i).html('').hide();
  $('#id' + i).show();
}

function toggleMenu(i) {
  var menu2 = diclink = createlink = '', hasRefs = false;
  $('.et-line').remove();
  if (curid !== i || $('#m' + i).is(':hidden')) {
    hideMenu(curid);
    curid = i;
    $('#' + i).find('.close-btn').show();
    if (t[i].r != '')
      diclink = '<div class="space"></div><a href="#' + t[i].r + '" title="' + t9n('[RU]Перейти к исходной таблице[EN]Go to the type definition') + '"><img class="icon8" src="/i/accuracy.png"/></a>&nbsp;';
    else
      for (var j in t)
        if (t[j].r == i) {
          diclink = '<div class="space"></div><a href="#' + j + '" title="' + t9n('[RU]Ссылка на справочник[EN]Link to the reference list') + '"><img class="icon8" src="/i/accuracy.png"/></a>&nbsp;'
            + '<div class="space"></div><a href="/' + db + '/object/' + i + '" target="' + i + '" title="' + t9n('[RU]Войти в справочник[EN]Enter the directory') + '"><img class="icon8" src="/i/dictionary.png"/></a>&nbsp;';
          hasRefs = true;
          break;
        }
    if (editable) {
      if (t[i].r != '')
        menu2 += '<a onclick="toggleMenu(' + i + ');" title="' + t9n('[RU]Кликните еще раз, чтобы свернуть[EN]Click again to collapse') + '">' + t[t[i].t].v + '</a><br/>';
      else if (t[i].t == 0) {
        menu2 += '<FORM method="post" action="/' + db + '/_d_save/' + i + '/"><input type="hidden" name="_xsrf" value="' + xsrf + '">'
          + '<p><input type="text" name="val" value="' + t[i].v + '" MAXLENGTH="127" class="form-control sm"></p>'
          + '<input type="submit" name="savebtn" class="btn btn-primary btn-sm" value="' + t9n('[RU]Сохранить[EN]Save') + '" />&nbsp;&nbsp;&nbsp;<A class="btn btn-outline-secondary btn-sm" onclick="toggleMenu(' + i + ');">' + t9n('[RU]Отменить[EN]Cancel') + '</a></FORM>';
      } else {
        menu2 += '<FORM method="post" action="/' + db + '/_d_save/' + i + '/"><input type="hidden" name="_xsrf" value="' + xsrf + '">';
        menu2 += '<input type="text" name="val" value="' + t[i].v + '" MAXLENGTH="127" class="form-control sm">';
        menu2 += '<select name="t" class="form-control">';
        for (var k in bt)
          if (k != 0)
            menu2 += '<option value="' + k + '" id="' + i + '_' + k + '">' + bt[k] + '</option>';
        menu2 += '</select>';
        menu2 += '<table width="100%" style="margin-top:8px;"><tr><td><div class="dubspace"></div><label><input type="checkbox" name="unique" value="1" ' + (t[i].u ? 'CHECKED' : '') + ' /><div class="space"></div>' + t9n('[RU]Уникальный[EN]Unique') + '</label></td>';
        menu2 += '<td align="right"><input type="submit" name="savebtn" class="btn btn-primary btn-sm" value="' + t9n('[RU]Сохранить[EN]Save') + '" />&nbsp;&nbsp;&nbsp;<A class="btn btn-outline-secondary btn-sm" onclick="toggleMenu(' + i + ');">' + t9n('[RU]Отменить[EN]Cancel') + '</a></td></tr></table></FORM>';
        if (diclink == '')
          diclink += '<a onclick="post(\'_d_ref/' + i + '\')" title="' + t9n('[RU]Создать ссылку на эту таблицу[EN]Create a link to this type') + '"><img class="icon8" src="/i/add-link.png"/><div class="space"></div>' + t9n('[RU]Создать ссылку[EN]Create link') + '</a><br />';
      }
      menu2 += '<div class="hi8"></div><table width="100%" style="margin-top:8px;"><tr><td align="left">' + diclink + '</td>';
      if (!hasRefs) {
        var outer_done = false;
        for (var j2 in r) {
          if (outer_done) break;
          for (var k2 in r[j2])
            if (hasRefs = (r[j2][k2].t == i)) { outer_done = true; break; }
        }
      }
      if (!hasRefs) {
        if (r[i] === undefined)
          menu2 += '<td align="right"><a onclick="myApi(\'POST\',\'_d_del/' + i + '?JSON\',\'del\');setAjax(this)">';
        else
          menu2 += '<td align="right"><a onclick="myApi(\'POST\',\'_d_del/' + i + '?JSON\',\'del\')">';
        menu2 += '<img class="icon8" src="/i/delete.png"/><div class="space"></div>' + t9n('[RU]Удалить таблицу[EN]Delete the type') + '</a></td>';
      }
      menu2 += '</tr></table>';
    } else {
      menu2 += diclink + t[i].v + '<br /><div style="padding:6px;"><input type="checkbox" DISABLED ' + t[i].u + ' />' + t9n('[RU]Уникальный[EN]Unique') + '</div>';
      menu2 += '<div width="100%" align="right"><A onclick="toggleMenu(' + i + ');">' + t9n('[RU]Скрыть[EN]Hide') + '</a></div>';
    }
    byId('m' + i).innerHTML = menu2;
    if (byId(i + '_' + t[i].t)) {
      byId(i + '_' + t[i].t).setAttribute('SELECTED', 'SELECTED');
      byId(i + '_' + t[i].t).selected = true;
    }
    if (t[i].t != 0) drawReqs(i, true, true);
    if (byId('req' + i)) byId('req' + i).style.display = 'block';
    byId('m' + i).style.display = 'inline';
    byId('id' + i).style.display = 'none';
  } else
    hideMenu(i);
}

function drawObj(i, p, virt) {
  var h;
  if ((i == p) || (o[i] !== undefined)) return;
  if (virt) {
    return '<table id="table' + i + '" class="simple-term" style="display:none"><tr><td width="33px">&nbsp;</td><td valign="top">' + wrapObj(i) + '</td></tr></table>';
  }
  o[i] = '';
  if (r[i] === undefined)
    h = '<table id="table' + i + '"><tr><td width="33px">&nbsp;</td><td valign="top">' + wrapObj(i) + '</td></tr></table>';
  else
    h = '<table id="table' + i + '"' + (p == '' ? ' class="mb-4"' : '') + '><tr><td width="33px">&nbsp;</td><td valign="top">' + wrapObj(i) + '</td><td valign="top"><div style="display:inline;" id="obj' + i + '">:obj' + i + ':</div></td></tr></table>';
  HTML = HTML.replace(':obj' + p + ':', h + ':obj' + p + ':');
  drawReqs(i, (i == curid && ext), false);
  if (t[i].u) t[i].u = 'CHECKED';
  else t[i].u = '';
  return true;
}

function getBT(tc) {
  if (bt[tc] === undefined) return 'reference';
  return bt[tc].toLowerCase();
}

function wrapObj(i) {
  var obj = '<div class="topm-20" id="' + i + '"><div class="card">'
    + '<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg" class="close-btn" onclick="toggleMenu(' + i + ');">'
    + '<path d="M8.64284 8.64287L13.3571 13.3572M13.3571 8.64287L8.64284 13.3572M5.49999 3.92859H16.5C17.3679 3.92859 18.0714 4.63214 18.0714 5.50002V16.5C18.0714 17.3679 17.3679 18.0714 16.5 18.0714H5.49999C4.63211 18.0714 3.92856 17.3679 3.92856 16.5V5.50002C3.92856 4.63214 4.63211 3.92859 5.49999 3.92859Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  obj += '<div class="card-header" onmouseover="if($(\'#m' + i + '\').is(\':hidden\'))$(this).parent().find(\'.et-lines\').mouseover()" onmouseleave="$(\'.et-line\').remove()">';
  if (t[i].r != '')
    obj += '<a href="/' + db + '/object/' + t[i].r + '" title="' + t9n('[RU]Войти в справочник[EN]View the directory') + '"><img class="icon8" src="/i/dictionary.png"/></a>';
  obj += ' <a id="id' + i + '" style="display:inline;" onclick="toggleMenu(' + i + ');"> ' + (t[i].r != '' ? t[t[i].t].v : t[i].v) + '</a>';
  obj += '<div id="m' + i + '" style="display:none;"></div>';
  if (t[i].t == 0)
    obj += '</div>';
  else if (r[i] === undefined)
    obj += '</div><div class="card-body" style="padding-bottom:5px;padding-top:5px;display:none;" id="req' + i + '">:req' + i + ':</div></div></div>';
  else
    obj += '</div><div class="card-body" style="padding-bottom:5px;padding-top:5px;" id="req' + i + '">:req' + i + ':</div></div></div>';
  return obj;
}

function closeDef(i) {
  byId('a' + i).classList.remove('hidden');
  byId('def' + i).classList.add('hidden');
  byId('edit-alias' + i).classList.remove('hidden');
}

function setMulti(i) { myApi('POST', '_d_multi/' + i + '?JSON', 'd'); }

function editDef(i, u) {
  byId('a' + i).classList.add('hidden');
  byId('edit-alias' + i).classList.add('hidden');
  byId('def' + i).innerHTML = '<FORM method="post" action="/' + db + '/_d_alias/' + i + '/?up=' + u + '"><input type="hidden" name="_xsrf" value="' + xsrf + '">'
    + '<input type="text" class="form-control" id="def' + i + 'val" name="val" value="' + a[i].alias + '" MAXLENGTH="127" title="' + t9n('[RU]Задайте псевдоним этой колонки[EN]Specify an alias of this type') + '">'
    + '<div class="input-group"><button class="btn btn-outline-secondary" type="submit">' + t9n('[RU]Сохранить[EN]Save') + '</button>'
    + '<button class="btn btn-outline-secondary" type="button" onclick="closeDef(' + i + ');">' + t9n('[RU]Отменить[EN]Cancel') + '</button>'
    + '</div></form>';
  byId('def' + i).classList.remove('hidden');
  byId('def' + i + 'val').focus();
}

function refreshDD(i, iid) {
  myApi('GET', 'object/' + iid + '?JSON&F_' + iid + '=%25' + byId('v' + i).value + '%25', 'def_ref_dd', '', i);
}

function saveBtn(i, iid) {
  if (byId('dd' + iid))
    if (byId('dd' + iid).innerHTML == ajax)
      myApi('GET', 'object/' + iid + '?JSON', 'def_ref_dd', '', i);
  if (v[i] === undefined) v[i] = byId('v' + i).value;
  else if (v[i] === byId('v' + i).value) hide('s' + i);
  else unHide('s' + i);
}

function checkHash(i) {
  if (!byId(i)) document.location.href = '/' + db + '/edit_types/' + i + '#' + i;
  $('#' + i).show().focus();
  setTimeout(function() { $('#' + i)[0].scrollIntoView(); }, 100);
}

function drawReqs(i, ext2, force) {
  var def_ref_dd, def_ref_class, base, reqs2 = id2 = def_val = alias2 = '', nullable, multiple;
  var seek_alias = new Array();
  if (ext2) reqs2 += '<table class="table" width="100%">';
  for (var req in r[i]) {
    nullable = r[i][req].a.search(nullmask) !== -1;
    multiple = r[i][req].a.search(multimask) === -1;
    def_val = r[i][req].a.replace(nullmask, '').replace(multimask, '');
    seek_alias = def_val.match(aliasmask);
    if (!t[r[i][req].t]) continue; // Skip missing type entries
    base = getBT(t[r[i][req].t].t);
    if (r[i][req].r == '') {
      id2 = r[i][req].t;
      var name = '<a href="#' + id2 + '" id="l' + id2 + '" onclick="checkHash(' + id2 + ')" title="' + base + '">' + t[id2].v + '</a>';
      if (r[id2] !== undefined)
        name = '<div style="display:inline;"><b onmouseleave="$(\'.et-line\').remove()" class="et-lines" onmouseover="drawLine(this,' + id2 + ')">' + name + '</b></div>';
      if (base == 'date') {
        def_ref_class = ' class="dropdown-toggle" data-toggle="dropdown" autocomplete="off"';
        def_ref_dd = '<ul class="dropdown-menu"><li class="p-2"><a onclick="byId(\'v' + r[i][req].i + '\').value=\'[TODAY]\';saveBtn(' + r[i][req].i + ')">[TODAY]</a></li></ul>';
      } else if (base == 'datetime') {
        def_ref_class = ' class="dropdown-toggle" data-toggle="dropdown" autocomplete="off"';
        def_ref_dd = '<ul class="dropdown-menu"><li class="p-2"><a onclick="byId(\'v' + r[i][req].i + '\').value=\'[NOW]\';saveBtn(' + r[i][req].i + ')">[NOW]</a></li></ul>';
      } else
        def_ref_dd = def_ref_class = '';
    } else {
      if (seek_alias === null) alias2 = '';
      else { alias2 = seek_alias[1]; def_val = def_val.replace(aliasmask, ''); }
      id2 = t[r[i][req].t].t;
      var aid = r[i][req].i;
      if (alias2 == '') a[aid] = { alias: t[id2] ? t[id2].v : String(id2), ref: id2 };
      else a[aid] = { alias: alias2, ref: id2 };
      var name = '<div class="hidden" id="def' + aid + '"></div><div style="display:inline;" id="a' + aid + '"><a onmouseleave="$(\'.et-line\').remove()" onmouseover="drawLine(this,' + id2 + ')" href="#' + r[i][req].t + '" title="' + base + '"><b>' + a[aid].alias + '</b></a>';
      name += ' <a href="#' + id2 + '" id="l' + id2 + '" class="et-lines" onmouseleave="$(\'.et-line\').remove()" onmouseover="drawLine(this,' + id2 + ')" onclick="checkHash(' + id2 + ')" title="' + base + '">(' + (t[id2] ? t[id2].v : String(id2)) + ')</a></div>';
      if (ext2 && editable)
        name += '<div id="edit-alias' + aid + '" style="display:inline-block;">&nbsp;&nbsp;<a onclick="editDef(' + aid + ',' + i + ')" title="' + t9n('[RU]Редактировать псевдоним колонки[EN]Edit the alias of an attribute') + '"><img class="icon8" src="/i/edit.png"/></a>&nbsp;</div>'
          + '<div id="edit-alias' + aid + '" style="display:inline-block;">&nbsp;&nbsp;<a onclick="setMulti(' + aid + ')" title="' + (multiple ? t9n('[RU]Разрешить выбор нескольких значений[EN]Enable multiselect') : t9n('[RU]Запретить выбор нескольких значений[EN]Disable multiselect')) + '"><img class="icon8" src="/i/multiple-choice-' + (multiple ? 'aaaaaa' : '333333') + '.png"/></a>&nbsp;</div>';
      def_ref_dd = '<ul id="dd' + id2 + '" class="dropdown-menu">' + ajax + '</ul>';
      def_ref_class = ' class="dropdown-toggle" data-toggle="dropdown" autocomplete="off" onkeyup="refreshDD(' + r[i][req].i + ',' + id2 + ')"';
    }
    if (ext2) {
      reqs2 += '<tr id="row' + r[i][req].i + '"><td>' + name + '</td><td><nobr>';
      if (editable) {
        reqs2 += '<A id="del_req' + r[i][req].i + '" onclick="myApi(\'POST\',\'_d_del_req/' + r[i][req].i + '?JSON\',\'d\');setAjax(this)" TITLE="' + t9n('[RU]Удалить[EN]Delete') + '"><img class="icon8" src="/i/delete-sign.png"/></A>';
        reqs2 += '&nbsp;<A onclick="myApi(\'POST\',\'_d_up/' + r[i][req].i + '?JSON\',\'d\');setAjax(this)" TITLE="' + t9n('[RU]Поднять выше[EN]Move up') + '"><img class="icon8" src="/i/up.png"/></A>';
        if (t[r[i][req].t].t == 0)
          reqs2 += '</td><td colspan="2">&nbsp;</td>';
        else {
          reqs2 += '&nbsp;<A onclick="myApi(\'POST\',\'_d_null/' + r[i][req].i + '?JSON&up=' + i + '\',\'d\');setAjax(this)" TITLE="'
            + (nullable ? t9n('[RU]Нажмите, чтобы сделать поле необязательным[EN]Click to make the field non-required')
              : t9n('[RU]Нажмите, чтобы сделать поле обязательным[EN]Click to make this field required'))
            + '"><img class="icon8" src="/i/high-importance-' + (nullable ? 'ee0000' : '999999') + '.png"/></A>';
          reqs2 += '&nbsp;<nobr></td><td valign="top"><FORM method="post" id="frm' + r[i][req].i + '" action="/' + db + '/_d_attrs/' + r[i][req].i + '/?up=' + i + '"><input type="hidden" name="_xsrf" value="' + xsrf + '">';
          reqs2 += nullable ? '' : '<input type="hidden" name="set_null" value="1">';
          reqs2 += multiple ? '' : '<input type="hidden" name="multi" value="1">';
          if (alias2 != (t[id2] ? t[id2].v : ''))
            reqs2 += '<input type="hidden" name="alias" value="' + alias2 + '">';
          reqs2 += '<input id="v' + r[i][req].i + '" type="text" size="10" name="val" value="' + def_val + '" onfocus="saveBtn(' + r[i][req].i + ',' + id2 + ')" oninput=saveBtn(' + r[i][req].i + ')' + def_ref_class + '>' + def_ref_dd + '</FORM>'
            + '<div id="s' + r[i][req].i + '" class="hidden"><a onclick="byId(\'frm' + r[i][req].i + '\').submit();"><img class="icon8" src="/i/save.png"/></a>&nbsp;'
            + '&nbsp;<a onclick="byId(\'v' + r[i][req].i + '\').value=v[' + r[i][req].i + '];saveBtn(' + r[i][req].i + ')"><img class="icon8" src="/i/cancel.png"/></a>';
        }
      } else {
        if (nullable)
          reqs2 += '&nbsp;<A TITLE="' + t9n('[RU]Обязательное поле[EN]Required field') + '"><img class="icon8" src="/i/requirement-ee0000.png"/></A>&nbsp;';
        else
          reqs2 += '&nbsp;<A TITLE="' + t9n('[RU]Необязательное поле[EN]Non-required field') + '"><img class="icon8" src="/i/requirement.png"/></A>';
        reqs2 += '</td><td><input type="text" name="val" value="' + def_val + '" style="background-color:lightgray;">';
      }
      reqs2 += '</td></tr>';
    } else
      reqs2 += '<a href="#' + id2 + '" title="' + base + '">' + name + '</a>&nbsp;<br />';
    if (r[i][req].r != '') {
      drawObj(t[r[i][req].t].t, i, false);
    } else if (r[r[i][req].t] !== undefined)
      drawObj(r[i][req].t, i, false);
  }
  if (ext2) {
    reqs2 += '</table>';
    if (editable) {
      reqs2 += '<FORM id="add' + i + '" method="post" action="/' + db + '/_d_req/' + i + '" onsubmit="addReq(' + i + ')"><input type="hidden" name="_xsrf" value="' + xsrf + '">';
      reqs2 += '<div class="input-group input-group-sm"><select style="max-width:300px;" name="t" id="sel' + i + '" class="form-control" onchange="check(' + i + ',this.value)"><option value=""> </option>';
      var my = new Array();
      my[i] = i;
      for (var j in r[i])
        if (r[i][j].r == '') my[r[i][j].t] = 1;
      if (t[i].r == '') {
        reqs2 += '<option value="new">--- ' + t9n('[RU]добавить новое[EN]add new') + ' ---</option>';
        for (var j2 in s)
          if (my[s[j2].i] === undefined) {
            reqs2 += '<option value="' + s[j2].i + '">' + ((t[s[j2].i].r == '') ? t[s[j2].i].v + ' (' + getBT(t[s[j2].i].t) + ')' : '-->' + t[s[j2].i].v) + '</option>';
            my[s[j2].i] = 1;
          }
      } else
        for (var j3 in r[t[i].r])
          if (my[r[t[i].r][j3].t] === undefined)
            reqs2 += '<option value="' + r[t[i].r][j3].t + '">' + ((t[r[t[i].r][j3].t].r == '') ? t[r[t[i].r][j3].t].v : '-->' + t[r[t[i].r][j3].t].v) + '</option>';
      reqs2 += '</select><span class="input-group-btn"><input type="submit" class="btn btn-outline-secondary btn-sm" name="addreqbtn' + i + '" id="addreqbtn' + i + '" value="' + t9n('[RU]Добавить колонку[EN]Add attribute') + '" ></span></div></FORM>'
        + '<FORM id="new' + i + '" class="hidden" method="post" action="/' + db + '/_d_req/" onsubmit="event.returnValue=false;event.preventDefault();validateNewType(' + i + ');">'
        + '<div class="input-group input-group-sm"><input type="hidden" name="_xsrf" value="' + xsrf + '">'
        + '<table><tr><td colspan="3"><input id="input' + i + '" type="text" class="form-control" style="margin-bottom:5px;"></td>'
        + '<tr><td><div><SELECT id="t' + i + '" class="form-control form-control-sm">' + str + '</SELECT></div></td>'
        + '<TD align="center" title="' + t9n('[RU]Поставьте галку, если это будет справочное значение[EN]Check the box if this is a reference value') + '">'
        + '&nbsp;' + t9n('[RU]Ссылка[EN]Link') + '&nbsp;<br /><input id="ref' + i + '" type="checkbox" value="1" /></TD>'
        + '<td><input type="submit" class="btn btn-outline-secondary btn-sm" id="newtypbtn' + i + '" value="' + t9n('[RU]Создать[EN]Add') + '" ></td></tr></table>'
        + '</div></FORM>';
    }
  }
  if (force) {
    if (byId('req' + i)) byId('req' + i).innerHTML = reqs2;
  } else
    HTML = HTML.replace(':req' + i + ':', reqs2);
}

function addReq(i) {
  if (byId('sel' + i).value !== '') {
    byId('addreqbtn' + i).disabled = true;
    if (r[byId('sel' + i).value] !== undefined || isRef) return;
    myApi('POST', '_d_req/' + i + '?JSON&t=' + byId('sel' + i).value, 'd');
  }
  event.returnValue = false;
  event.preventDefault();
}

function drawLine(el, i) {
  var start = $(el).closest('div')[0].getBoundingClientRect()
    , end = byId('id' + i).getBoundingClientRect()
    , angle = 30 * Math.PI / 180, arrLen = 10;
  var x1 = arrLen, x2 = end.left - start.right - arrLen
    , y1 = (start.top <= end.top ? -5 : start.top - end.bottom + arrLen) + 2 * arrLen
    , y2 = (start.top <= end.top ? end.top - start.bottom + 3 * arrLen : arrLen);
  var ab = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)
    , ac = Math.sqrt(arrLen ** 2 + ab ** 2 - 2 * arrLen * ab * Math.cos(angle));
  var k = ac / ab, angleA = Math.acos((ac ** 2 + ab ** 2 - arrLen ** 2) / (2 * ac * ab));
  if (x2 + arrLen > 0)
    $('#obj').append('<svg class="et-line" height="' + (Math.abs(start.bottom - end.bottom) + 2 * arrLen) + '" width="' + (x2 + arrLen)
      + '" style="position:absolute;top:' + (scrollY - 2 * arrLen + (start.top <= end.top ? start.bottom : end.bottom)) + 'px;left:' + (start.right + 3) + 'px">'
      + '<line x1="0" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="darkgray" />'
      + '<line x1="' + (x1 + k * ((x2 - x1) * Math.cos(angleA) - (y2 - y1) * Math.sin(angleA))) + '"'
      + ' y1="' + (y1 + k * ((x2 - x1) * Math.sin(angleA) + (y2 - y1) * Math.cos(angleA))) + '" x2="' + x2 + '" y2="' + y2 + '" stroke="darkgray" />'
      + '<line x1="' + (x1 + k * ((x2 - x1) * Math.cos(-angleA) - (y2 - y1) * Math.sin(-angleA))) + '"'
      + ' y1="' + (y1 + k * ((x2 - x1) * Math.sin(-angleA) + (y2 - y1) * Math.cos(-angleA))) + '" x2="' + x2 + '" y2="' + y2 + '" stroke="darkgray" />'
      + '</svg>');
}

function setAjax(el) { el.innerHTML = ajax; }

function validateNewType(iid) {
  if (byId('input' + iid).value == '') {
    alert(t9n('[RU]Введите название таблицы![EN]Enter the name of the table'));
    return;
  }
  var val = byId('input' + iid).value, typ = byId('t' + iid).value;
  for (var i in t)
    if ((t[i].v == val) && ((t[i].t == typ && !byId('ref' + iid).checked) || (byId('ref' + iid).checked && (t[i].r > 0)))) {
      hideUnHide('add' + iid);
      hideUnHide('new' + iid);
      byId('sel' + iid).value = i;
      byId('addreqbtn' + iid).click();
      return;
    }
  byId('newtypbtn' + iid).disabled = true;
  myApi('POST', '_d_new?next_act=nul', 'newtyp', 'val=' + val + '&t=' + typ, iid);
}

function myApi(m, u, b, vars, index) {
  vars = vars || '';
  var h = '', ii, err, json, obj2 = new XMLHttpRequest();
  obj2.open(m, '/' + db + '/' + u, true);
  if (m == 'POST') {
    obj2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    vars = '_xsrf=' + xsrf + '&' + vars;
    obj2.send(vars);
  } else
    obj2.send();
  obj2.onload = function(e) {
    try { json = JSON.parse(this.responseText); }
    catch (e) { console.log(e); console.log(this.responseText); showMsg(this.responseText); }
    obj2.abort();
    switch (b) {
      case 'newtyp':
        if (json.obj > 0) {
          hideUnHide('add' + index);
          hideUnHide('new' + index);
          byId('sel' + index).innerHTML = '<option value="' + json.obj + '">' + byId('input' + index).value + '</option>' + byId('sel' + index).innerHTML;
          byId('sel' + index).focus();
          if (isRef = byId('ref' + index).checked) {
            byId('ref' + index).checked = false;
            myApi('POST', '_d_ref/' + json.obj + '?next_act=nul', 'newref', '', index);
          } else
            addReq(index);
        }
        break;
      case 'def_ref_dd':
        if (json.object !== undefined) {
          for (ii in json.object)
            h += '<li class="p-2"><a onclick="byId(\'v' + index + '\').value=' + json.object[ii].id + ';saveBtn(' + index + ')">' + json.object[ii].val + '</a></li>';
          byId('dd' + json.type.id).innerHTML = h;
        }
        break;
      case 'newref':
        if (json.obj > 0) {
          byId('sel' + index).innerHTML = '<option value="' + json.obj + '">' + byId('input' + index).value + '</option>' + byId('sel' + index).innerHTML;
          byId('addreqbtn' + index).click();
        }
        break;
      case 'd':
        if (json.obj) {
          curid = json.obj;
          ext = 1;
          loadTypes();
        } else
          showMsg(json[0] && json[0].error ? json[0].error : t9n('[RU]Ошибка[EN]Error'));
        break;
      case 'del':
        if (json.id > 0) {
          $('#table' + json.id).remove();
          delete t[json.id];
          for (ii in s) if (s[ii].i == json.id) delete s[ii];
          delete r[json.id];
        }
        break;
      case 'types':
        if (json.edit_types && json.edit_types.id !== undefined) {
          t = {}; r = {};
          var arr = json.edit_types;
          for (ii in arr.id) {
            if (t[arr.id[ii]] === undefined)
              t[arr.id[ii]] = { t: arr.t[ii], r: arr.ref_val[ii], u: arr.uniq[ii], v: arr.val[ii] };
            if (arr.ord[ii] != '') {
              if (r[arr.id[ii]] === undefined) r[arr.id[ii]] = {};
              r[arr.id[ii]][arr.ord[ii]] = { i: arr.req_id[ii], t: arr.req_t[ii], a: arr.attrs[ii], r: arr.reft[ii] };
            }
          }
          drawReqs(curid, true, true);
        }
        break;
    }
  };
}

function showMsg(err, mode) {
  byId('messages').innerHTML = '<div class="alert alert-' + (mode || 'danger') + '" role="alert">' + err + '</div>';
  setTimeout(function() { byId('messages').innerHTML = ''; }, 7000);
}

function check(i, v2) {
  if (v2 !== 'new') return;
  hideUnHide('add' + i);
  hideUnHide('new' + i);
  byId('newtypbtn' + i).disabled = false;
  byId('input' + i).focus();
}

function sVal(i, ii) {
  i.v = i.v.toUpperCase(); ii.v = ii.v.toUpperCase();
  if (i.v > ii.v) return 1;
  else if (i.v < ii.v) return -1;
  return 0;
}

function getParent(id2) {
  var res = '';
  for (var i in r)
    for (var req in r[i])
      if (r[i][req].t == id2) return i;
      else if (t[r[i][req].t] && t[r[i][req].t]['t'] == id2) res = i;
  return res;
}

function findLoop(i, p, depth) {
  depth = depth || 0;
  if (depth++ > 1000) return true;
  for (var j in r[i])
    if (t[r[i][j].t] && t[r[i][j].t].r == '') {
      if ((r[i][j].t == p) || findLoop(r[i][j].t, p, depth)) return true;
    } else
      if (t[r[i][j].t] && ((t[r[i][j].t].r == p) || findLoop(t[r[i][j].t].r, p, depth))) return true;
  return false;
}

function drawChart() {
  var pp, j2 = 0;
  HTML = ':obj:';
  o = []; s = [];
  for (var i in t) s[j2++] = { v: t[i].v, i: i };
  s.sort(sVal);
  for (var i in r)
    if ((o[i] === undefined) && (t[i] && t[i]['r'] == '')) {
      pp = getParent(i);
      if ((o[pp] !== undefined) || (pp == '')) drawObj(i, pp, false);
      else if (findLoop(i, i, 1)) drawObj(i, '', false);
    }
  for (var i in r) if (t[i] && t[i]['r'] != '') drawObj(i, '', false);
  for (var i2 in s)
    if (o[s[i2].i] === undefined) {
      HTML += drawObj(s[i2].i, '', true);
      o[s[i2].i] = '';
    }
  byId('obj').innerHTML = HTML.replace(/:obj\d*:/g, '');
  if (id) setTimeout(function() { checkHash(id); }, 200);
}

(function($, window) {
  var adjustAnchor = function() {
    var $anchor = $(':target'), vh = $('#nav').outerHeight() + ($('#addForm').outerHeight() || 60);
    $('#addForm').css('top', $('#nav').outerHeight() + 'px');
    $('.content').css('padding-top', vh + 'px');
    if ($anchor.length > 0) window.scrollTo(0, $anchor.offset().top - vh);
    $('#table' + document.location.hash.substr(1)).show(250);
  };
  $(window).on('hashchange load', function() { adjustAnchor(); });
})(jQuery, window);

// ── Exit ─────────────────────────────────────────────────────────────────────
function doExit() {
  localStorage.removeItem(db + '_xsrf');
  localStorage.removeItem(db + '_token');
  localStorage.removeItem(db + '_userId');
  document.cookie = encodeURIComponent(db) + '=; path=/; max-age=0';
  location.href = '/app/templates/login.html?db=' + encodeURIComponent(db);
}

// Fix brand/user menu links
document.getElementById('brand').href = '/app/templates/main.html?db=' + encodeURIComponent(db);
document.querySelectorAll('a[href="/app/templates/main.html?db=__DB__"]').forEach(function(el) {
  el.href = '/app/templates/main.html?db=' + encodeURIComponent(db);
});
localize();
</script>
</div><!-- /content -->
</body>
</html>
