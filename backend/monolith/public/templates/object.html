<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Objects</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 1rem; background: #f8f9fa; }
    .table-hover tbody tr { cursor: pointer; }
  </style>
</head>
<body>

<div class="d-flex align-items-center mb-3 gap-2">
  <h5 class="mb-0" id="pageTitle">Objects</h5>
  <button class="btn btn-sm btn-primary ms-auto" id="btnAdd">+ Add</button>
</div>

<div id="alertBox" class="alert d-none" role="alert"></div>

<div class="table-responsive">
  <table class="table table-bordered table-hover table-sm bg-white">
    <thead class="table-dark" id="thead"><tr></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="empty" class="text-muted d-none">No records found.</div>

<!-- Pagination -->
<nav><ul class="pagination pagination-sm" id="pagination"></ul></nav>

<script>
// ── API helpers ───────────────────────────────────────────────────────────────
const params = new URLSearchParams(location.search);
const db     = params.get('db') || '';
const typeId = params.get('type') || '';
const upId   = params.get('up') || '0';

const PAGE_SIZE = 50;
let currentPage = 0;
let totalRows = 0;
let columns = [];

function getSession() {
  return {
    token: localStorage.getItem(`${db}_token`) || '',
    xsrf:  localStorage.getItem(`${db}_xsrf`)  || '',
  };
}
function redirectLogin() {
  top.location.href = `login.html?db=${encodeURIComponent(db)}`;
}
async function api(method, path, body) {
  const opts = { method, credentials: 'include', headers: {} };
  if (body) {
    opts.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    opts.body = new URLSearchParams(body).toString();
  }
  const res = await fetch(path, opts);
  if (res.status === 401) { redirectLogin(); return null; }
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { error: text }; }
}
function showAlert(msg, type = 'danger') {
  const box = document.getElementById('alertBox');
  box.className = `alert alert-${type}`;
  box.textContent = msg;
}

// ── Load columns ──────────────────────────────────────────────────────────────
async function loadColumns() {
  const data = await api('GET', `/${db}/_dict/${typeId}?JSON`);
  if (!data) return;
  columns = Array.isArray(data) ? data : (data.cols || data.columns || data.data || []);
  renderHeader();
}

function renderHeader() {
  const tr = document.querySelector('#thead tr');
  tr.innerHTML = '<th style="width:40px">#</th>';
  columns.forEach(c => {
    const th = document.createElement('th');
    th.textContent = c.name || c.val || c.alias || c.id;
    tr.appendChild(th);
  });
  tr.innerHTML += '<th style="width:60px">Del</th>';
}

// ── Load rows ─────────────────────────────────────────────────────────────────
async function loadRows(page = 0) {
  const offset = page * PAGE_SIZE;
  const data = await api('GET', `/${db}/_list/${typeId}?JSON&up=${upId}&limit=${PAGE_SIZE}&offset=${offset}`);
  if (!data) return;

  const rows = Array.isArray(data) ? data : (data.rows || data.data || data.list || []);
  totalRows = data.total || rows.length;
  currentPage = page;

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  document.getElementById('empty').classList.toggle('d-none', rows.length > 0);

  rows.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.dataset.id = row.id;
    const cells = Array.isArray(row.vals) ? row.vals : (row.values || []);
    tr.innerHTML = `<td>${offset + i + 1}</td>`;
    if (columns.length > 0) {
      columns.forEach(c => {
        const v = row[c.alias] ?? row[c.id] ?? cells[columns.indexOf(c)] ?? '';
        tr.innerHTML += `<td>${escHtml(String(v))}</td>`;
      });
    } else {
      tr.innerHTML += `<td colspan="10">${escHtml(JSON.stringify(row))}</td>`;
    }
    tr.innerHTML += `<td><button class="btn btn-sm btn-danger btn-del" data-id="${row.id}">✕</button></td>`;

    tr.addEventListener('click', e => {
      if (e.target.classList.contains('btn-del')) return;
      openEdit(row.id);
    });
    tr.querySelector('.btn-del').addEventListener('click', async e => {
      e.stopPropagation();
      if (!confirm('Delete this record?')) return;
      const sess = getSession();
      const r = await api('POST', `/${db}/_m_del/${row.id}?JSON`, { _xsrf: sess.xsrf });
      if (r && !r.error) loadRows(currentPage);
      else showAlert(r?.error || r?.msg || 'Delete failed');
    });
    tbody.appendChild(tr);
  });
  renderPagination();
}

function openEdit(id) {
  top.document.getElementById('frame').src =
    `edit.html?db=${encodeURIComponent(db)}&id=${id}&type=${typeId}&up=${upId}`;
}

// ── Pagination ─────────────────────────────────────────────────────────────────
function renderPagination() {
  const total = Math.ceil(totalRows / PAGE_SIZE);
  const ul = document.getElementById('pagination');
  ul.innerHTML = '';
  if (total <= 1) return;
  for (let p = 0; p < total; p++) {
    const li = document.createElement('li');
    li.className = `page-item${p === currentPage ? ' active' : ''}`;
    li.innerHTML = `<a class="page-link" href="#">${p + 1}</a>`;
    li.addEventListener('click', e => { e.preventDefault(); loadRows(p); });
    ul.appendChild(li);
  }
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Add button ────────────────────────────────────────────────────────────────
document.getElementById('btnAdd').addEventListener('click', () => {
  top.document.getElementById('frame').src =
    `edit.html?db=${encodeURIComponent(db)}&up=${upId}&type=${typeId}&new=1`;
});

document.getElementById('pageTitle').textContent = `Objects (type ${typeId})`;

// ── Init ─────────────────────────────────────────────────────────────────────
if (!getSession().token) redirectLogin();
(async () => { await loadColumns(); await loadRows(0); })();
</script>
</body>
</html>
