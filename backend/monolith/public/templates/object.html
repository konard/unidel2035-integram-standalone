<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/css.css">
  <link rel="stylesheet" href="/css/select2.min.css">
  <title>Integram</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script>
    // ── Session init ──────────────────────────────────────────────────────────
    var p = new URLSearchParams(location.search);
    var db    = p.get('db')   || localStorage.getItem('_db') || '';
    var xsrf  = localStorage.getItem(db + '_xsrf')   || '';
    var token = localStorage.getItem(db + '_token')  || '';
    var uid   = localStorage.getItem(db + '_userId') || '';
    var id    = parseInt(p.get('type')) || 0;   // type id
    var F_U   = parseInt(p.get('up'))   || 0;   // parent object id
    var action = '';
    var menu = [];
    if (!token) location.href = '/app/templates/login.html?db=' + encodeURIComponent(db);
  </script>
  <script src="/js/js.js"></script>
  <style>
    th { font-weight: normal; position: relative; }
    .ms-link { color: #333; }
    td.fixed-td div, td.fixed-tr div { max-height: 1rem; }
    .fixed-td {
      max-width: 180px; overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; padding: 2px 1px 0 1px !important;
    }
    .fixed-tr {
      max-width: 30vw; overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; padding: 2px 1px 0 1px !important;
    }
    .edit {
      border: 1px solid lightgray; border-radius: 5px; width: max-content;
      max-width: 266px; padding: 15px; list-style-type: none; margin-bottom: 0;
    }
    .edit-table, .edit-column { position: fixed; background-color: #fff; }
    .edit li:hover { box-shadow: 5px 5px 20px 5px rgba(169,176,181,.2); border-radius: 5px; }
    .edit a { color: #777; font-size: 12px; text-decoration: none; }
    .edit li { padding: 4px; margin-bottom: 10px; }
    .th-plus { cursor: pointer; font-size: 24px; font-weight: 600; text-align: center; width: 70px; }
    .table thead th { border: 1px solid #dee2e6; vertical-align: middle; text-align: center; padding-top: 0; padding-bottom: 0; }
    .table td { border: 1px solid #dee2e6; }
    .edit-btn { position: absolute; right: 3px; top: 0; display: inline-flex; }
    .edit-btn-column:hover, .edit-btn-table:hover { cursor: pointer; background-color: #e7e7e7; border-radius: 6px; }
    .filter-row input { width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px; padding: 1px 3px; }
    .filter-row { display: none; }
    #tb { transition: font-size .15s; }
    .i-edit { display: none; }
    tr:hover .i-edit { display: inline-flex; }
    .pagination-wrap { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    #loading { display: none; text-align: center; padding: 20px; }
    .sort-asc::after { content: ' ▲'; font-size: .7em; }
    .sort-desc::after { content: ' ▼'; font-size: .7em; }
  </style>
</head>
<body>
<!-- ── Navbar ──────────────────────────────────────────────────────────────── -->
<nav id="nav" class="navbar shadow-sm navbar-expand-562 fixed-top dark navbar-fixed-top">
  <a id="brand" class="navbar-brand" href="/app/templates/main.html?db=">
    <img src="/i/lamp.png" width="30" loading="lazy"/>
  </a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul id="navbar-list" class="navbar-nav">
      <div id="navlist" class="hidden">
        <li class="nav-item"><a class="nav-link" id="list:id:" href="/app/templates/object.html?db=__DB__&amp;type=:href:">:name:</a></li>
      </div>
      <div id="extralist" class="hidden">
        <li id="dropdown-link" class="nav-item dropdown">
          <a class="nav-link dropdown-toggle expand-menu" role="button" data-toggle="dropdown">Еще</a>
          <div class="dropdown-menu" id="dropdown-list">
            <a class="dropdown-item" href="/app/templates/object.html?db=__DB__&amp;type=:href:">:name:</a>
          </div>
        </li>
      </div>
    </ul>
  </div>
  <div class="right-block" id="right_block">
    <div class="nav-item dropdown">
      <a class="user-link dropdown-toggle user-margin" href="#" role="button" data-toggle="dropdown">
        <svg height="30" viewBox="0 0 18 20" fill="white" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 19V17C17 15.9391 16.5786 14.9217 15.8284 14.1716C15.0783 13.4214 14.0609 13 13 13H5C3.93913 13 2.92172 13.4214 2.17157 14.1716C1.42143 14.9217 1 15.9391 1 17V19M13 5C13 7.20914 11.2091 9 9 9C6.79086 9 5 7.20914 5 5C5 2.79086 6.79086 1 9 1C11.2091 1 13 2.79086 13 5Z"
                stroke="#fafafa" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
      <div class="dropdown-menu dropdown-menu-right shadow">
        <a class="dropdown-item" onclick="doExit()"><t9n>[RU]Выход[EN]Exit</t9n></a>
      </div>
    </div>
  </div>
</nav>

<!-- ── Page content ───────────────────────────────────────────────────────── -->
<div class="content" style="padding-top:50px;">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb pl-2">
      <li class="breadcrumb-item"><a id="bc-home" href="/app/templates/main.html?db="></a></li>
      <li class="breadcrumb-item parent-table" style="display:none"><a id="bc-parent-table" href="#"></a></li>
      <li class="breadcrumb-item parent-object" style="display:none"><a id="bc-parent-obj" href="#"></a></li>
      <li class="breadcrumb-item active" id="bc-current" aria-current="page">…</li>
    </ol>
  </nav>

  <div class="alert alert-warning hidden" id="warn" role="alert" onclick="$(this).addClass('hidden')"></div>

  <!-- Controls toolbar -->
  <div id="controls" style="z-index:99;position:relative;" class="controls t9n">
    <div class="controls-left">
      <a class="create-btn" onclick="addRec()" title="<t9n>[RU]Добавить запись[EN]Create a record</t9n>">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M8 2C8.13261 2 8.25979 2.05268 8.35355 2.14645C8.44732 2.24021 8.5 2.36739 8.5 2.5V7.5H13.5C13.6326 7.5 13.7598 7.55268 13.8536 7.64645C13.9473 7.74021 14 7.86739 14 8C14 8.13261 13.9473 8.25979 13.8536 8.35355C13.7598 8.44732 13.6326 8.5 13.5 8.5H8.5V13.5C8.5 13.6326 8.44732 13.7598 8.35355 13.8536C8.25979 13.9473 8.13261 14 8 14C7.86739 14 7.74021 13.9473 7.64645 13.8536C7.55268 13.7598 7.5 13.6326 7.5 13.5V8.5H2.5C2.36739 8.5 2.24021 8.44732 2.14645 8.35355C2.05268 8.25979 2 8.13261 2 8C2 7.86739 2.05268 7.74021 2.14645 7.64645C2.24021 7.55268 2.36739 7.5 2.5 7.5H7.5V2.5C7.5 2.36739 7.55268 2.24021 7.64645 2.14645C7.74021 2.05268 7.86739 2 8 2Z" fill="#212529"/>
        </svg>
        <small class="tips-text"><font color="#1A1A1A"><t9n>[RU]Добавить[EN]Create</t9n></font></small>
      </a>
      <a onclick="toggleFilter()" title="<t9n>[RU]Показать / применить фильтры[EN]Show / apply filters</t9n>">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.4286 16.4286L13.3214 13.3214M15 9.2857C15 12.4416 12.4416 15 9.2857 15C6.12978 15 3.57141 12.4416 3.57141 9.2857C3.57141 6.12978 6.12978 3.57141 9.2857 3.57141C12.4416 3.57141 15 6.12978 15 9.2857Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <small class="tips-text"><font color="#1A1A1A"><t9n>[RU]Искать[EN]Search</t9n></font></small>
      </a>
      <a onclick="clearFilters()" id="clearSearch" style="display:none" title="<t9n>[RU]Очистить фильтр[EN]Clear filter</t9n>">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16.4286 16.4286L13.3214 13.3214M15 9.2857C15 12.4416 12.4416 15 9.2857 15C6.12978 15 3.57141 12.4416 3.57141 9.2857C3.57141 6.12978 6.12978 3.57141 9.2857 3.57141C12.4416 3.57141 15 6.12978 15 9.2857Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 7L12 12M12 7L7 12" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <small class="tips-text"><font color="#1A1A1A"><t9n>[RU]Очистить[EN]Clear</t9n></font></small>
      </a>
      <a onclick="sendForm()" title="<t9n>[RU]Обновить[EN]Refresh</t9n>">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9.00001 3.37664C7.25401 3.37664 5.69251 4.17201 4.66088 5.42188C4.61482 5.48159 4.55722 5.53143 4.49151 5.56843C4.42579 5.60543 4.35331 5.62883 4.27837 5.63726C4.20343 5.64569 4.12756 5.63896 4.05528 5.61747C3.98299 5.59599 3.91576 5.56019 3.85759 5.5122C3.79941 5.46421 3.75148 5.40502 3.71664 5.33813C3.68181 5.27125 3.66077 5.19805 3.6548 5.12287C3.64882 5.0477 3.65802 4.97209 3.68185 4.90054C3.70568 4.82899 3.74365 4.76296 3.79351 4.70638C4.61722 3.7091 5.71005 2.9694 6.94201 2.57525C8.17396 2.1811 9.49321 2.14909 10.7428 2.48304C11.9925 2.81698 13.1199 3.50282 13.991 4.45898C14.8621 5.41515 15.4402 6.60139 15.6566 7.87663H14.5125C14.2528 6.60629 13.5623 5.46463 12.5579 4.64467C11.5534 3.82472 10.2966 3.37679 9.00001 3.37664Z" fill="#212529"/>
        </svg>
        <small class="tips-text"><font color="#1A1A1A"><t9n>[RU]Обновить[EN]Refresh</t9n></font></small>
      </a>
    </div>
  </div>

  <!-- Hidden form fields (filter state) -->
  <form id="obj-form" style="display:none">
    <input type="hidden" id="sort-col" name="sort_col" value="">
    <input type="hidden" id="sort-dir" name="sort_dir" value="">
    <input type="hidden" id="page-num" name="page_num" value="0">
    <input type="hidden" id="lnx-val" name="lnx" value="">
    <input type="hidden" id="full-val" name="full" value="">
  </form>

  <!-- Table -->
  <div id="loading"><img src="/i/ajax.gif" alt="loading"><br><small>Загрузка…</small></div>
  <div id="tb-wrap" style="overflow-x:auto;">
    <table id="tb" class="table table-bordered table-sm" style="font-size:13px;">
      <thead id="tb-head"></thead>
      <tbody id="tb-body"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-wrap" id="pagination"></div>

</div><!-- /content -->

<script src="/js/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="/js/select2.min.js"></script>
<!-- Replace __DB__ BEFORE main.js captures the navlist template -->
<script>
document.getElementById('brand').href = '/app/templates/main.html?db=' + encodeURIComponent(db);
document.getElementById('navlist').innerHTML =
  document.getElementById('navlist').innerHTML.replace(/__DB__/g, encodeURIComponent(db));
document.getElementById('extralist').innerHTML =
  document.getElementById('extralist').innerHTML.replace(/__DB__/g, encodeURIComponent(db));
</script>
<script src="/js/main.js"></script>
<script>
localize();

// ── State ────────────────────────────────────────────────────────────────────
var typeInfo   = null;   // from GET /:db/_dict/:type?JSON
var filterVals = {};     // col_id → {from, to}
var sortCol    = '';
var sortDir    = '';
var pageNum    = 0;
var PAGE_SIZE  = 50;
var filterVisible = false;

// ── Navbar / breadcrumb ───────────────────────────────────────────────────────
document.getElementById('bc-home').href = '/app/templates/main.html?db=' + encodeURIComponent(db);
document.getElementById('bc-home').textContent = db.charAt(0).toUpperCase() + db.slice(1);

// Load menu for navbar
fetch('/' + db + '/terms?JSON', { credentials: 'include' })
  .then(function(r){ return r.json(); })
  .then(function(terms) {
    menu = terms.map(function(t){ return { href: t.id, name: t.name }; });
    if (typeof resizeMutations === 'function') resizeMutations();
  });

// ── Align helper ─────────────────────────────────────────────────────────────
function getAlign(typeCode) {
  switch (String(typeCode)) {
    case '13': case '14': return 'right';
    case '11': case '20': case '9': return 'center';
  }
  return 'left';
}

// ── Init ──────────────────────────────────────────────────────────────────────
function init() {
  if (!id) {
    document.getElementById('tb-body').innerHTML = '<tr><td colspan="10" class="text-center text-muted">Укажите тип в URL (?type=...)</td></tr>';
    return;
  }
  // Fetch type metadata (dict)
  fetch('/' + db + '/_dict/' + id + '?JSON', { credentials: 'include' })
    .then(function(r){ return r.json(); })
    .then(function(dict) {
      typeInfo = dict;
      document.title = dict.name || 'Integram';
      document.getElementById('bc-current').textContent = dict.name || String(id);

      // Parent breadcrumb
      if (F_U) {
        var pbObj = document.getElementById('bc-parent-obj');
        pbObj.textContent = 'Объект #' + F_U;
        pbObj.href = '/app/templates/edit_obj.html?db=' + encodeURIComponent(db) + '&id=' + F_U;
        pbObj.closest('li').style.display = '';
      }

      renderHead(dict.requisites || []);
      loadData();
    })
    .catch(function(e){
      showWarn('Ошибка загрузки структуры: ' + e.message);
    });
}

// ── Render table head ─────────────────────────────────────────────────────────
function renderHead(reqs) {
  var html = '<tr>';
  // Edit button column
  html += '<th style="width:30px;"></th>';
  // Name column
  html += '<th style="cursor:pointer;" data-col="0" onclick="sortBy(0)">' +
          '<t9n>[RU]Наименование[EN]Name</t9n>' + sortIndicator(0) + '</th>';
  // Requisites
  reqs.forEach(function(r) {
    html += '<th style="cursor:pointer;" data-col="' + r.id + '" onclick="sortBy(' + r.id + ')">' +
            escHtml(r.name) + sortIndicator(r.id) + '</th>';
  });
  html += '</tr>';

  // Filter row
  var fhtml = '<tr class="filter-row" id="filter_row">';
  fhtml += '<td></td>';
  fhtml += '<td style="padding:1px;"><input type="text" placeholder="..." oninput="filterInput(0,this.value)" value="' +
           escHtml(filterVals[0] || '') + '"></td>';
  reqs.forEach(function(r) {
    fhtml += '<td style="padding:1px;"><input type="text" placeholder="..." oninput="filterInput(' + r.id + ',this.value)" value="' +
             escHtml(filterVals[r.id] || '') + '"></td>';
  });
  fhtml += '</tr>';

  document.getElementById('tb-head').innerHTML = html + fhtml;

  if (filterVisible) {
    document.querySelectorAll('.filter-row').forEach(function(el){ el.style.display = ''; });
  }
}

// ── Sort indicator ────────────────────────────────────────────────────────────
function sortIndicator(col) {
  if (String(col) !== String(sortCol)) return '';
  return sortDir === 'desc' ? ' ▼' : ' ▲';
}

function sortBy(col) {
  if (String(col) === String(sortCol)) {
    sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
  } else {
    sortCol = col;
    sortDir = 'asc';
  }
  pageNum = 0;
  renderHead(typeInfo ? (typeInfo.requisites || []) : []);
  loadData();
}

// ── Filter ────────────────────────────────────────────────────────────────────
var filterTimer = null;
function filterInput(col, val) {
  filterVals[col] = val;
  clearTimeout(filterTimer);
  filterTimer = setTimeout(function(){ pageNum = 0; loadData(); }, 400);
}

function toggleFilter() {
  filterVisible = !filterVisible;
  document.querySelectorAll('.filter-row').forEach(function(el){
    el.style.display = filterVisible ? '' : 'none';
  });
  document.getElementById('clearSearch').style.display = filterVisible ? '' : 'none';
}

function clearFilters() {
  filterVals = {};
  filterVisible = false;
  document.querySelectorAll('.filter-row input').forEach(function(el){ el.value = ''; });
  document.querySelectorAll('.filter-row').forEach(function(el){ el.style.display = 'none'; });
  document.getElementById('clearSearch').style.display = 'none';
  pageNum = 0;
  loadData();
}

// ── sendForm (legacy compat) ──────────────────────────────────────────────────
function sendForm() { loadData(); }

// ── Load data ─────────────────────────────────────────────────────────────────
function loadData() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('tb-wrap').style.opacity = '0.4';

  var url = '/' + db + '/_list/' + id + '?JSON&up=' + F_U +
            '&limit=' + PAGE_SIZE + '&offset=' + (pageNum * PAGE_SIZE);

  // Sort
  if (sortCol !== '') url += '&sort=' + sortCol + '&dir=' + (sortDir || 'asc');

  // Filters
  Object.keys(filterVals).forEach(function(k) {
    if (filterVals[k]) url += '&f_' + k + '=' + encodeURIComponent(filterVals[k]);
  });

  fetch(url, { credentials: 'include' })
    .then(function(r){ return r.json(); })
    .then(function(res) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('tb-wrap').style.opacity = '1';

      var rows = res.data || res;
      var total = res.total || rows.length;
      renderRows(rows);
      renderPagination(total);
    })
    .catch(function(e) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('tb-wrap').style.opacity = '1';
      showWarn('Ошибка загрузки данных: ' + e.message);
    });
}

// ── Render rows ───────────────────────────────────────────────────────────────
function renderRows(rows) {
  var reqs = typeInfo ? (typeInfo.requisites || []) : [];
  var html = '';

  if (!rows || rows.length === 0) {
    var colspan = reqs.length + 2;
    html = '<tr><td colspan="' + colspan + '" class="text-center text-muted py-3">Нет данных</td></tr>';
  } else {
    rows.forEach(function(row) {
      var editUrl = '/app/templates/edit_obj.html?db=' + encodeURIComponent(db) + '&id=' + row.id +
                   '&type=' + id + '&up=' + F_U;
      var childUrl = '/app/templates/object.html?db=' + encodeURIComponent(db) +
                     '&type=' + id + '&up=' + row.id;
      html += '<tr>';
      // Edit/view button
      html += '<td style="padding:1px 3px;white-space:nowrap;">' +
              '<a href="' + editUrl + '" class="i-edit" title="Редактировать">' +
              '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
              '<path d="M11.013 1.427a1.75 1.75 0 012.474 2.474L5.91 11.479l-2.396.296.296-2.396 7.203-7.952z" fill="#555"/>' +
              '</svg></a></td>';
      // Name cell
      html += '<td class="fixed-td ms-link" style="text-align:left;">' +
              '<a href="' + childUrl + '" class="ms-link">' + escHtml(row.val || '') + '</a></td>';
      // Requisite cells
      reqs.forEach(function(r) {
        var val = '';
        if (row.reqs && row.reqs[r.id] !== undefined) {
          val = row.reqs[r.id];
        } else if (row.ord && row.ord[r.id] !== undefined) {
          val = row.ord[r.id];
        }
        var align = getAlign(r.type);
        html += '<td class="fixed-td" style="text-align:' + align + ';">' + escHtml(String(val || '')) + '</td>';
      });
      html += '</tr>';
    });
  }

  document.getElementById('tb-body').innerHTML = html;
}

// ── Pagination ────────────────────────────────────────────────────────────────
function renderPagination(total) {
  var totalPages = Math.ceil(total / PAGE_SIZE);
  var html = '';
  if (totalPages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }

  html += '<small class="text-muted">Стр. ' + (pageNum + 1) + ' из ' + totalPages + ' (всего ' + total + ')</small>';
  if (pageNum > 0) {
    html += '<button class="btn btn-sm btn-outline-secondary" onclick="gotoPage(' + (pageNum - 1) + ')">‹ Назад</button>';
  }
  if (pageNum < totalPages - 1) {
    html += '<button class="btn btn-sm btn-outline-secondary" onclick="gotoPage(' + (pageNum + 1) + ')">Вперёд ›</button>';
  }
  document.getElementById('pagination').innerHTML = html;
}

function gotoPage(n) { pageNum = n; loadData(); }

// ── Add record ────────────────────────────────────────────────────────────────
function addRec() {
  location.href = '/app/templates/edit_obj.html?db=' + encodeURIComponent(db) +
                  '&type=' + id + '&up=' + F_U + '&new=1';
}

// ── Warn ──────────────────────────────────────────────────────────────────────
function showWarn(msg) {
  var el = document.getElementById('warn');
  el.textContent = msg;
  el.classList.remove('hidden');
}

// ── Escape HTML ───────────────────────────────────────────────────────────────
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Exit ──────────────────────────────────────────────────────────────────────
function doExit() {
  localStorage.removeItem(db + '_xsrf');
  localStorage.removeItem(db + '_token');
  localStorage.removeItem(db + '_userId');
  document.cookie = encodeURIComponent(db) + '=; path=/; max-age=0';
  location.href = '/app/templates/login.html?db=' + encodeURIComponent(db);
}

// ── Start ─────────────────────────────────────────────────────────────────────
init();
</script>
</body>
</html>
