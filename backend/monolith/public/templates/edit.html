<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Object</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>body { padding: 1rem; background: #f8f9fa; }</style>
</head>
<body>

<div class="d-flex align-items-center mb-3 gap-2">
  <h5 class="mb-0" id="pageTitle">Edit Object</h5>
  <button class="btn btn-sm btn-secondary ms-auto" id="btnBack">← Back</button>
</div>

<div id="alertBox" class="alert d-none" role="alert"></div>

<form id="editForm" class="bg-white p-3 rounded border">
  <div id="fields"></div>
  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Save</button>
    <button type="button" class="btn btn-danger" id="btnDel">Delete</button>
  </div>
</form>

<script>
// ── API helpers ───────────────────────────────────────────────────────────────
const params  = new URLSearchParams(location.search);
const db      = params.get('db') || '';
const objId   = params.get('id') || '';
const typeId  = params.get('type') || '';
const upId    = params.get('up') || '0';
const isNew   = params.get('new') === '1';

function getSession() {
  return {
    token: localStorage.getItem(`${db}_token`) || '',
    xsrf:  localStorage.getItem(`${db}_xsrf`)  || '',
  };
}
function redirectLogin() {
  top.location.href = `login.html?db=${encodeURIComponent(db)}`;
}
async function api(method, path, body) {
  const opts = { method, credentials: 'include', headers: {} };
  if (body) {
    opts.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    opts.body = new URLSearchParams(body).toString();
  }
  const res = await fetch(path, opts);
  if (res.status === 401) { redirectLogin(); return null; }
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { error: text }; }
}
function showAlert(msg, type = 'danger') {
  const box = document.getElementById('alertBox');
  box.className = `alert alert-${type}`;
  box.textContent = msg;
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Build form ────────────────────────────────────────────────────────────────
let requisites = [];
let currentValues = {};

async function loadForm() {
  const metaData = await api('GET', `/${db}/metadata/${typeId}?JSON`);
  if (!metaData) return;
  requisites = Array.isArray(metaData) ? metaData : (metaData.reqs || metaData.fields || metaData.data || []);

  if (!isNew && objId) {
    const listData = await api('GET', `/${db}/_list/${typeId}?JSON&up=${upId}`);
    if (listData) {
      const rows = Array.isArray(listData) ? listData : (listData.data || listData.rows || []);
      const row = rows.find(r => String(r.id) === String(objId));
      if (row) currentValues = row;
    }
  }

  renderFields();
}

function renderFields() {
  const container = document.getElementById('fields');
  container.innerHTML = '';
  if (requisites.length === 0) {
    container.innerHTML = '<p class="text-muted">No fields defined for this type.</p>';
    return;
  }
  requisites.forEach(req => {
    const alias = req.alias || req.id;
    const label = req.name || req.val || alias;
    const value = currentValues[alias] ?? currentValues[req.id] ?? '';
    const inputType = guessInputType(req);

    const div = document.createElement('div');
    div.className = 'mb-3';
    if (inputType === 'textarea') {
      div.innerHTML = `
        <label class="form-label">${escHtml(label)}</label>
        <textarea class="form-control" name="${escHtml(alias)}" rows="3">${escHtml(value)}</textarea>`;
    } else if (inputType === 'select') {
      div.innerHTML = `
        <label class="form-label">${escHtml(label)}</label>
        <select class="form-select" name="${escHtml(alias)}">
          <option value="">— select —</option>
        </select>`;
      loadRefOptions(div.querySelector('select'), req, value);
    } else {
      div.innerHTML = `
        <label class="form-label">${escHtml(label)}</label>
        <input type="${inputType}" class="form-control" name="${escHtml(alias)}" value="${escHtml(value)}">`;
    }
    container.appendChild(div);
  });
}

function guessInputType(req) {
  const t = (req.type_name || req.type || '').toLowerCase();
  if (t === 'date' || t === 'datetime') return 'date';
  if (t === 'ref' || t === 'reference' || req.ref) return 'select';
  if (t === 'text' || t === 'memo') return 'textarea';
  return 'text';
}

async function loadRefOptions(select, req, currentVal) {
  const refType = req.ref || req.ref_type || req.ref_id;
  if (!refType) return;
  const data = await api('GET', `/${db}/_list/${refType}?JSON&up=0`);
  if (!data) return;
  const rows = Array.isArray(data) ? data : (data.data || data.rows || []);
  rows.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.name || r.val || r.id;
    if (String(r.id) === String(currentVal)) opt.selected = true;
    select.appendChild(opt);
  });
}

// ── Save ──────────────────────────────────────────────────────────────────────
document.getElementById('editForm').addEventListener('submit', async e => {
  e.preventDefault();
  const sess = getSession();
  const formData = new FormData(e.target);
  const body = { _xsrf: sess.xsrf };
  formData.forEach((v, k) => body[k] = v);

  let data;
  if (isNew) {
    data = await api('POST', `/${db}/_m_new/${upId}?JSON`, body);
  } else {
    data = await api('POST', `/${db}/_m_save/${objId}?JSON`, body);
  }
  if (!data) return;
  if (data.error) return showAlert(data.error);
  showAlert('Saved!', 'success');
  setTimeout(() => {
    top.document.getElementById('frame').src =
      `object.html?db=${encodeURIComponent(db)}&type=${typeId}&up=${upId}`;
  }, 800);
});

// ── Delete ────────────────────────────────────────────────────────────────────
document.getElementById('btnDel').addEventListener('click', async () => {
  if (!objId || isNew) return;
  if (!confirm('Delete this record?')) return;
  const sess = getSession();
  const data = await api('POST', `/${db}/_m_del/${objId}?JSON`, { _xsrf: sess.xsrf });
  if (!data) return;
  if (data.error) return showAlert(data.error);
  top.document.getElementById('frame').src =
    `object.html?db=${encodeURIComponent(db)}&type=${typeId}&up=${upId}`;
});

// ── Back ──────────────────────────────────────────────────────────────────────
document.getElementById('btnBack').addEventListener('click', () => {
  top.document.getElementById('frame').src =
    `object.html?db=${encodeURIComponent(db)}&type=${typeId}&up=${upId}`;
});

document.getElementById('pageTitle').textContent = isNew ? 'New Object' : `Edit Object #${objId}`;
if (isNew) document.getElementById('btnDel').classList.add('d-none');

// ── Init ─────────────────────────────────────────────────────────────────────
if (!getSession().token) redirectLogin();
loadForm();
</script>
</body>
</html>
