# Integram API - Полная документация эндпоинтов

Полная документация по всем API эндпоинтам системы Integram Standalone, включая совместимость с legacy PHP backend.

## Содержание

1. [Обзор](#обзор)
2. [Аутентификация](#аутентификация)
3. [Работа с данными (DML)](#работа-с-данными-dml)
4. [Работа с метаданными (DDL)](#работа-с-метаданными-ddl)
5. [Служебные эндпоинты](#служебные-эндпоинты)
6. [Node.js Backend API](#nodejs-backend-api)
7. [Формат данных](#формат-данных)

---

## Обзор

### URL формат

**PHP Backend (Legacy):**
```
https://интеграм.рф/{database}/{action}?{params}
```

**Node.js Backend:**
```
http://localhost:8081/api/{database}/{action}
```

### Параметры запросов

| Параметр | Описание | Значения |
|----------|----------|----------|
| `JSON` | Возвращать JSON | присутствие параметра |
| `JSON_KV` | JSON с key-value форматом | присутствие параметра |
| `JSON_DATA` | JSON только данные | присутствие параметра |
| `JSON_CR` | JSON с CR-форматом | присутствие параметра |
| `JSON_HR` | JSON human-readable | присутствие параметра |

---

## Аутентификация

### `POST /{db}/auth` — Авторизация пользователя

Основной эндпоинт для входа в систему.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `login` / `user` / `u` | string | Да | Имя пользователя или email |
| `pwd` / `password` / `p` | string | Да | Пароль |
| `tzone` | int | Нет | Смещение часового пояса |
| `save` | bool | Нет | Сохранить cookie надолго |
| `uri` | string | Нет | URL для редиректа после входа |

**Пример запроса:**
```bash
curl -X POST "https://example.com/my/auth?JSON_KV" \
  -d "login=myuser&pwd=mypassword"
```

**Успешный ответ:**
```json
{
  "_xsrf": "abc123def456789012345",
  "token": "a1b2c3d4e5f6g7h8i9j0k1",
  "id": 12345,
  "msg": ""
}
```

**Ошибка:**
```json
[{"error": "Неверный логин или пароль"}]
```

---

### `POST /{db}/jwt` — JWT авторизация

Авторизация через JSON Web Token.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `jwt` | string | Да | JWT токен |

**Ответ:**
```json
{
  "token": "...",
  "_xsrf": "...",
  "id": 12345
}
```

---

### `POST /{db}/getcode` — Запрос одноразового кода

Отправляет одноразовый код на email пользователя.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `u` / `email` | string | Да | Email пользователя |

**Ответ (пользователь существует):**
```json
{"msg": "ok"}
```

**Ответ (новый пользователь):**
```json
{"msg": "new"}
```

**Ошибка:**
```json
{"error": "invalid user"}
```

---

### `POST /{db}/checkcode` — Проверка одноразового кода

Проверяет введённый код и выдаёт токен.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `u` / `email` | string | Да | Email пользователя |
| `c` / `code` | string | Да | 4-значный код |

**Успешный ответ:**
```json
{
  "token": "a1b2c3d4e5f6g7h8i9j0k1",
  "_xsrf": "abc123def456789012345"
}
```

**Ошибка:**
```json
{"error": "user not found"}
```

---

### `POST /{db}/confirm` — Подтверждение пароля

Подтверждает сброс пароля.

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `u` | string | Да | Имя пользователя |
| `o` | string | Да | Старый хэш пароля |
| `p` | string | Да | Новый хэш пароля |

---

### `GET /{db}/exit` — Выход из системы

Завершает сессию и удаляет cookie.

**Пример:**
```bash
curl "https://example.com/my/exit"
```

---

## Работа с данными (DML)

Все DML-действия начинаются с префикса `_m_` и требуют авторизации.

### Заголовки авторизации

| Заголовок | Описание |
|-----------|----------|
| `X-Authorization` или `Authorization` | Токен авторизации |
| `X-Xsrf-Token` | XSRF токен (защита от CSRF) |

---

### `POST /{db}/_m_new/{up}` — Создание объекта

Создаёт новый объект.

**Параметры URL:**
- `{up}` — ID родительского объекта

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `t` | int | ID типа объекта |
| `val` | string | Значение объекта |
| `t{N}` | string | Значение реквизита N |

**Пример:**
```bash
curl -X POST "https://example.com/my/_m_new/1?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -d "t=18&val=Новый клиент&t33=Иван Иванов&t41=client@example.com"
```

**Ответ:**
```json
{
  "id": 12345,
  "up": 1,
  "t": 18,
  "val": "Новый клиент"
}
```

---

### `POST /{db}/_m_save/{id}` — Сохранение объекта

Обновляет существующий объект.

**Параметры URL:**
- `{id}` — ID объекта для обновления

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `t{N}` | string | Значение реквизита N |
| `val` | string | Новое значение объекта |

**Пример:**
```bash
curl -X POST "https://example.com/my/_m_save/12345?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -d "t33=Пётр Петров&t41=new@example.com"
```

---

### `POST /{db}/_m_del/{id}` — Удаление объекта

Удаляет объект и все его дочерние элементы.

**Параметры URL:**
- `{id}` — ID объекта для удаления

**Пример:**
```bash
curl -X POST "https://example.com/my/_m_del/12345?JSON_KV" \
  -H "X-Authorization: $TOKEN"
```

---

### `POST /{db}/_m_set/{id}` — Установка значения атрибута

Устанавливает значение конкретного атрибута объекта.

**Параметры URL:**
- `{id}` — ID объекта

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `t{N}` | string | Значение реквизита N |

**Пример:**
```bash
curl -X POST "https://example.com/my/_m_set/12345?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -d "t33=Новое имя"
```

---

### `POST /{db}/_m_move/{id}` — Перемещение объекта

Перемещает объект к новому родителю.

**Параметры URL:**
- `{id}` — ID объекта для перемещения

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `up` | int | ID нового родителя |

---

### `POST /{db}/_m_up/{id}` — Перемещение объекта вверх

Перемещает объект на одну позицию вверх в списке.

---

### `POST /{db}/_m_ord/{id}` — Установка порядка объекта

Устанавливает порядковый номер объекта.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `order` | int | Новый порядковый номер |

---

### `POST /{db}/_m_id/{id}` — Изменение ID объекта

Изменяет ID объекта (требуются права администратора).

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `new_id` | int | Новый ID |

---

## Работа с метаданными (DDL)

Все DDL-действия начинаются с префикса `_d_` и требуют прав на редактирование типов.

---

### `POST /{db}/_d_new` / `_terms` — Создание нового типа

Создаёт новый тип (таблицу).

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `val` | string | Название типа |
| `up` | int | ID родительского типа (0 для корня) |
| `t` | int | ID базового типа |

---

### `POST /{db}/_d_save` / `_patchterm` — Обновление типа

Обновляет название и свойства типа.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID типа |
| `val` | string | Новое название |

---

### `POST /{db}/_d_alias` / `_setalias` — Установка алиаса

Устанавливает алиас (псевдоним) для типа.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID типа |
| `alias` | string | Алиас (формат: `:ALIAS=название:`) |

---

### `POST /{db}/_d_del` / `_deleteterm` — Удаление типа

Удаляет тип и все его реквизиты.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID типа для удаления |

---

### `POST /{db}/_d_req` / `_attributes` — Добавление реквизита

Добавляет новый реквизит (атрибут) к типу.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `up` | int | ID типа-родителя |
| `t` | int | ID типа реквизита (базовый тип или ссылка) |
| `val` | string | Название реквизита |

---

### `POST /{db}/_d_del_req` / `_deletereq` — Удаление реквизита

Удаляет реквизит из типа.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |

---

### `POST /{db}/_d_ref` / `_references` — Создание ссылочного типа

Создаёт реквизит-ссылку на другой тип.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `up` | int | ID родительского типа |
| `t` | int | ID целевого типа ссылки |
| `val` | string | Название реквизита |

---

### `POST /{db}/_d_null` / `_setnull` — Переключение NOT NULL

Переключает флаг обязательности реквизита.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |

---

### `POST /{db}/_d_multi` / `_setmulti` — Переключение множественного выбора

Переключает возможность множественного выбора для реквизита-ссылки.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |

---

### `POST /{db}/_d_attrs` / `_modifiers` — Установка модификаторов

Устанавливает модификаторы для реквизита (NOT NULL, MULTI и т.д.).

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |
| `attrs` | string | Строка модификаторов |

---

### `POST /{db}/_d_up` / `_moveup` — Перемещение реквизита вверх

Перемещает реквизит на одну позицию вверх.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |

---

### `POST /{db}/_d_ord` / `_setorder` — Установка порядка реквизита

Устанавливает порядковый номер реквизита.

**POST параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID реквизита |
| `order` | int | Новый порядок |

---

## Служебные эндпоинты

### `GET /{db}/_dict` — Справочник типов

Возвращает список всех типов базы данных.

**Пример:**
```bash
curl "https://example.com/my/_dict?JSON_KV" \
  -H "X-Authorization: $TOKEN"
```

**Ответ:**
```json
{
  "types": [
    {"id": 18, "val": "Пользователь", "alias": "user"},
    {"id": 100, "val": "Клиент", "alias": "client"}
  ]
}
```

---

### `GET /{db}/_d_main` — Метаданные типа

Возвращает структуру типа (реквизиты).

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `typeId` / `t` | int | ID типа |

**Ответ:**
```json
{
  "type": {
    "id": 18,
    "val": "Пользователь",
    "alias": "user"
  },
  "requisites": [
    {"id": 33, "val": "Имя", "t": 8, "baseType": "CHARS"},
    {"id": 41, "val": "Email", "t": 8, "baseType": "CHARS"}
  ]
}
```

---

### `GET /{db}/_list` — Список объектов

Возвращает список объектов типа.

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `typeId` / `t` | int | ID типа |
| `offset` | int | Смещение (по умолчанию 0) |
| `limit` | int | Лимит записей (по умолчанию 20) |
| `F_{req_id}` | string | Фильтр по реквизиту |

**Ответ:**
```json
{
  "objects": [
    {"id": 123, "val": "Иванов", "33": "Иван", "41": "ivan@example.com"},
    {"id": 124, "val": "Петров", "33": "Пётр", "41": "petr@example.com"}
  ],
  "total": 150
}
```

---

### `GET /{db}/_ref_reqs` — Данные для выпадающих списков

Возвращает данные для заполнения выпадающих списков (справочники).

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `t` | int | ID типа ссылки |
| `limit` | int | Максимум записей |

---

### `GET /{db}/terms` — Получение типов (API v2)

Возвращает список типов в формате JSON.

---

### `GET /{db}/metadata` — Метаданные (API v2)

Возвращает метаданные базы данных.

---

### `GET /{db}/obj_meta` — Метаданные объекта

Возвращает метаданные конкретного объекта.

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `id` | int | ID объекта |

---

### `GET /{db}/xsrf` — Получение XSRF токена

Возвращает текущий XSRF токен для сессии.

**Ответ:**
```json
{"xsrf": "abc123def456789012345"}
```

---

### `POST /{db}/_connect` — Проверка соединения

Проверяет соединение с базой данных.

---

### `POST /{db}/_new_db` — Создание новой базы данных

Создаёт новую базу данных (только для администраторов).

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `name` | string | Имя новой базы (2-15 символов) |
| `template` | string | Шаблон: `ru`, `en` |

---

## Node.js Backend API

### Health Check

**`GET /health`** или **`GET /api/health`**

```json
{
  "status": "ok",
  "service": "integram-standalone-backend",
  "version": "1.0.0",
  "database": "connected",
  "timestamp": "2026-02-18T12:00:00Z"
}
```

### API Info

**`GET /api/info`**

```json
{
  "name": "Integram Standalone Backend",
  "version": "1.0.0",
  "node": "v20.x.x",
  "uptime": 3600,
  "database": "connected"
}
```

### Validate Token

**`POST /api/{db}/validate`**

Проверяет валидность токена.

**Параметры:**

| Параметр | Тип | Описание |
|----------|-----|----------|
| `token` | string | Токен для проверки |

**Ответ:**
```json
{
  "success": true,
  "valid": true,
  "id": 12345,
  "user": "myuser",
  "xsrf": "...",
  "role": "Администратор"
}
```

---

## Формат данных

### Базовые типы данных

| ID | Тип | Описание | Формат значения |
|----|-----|----------|-----------------|
| 3 | SHORT | Короткий текст | До 127 символов |
| 8 | CHARS | Длинный текст | До 10000 символов |
| 9 | DATE | Дата | YYYYMMDD |
| 13 | NUMBER | Целое число | Без дробной части |
| 14 | SIGNED | Дробное число | С дробной частью |
| 11 | BOOLEAN | Логическое | `1` или пусто |
| 12 | MEMO | Многострочный текст | Без ограничения |
| 4 | DATETIME | Дата и время | Unix timestamp |
| 10 | FILE | Файл | `id:filename.ext` |
| 6 | PWD | Пароль | SHA1 хэш |
| 2 | HTML | HTML текст | HTML разметка |
| 7 | BUTTON | Кнопка | JavaScript код |
| 5 | GRANT | Права доступа | ID объекта |

### Структура таблицы

Каждая база данных Integram представлена одной таблицей с EAV-структурой:

| Колонка | Тип | Описание |
|---------|-----|----------|
| `id` | INT (PK) | Уникальный идентификатор |
| `up` | INT | ID родителя (0 = корень/тип) |
| `ord` | INT | Порядок в родителе |
| `t` | INT | ID типа |
| `val` | VARCHAR(10000) | Значение |

### Специальные префиксы фильтров

| Префикс | Описание | Пример |
|---------|----------|--------|
| `!` | NOT (отрицание) | `!value` |
| `%` | LIKE (содержит) | `%value%` |
| `@` | По ID | `@12345` |
| `>` | Больше | `>100` |
| `<` | Меньше | `<100` |
| `>=` | Больше или равно | `>=100` |
| `<=` | Меньше или равно | `<=100` |
| `IN()` | Список значений | `IN('a','b','c')` |
| `@IN()` | Список ID | `@IN(1,2,3)` |

---

## Коды ошибок

| Код | HTTP статус | Описание |
|-----|-------------|----------|
| `MISSING_CREDENTIALS` | 400 | Не указан логин или пароль |
| `INVALID_CREDENTIALS` | 401 | Неверный логин или пароль |
| `UNAUTHORIZED` | 401 | Нет токена авторизации |
| `NOT_FOUND` | 404 | Объект не найден |
| `FORBIDDEN` | 403 | Нет доступа |
| `AUTH_ERROR` | 500 | Ошибка аутентификации |

---

## Примеры использования

### Полный цикл работы с API

```bash
# 1. Авторизация
TOKEN=$(curl -s -X POST "https://example.com/my/auth?JSON_KV" \
  -d "login=myuser&pwd=mypassword" | jq -r '.token')

XSRF=$(curl -s -X POST "https://example.com/my/auth?JSON_KV" \
  -d "login=myuser&pwd=mypassword" | jq -r '._xsrf')

# 2. Получить справочник типов
curl "https://example.com/my/_dict?JSON_KV" \
  -H "X-Authorization: $TOKEN"

# 3. Получить список клиентов (тип 100)
curl "https://example.com/my/_list?typeId=100&JSON_KV" \
  -H "X-Authorization: $TOKEN"

# 4. Создать нового клиента
curl -X POST "https://example.com/my/_m_new/1?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -H "X-Xsrf-Token: $XSRF" \
  -d "t=100&val=Новый клиент&t33=Название компании"

# 5. Обновить клиента
curl -X POST "https://example.com/my/_m_save/12345?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -H "X-Xsrf-Token: $XSRF" \
  -d "t33=Обновлённое название"

# 6. Удалить клиента
curl -X POST "https://example.com/my/_m_del/12345?JSON_KV" \
  -H "X-Authorization: $TOKEN" \
  -H "X-Xsrf-Token: $XSRF"
```

---

**Версия документации:** 1.1.0
**Дата обновления:** 2026-02-18
**Статус:** Production
